var MCK_GROUP_MAP=[],MCK_CLIENT_GROUP_MAP=[];!function(e,t,a){"use strict";function s(s){function n(){var s,o,i=this,n=!1,r=e("#mck-file-menu"),c=e("#mck-message-cell .mck-message-inner"),l=(e("#mck-tab-individual"),w),d="/v2/tab/initialize.page";i.getLauncherHtml=function(){return'<div id="mck-sidebox-launcher" class="mck-sidebox-launcher"><a href="#" class="applozic-launcher mck-button-launcher" '+("support"===B?je:"")+'><span class="mck-icon-chat"></span></a></div><div id="mck-msg-preview" class="mck-msg-preview applozic-launcher"><div class="mck-row"><div class="blk-lg-3 mck-preview-icon"></div><div class="blk-lg-9"><div class="mck-row mck-truncate mck-preview-content"><strong class="mck-preview-cont-name"></strong></div><div class="mck-row mck-preview-content"><div class="mck-preview-msg-content"></div><div class="mck-preview-file-content mck-msg-text notranslate blk-lg-12 mck-attachment n-vis"></div></div></div></div><div id="mck-msg-preview-btns" class="n-vis"><button id="mck-vid-call-accept">Accept</button><button id="mck-vid-call-reject">reject</reject></div></div>'},i.initializeApp=function(a,s){n=s;var o={applicationId:a.appId,userId:Ge};null!==Q&&(o.displayName=a.userName),null!==a.email&&(o.email=a.email),null!==me&&(o.contactNumber=a.contactNumber),a.imageLink&&(o.imageLink=a.imageLink),a.appModuleName&&(o.appModuleName=a.appModuleName),re&&(o.password=a.accessToken),-1===oe.indexOf(Me)&&(Me=0),Re&&(o.resetUserStatus=!0),"number"==typeof We&&(o.userTypeId=We),o.enableEncryption=!0,o.appVersionCode=108,o.authenticationTypeId=Me,h="",I="",i.validateAppSession(o)?ee&&kt.InitilizeVideoClient(Ge,I):e.ajax({url:MCK_BASE_URL+d,type:"post",data:t.JSON.stringify(o),contentType:"application/json",headers:{"Application-Key":F},success:function(e){ee&&kt.InitilizeVideoClient(e.userId,e.deviceKey),Qe.clearMckMessageArray(),Qe.clearMckContactNameArray(),"INVALID_PASSWORD"!==e?"INVALID_APPID"!==e?"error"!==e&&"USER_NOT_FOUND"!==e?"APPMODULE_NOT_FOUND"!==e?"object"==typeof e&&null!==e&&e.token?(e.appId=o.applicationId,re&&(e.accessToken=o.password),i.onInitApp(e)):"function"==typeof ae&&ae({status:"error",errorMessage:"UNABLE TO PROCESS REQUEST"}):"function"==typeof ae&&ae({status:"error",errorMessage:"APPMODULE NOT FOUND"}):"function"==typeof ae&&ae({status:"error",errorMessage:"USER NOT FOUND"}):"function"==typeof ae&&ae({status:"error",errorMessage:"INVALID APPLICATION ID"}):"function"==typeof ae&&ae({status:"error",errorMessage:"INVALID PASSWORD"})},error:function(){Qe.clearMckMessageArray(),"function"==typeof ae&&ae({status:"error",errorMessage:"UNABLE TO PROCESS REQUEST"})}})},i.onInitApp=function(a){if(i.appendLauncher(),i.setLabels(),e(".applozic-launcher").each(function(){e(this).hasClass("mck-msg-preview")||e(this).show()}),b=a.token,mckUtils.setEncryptionKey(a.encryptionKey),Ge=a.userId,M=a.countryCode,I=a.deviceKey,S=a.websocketUrl,w=a.websocketIdleTimeLimit,E=a.timeZoneOffset,te=a.fileBaseUrl,W=a.deactivated,h=btoa(a.userId+":"+a.deviceKey),R=a.totalUnreadCount,q=a.connectedClientCount,Z||"guest"===Ge||"0"===Ge||"C0"===Ge||(n?ht.reconnect():ht.init()),pt.createContactWithDetail({userId:Ge,displayName:a.displayName,photoLink:a.imageLink}),e.ajaxPrefilter(function(e){e.beforeSend||-1===e.url.indexOf(MCK_BASE_URL)||(e.beforeSend=function(e){i.setHeaders(e)})}),a.betaPackage){var s="https://www.applozic.com/?utm_source="+t.location.href+"&utm_medium=webplugin&utm_campaign=poweredby";e(".mck-running-on a").attr("href",s),e(".mck-running-on").removeClass("n-vis").addClass("vis")}var o=Qe.getMckContactNameArray();if(null!==o&&o.length>0)for(var r=0;r<o.length;r++){var c=o[r];null!==c&&(st[c[0]]=c[1])}lt.checkUserConnectedStatus(),"function"==typeof ae&&ae("success",a),rt.tabFocused(),ft.length>0&&R>0&&ft.html(R),Je&&ut.loadMessageList({tabId:"",isGroup:!1,isLaunch:!0}),gt.subscribeToServiceWorker(),Qe.setAppHeaders(a),mckGroupService.loadGroups({apzCallback:dt.loadGroups})},i.validateAppSession=function(e){var t=Qe.getAppHeaders();return!(!t||!t.userId)&&(e.applicationId===t.appId&&e.userId===t.userId&&e.password===t.accessToken?(i.onInitApp(t),!0):(Qe.clearAppHeaders(),!1))},i.setHeaders=function(e){e.setRequestHeader("UserId-Enabled",!0),h&&e.setRequestHeader("Authorization","Basic "+h),e.setRequestHeader("Application-Key",F),I&&e.setRequestHeader("Device-Key",I),re&&e.setRequestHeader("Access-Token",re),ue&&e.setRequestHeader("App-Module-Name",ue)},i.setLabels=function(){e("#mck-conversation-title").html(MCK_LABELS["conversations.title"]).attr("title",MCK_LABELS["conversations.title"]),e("#mck-msg-new, #mck-sidebox-search .mck-box-title").html(MCK_LABELS["start.new"]).attr("title",MCK_LABELS["start.new"]),e("#mck-contact-search-tab strong").html(MCK_LABELS["search.contacts"]).attr("title",MCK_LABELS["search.contacts"]),e("#mck-group-search-tab strong").html(MCK_LABELS["search.groups"]).attr("title",MCK_LABELS["search.groups"]),e("#mck-contact-search-input, #mck-group-search-input, #mck-group-member-search").attr("placeholder",MCK_LABELS["search.placeholder"]),e("#mck-loc-address").attr("placeholder",MCK_LABELS["location.placeholder"]),e("#mck-no-conversations").html(MCK_LABELS["empty.conversations"]),e("#mck-no-messages").html(MCK_LABELS["empty.messages"]),e("#mck-no-more-conversations").html(MCK_LABELS["no.more.conversations"]),e("#mck-no-more-messages").html(MCK_LABELS["no.more.messages"]),e("#mck-no-search-contacts").html(MCK_LABELS["empty.contacts"]),e("#mck-no-search-groups").html(MCK_LABELS["empty.groups"]),e("#mck-new-group, #mck-group-create-tab .mck-box-title, #mck-btn-group-create").html(MCK_LABELS["create.group.title"]).attr("title",MCK_LABELS["create.group.title"]),e("#mck-gc-overlay-label").html(MCK_LABELS["add.group.icon"]),e("#mck-msg-error").html(MCK_LABELS["group.deleted"]),e("#mck-gc-title-label").html(MCK_LABELS["group.title"]),e("#mck-gc-type-label").html(MCK_LABELS["group.type"]),e("#mck-group-info-btn, #mck-group-info-tab .mck-box-title").html(MCK_LABELS["group.info.title"]).attr("title",MCK_LABELS["group.info.title"]),e("#mck-gi-overlay-label").html(MCK_LABELS["change.group.icon"]),e("#mck-group-member-title").html(MCK_LABELS["members.title"]).attr("title",MCK_LABELS["members.title"]),e("#mck-group-add-member .blk-lg-9, #mck-gm-search-box .mck-box-title").html(MCK_LABELS["add.members.title"]).attr("title",MCK_LABELS["add.members.title"]),e("#mck-btn-group-update").html(MCK_LABELS["group.info.update"]).attr("title",MCK_LABELS["group.info.update"]),e("#mck-btn-leave-group, #mck-btn-group-exit").html(MCK_LABELS["exit.group"]).attr("title",MCK_LABELS["exit.group"]),e("#mck-typing-label").html(MCK_LABELS.typing),e("#mck-btn-clear-messages").html(MCK_LABELS["clear.messages"]).attr("title",MCK_LABELS["clear.messages"]),e("#mck-block-button").html(MCK_LABELS["block.user"]).attr("title",MCK_LABELS["block.user"]),e("#mck-loc-box .mck-box-title, #mck-share-loc-label").html(MCK_LABELS["location.share.title"]).attr("title",MCK_LABELS["location.share.title"]),e("#mck-btn-loc").attr("title",MCK_LABELS["location.share.title"]),e("#mck-file-up-label").html(MCK_LABELS["file.attachment"]),e("#mck-file-up").attr("title",MCK_LABELS["file.attachment"]),e(".mck-file-attach-label").attr("title",MCK_LABELS["file.attach.title"]),e("#mck-my-loc").html(MCK_LABELS["my.location"]).attr("title",MCK_LABELS["my.location"]),e("#mck-btn-close-loc-box").html(MCK_LABELS.close).attr("title",MCK_LABELS.close),e("#mck-loc-submit").html(MCK_LABELS.send).attr("title",MCK_LABELS.send),e("#mck-msg-sbmt").attr("title",MCK_LABELS["send.message"]),e("#mck-btn-smiley").attr("title",MCK_LABELS.smiley),e("#mck-group-name-save").attr("title",MCK_LABELS.save),e("#mck-btn-group-icon-save").attr("title",MCK_LABELS.save),e("#mck-group-name-edit").attr("title",MCK_LABELS.edit)},e(a).on("click",".fancybox",function(t){var a=e(this);if(-1!==a.data("type").indexOf("video")){var s,o=a.find(".mck-video-box").html();a.fancybox({content:o,title:a.data("name"),padding:0,openEffect:"none",closeEffect:"none",helpers:{overlay:{locked:!1,css:{background:"rgba(0, 0, 0, 0.8)"}}},beforeShow:function(){(s=e(".fancybox-inner").find("video").get(0)).load(),s.play()}})}else{var i=a.data("url");e(this).fancybox({openEffect:"none",closeEffect:"none",padding:0,href:i,type:"image"})}}),e(t).on("resize",function(){if("block"===r.css("display")&&ct.fileMenuReposition(),0===c.find(".mck-contact-list").length){var e=c.get(0).scrollHeight;c.height()<e&&c.animate({scrollTop:c.prop("scrollHeight")},0)}}),i.appendLauncher=function(){e("#mck-sidebox-launcher").remove(),e("body").append(i.getLauncherHtml()),gt.init()},i.tabFocused=function(){function e(e){var a=!0,o=!1,n={focus:a,focusin:a,pageshow:a,blur:o,focusout:o,pagehide:o};e=e||t.event,(P=e.type in n?n[e.type]:!this[s])?(l<1&&L&&ht.checkConnected(!0),i.stopIdleTimeCounter()):(1===G&&ht.sendTypingStatus(0),i.manageIdleTime())}var s="hidden";s in a?a.addEventListener("visibilitychange",e):("mozHidden"===s)in a?a.addEventListener("mozvisibilitychange",e):("webkitHidden"===s)in a?a.addEventListener("webkitvisibilitychange",e):("msHidden"===s)in a?a.addEventListener("msvisibilitychange",e):"onfocusin"in a?a.onfocusin=a.onfocusout=e:t.onpageshow=t.onpagehide=t.onfocus=t.onblur=e,void 0!==a[s]&&e({type:a[s]?"blur":"focus"})},i.manageIdleTime=function(){l=w,s&&clearInterval(s),s=setInterval(function(){--l<0&&(l=0,ht.stopConnectedCheck(),clearInterval(s),s="")},6e4)},i.stopIdleTimeCounter=function(){l=w,s&&clearInterval(s),s=""},i.manageOfflineMessageTime=function(e){if("object"!=typeof ye||isNaN(ye.timeout))t.console.log("Offline message timeout required.");else{if(1===ye.type){if(!ye.userIds||0===ye.userIds.length)return void t.console.log("Offline message userIds required.");if(-1===ye.userIds.indexOf(e))return}o&&clearInterval(o),o=setTimeout(function(){clearInterval(o),o="",pt.showOfflineMessage()},5e3*parseInt(ye.timeout))}},i.stopOfflineMessageCounter=function(){o&&clearInterval(o),o=""}}function r(){var s=this,o=e("#mck-search"),i=e("#mck-msg-to"),n=e("#mck-msg-new"),r=e("#mck-sidebox"),c=e("#mck-file-box"),l=e("#mck-text-box"),d=e("#mck-msg-form"),m=e("#mck-msg-sbmt"),p=e("#mck-new-group"),u=e("#mck-tab-title"),v=e("#mck-msg-error"),g=e("#mck-btn-attach"),f=e("#mck-tab-status"),k=e("#mck-message-cell"),C=e(".mck-typing-box"),b=e("#mck-gms-loading"),h=e("#mck-group-title"),y=e("#mck-contact-loading"),I=e("#mck-no-messages"),M=e(".mck-group-search"),S=e("#mck-msg-response"),L=e("#mck-msg-form input"),x=e("#mck-block-button"),E=e("#li-mck-block-user"),w=e("#li-mck-group-info"),P=e("#li-mck-video-call"),R=e("#mck_response_text"),B=e(".mck-contact-search"),j=e("#mck-group-info-tab"),F=e("#mck-price-text-box"),z=(e("#mck-sidebox-search"),e("#mck-group-info-btn")),j=e("#mck-group-info-tab"),q=e("#mck-btn-group-exit"),V=e("#mck-group-back-link"),Z=e("#mck-btn-leave-group"),Q=e(".mck-sidebox-content"),X=e("#mck-no-more-messages"),ee=e("#mck-btn-group-create"),te=(e("#mck-group-create-tab"),e("#mck-group-add-member")),ae=(e("#mck-contacts-content"),e("#mck-tab-option-panel")),se=e("#mck-no-conversations"),oe=e("#mck-group-create-title"),ne=e(".mck-group-menu-options"),re=e(".mck-tab-message-option"),le=e(".mck-group-admin-options"),de=e("#mck-group-member-search"),me=e("#mck-message-cell .mck-message-inner"),pe=(e("#mck-search-cell .mck-message-inner"),e("#mck-no-more-conversations")),ue=e("#mck-gm-search-box"),ge=e("#mck-group-member-search-list"),Ce=e("#mck-no-gsm-text"),be="/rest/ws/message/send",he="/rest/ws/group/create",ye="/rest/ws/message/list",Ie="/rest/ws/message/detail",Me="/rest/ws/conversation/topicId",Te="/rest/ws/message/delete",Le="/rest/ws/conversation/id",xe="/rest/ws/message/read",Ee="/rest/ws/conversation/get",_e="/rest/ws/message/add/inbox",we="/rest/ws/message/delivered",Oe="/rest/ws/conversation/close",Ke="/rest/ws/message/delete/conversation",Re="/rest/ws/message/read/conversation",je='<div id="mck-ofl-blk" class="mck-m-b"><div class="mck-clear"><div class="blk-lg-12 mck-text-light mck-text-muted mck-test-center">${userIdExpr} is offline now</div></div></div>';e.template("oflTemplate",je),e(a).on("click",".mck-message-delete",function(){s.deleteMessage(e(this).parents(".mck-m-b").data("msgkey"))}),e(a).on("click",".mck-message-reply",function(){s.replyMessage(e(this).parents(".mck-m-b").data("msgkey"))}),e(a).on("click",".mck-message-forward",function(){n.data("forwardMessageKey",e(this).parents(".mck-m-b").data("msgkey")),n.trigger("click")}),e(".mck-minimize-icon").click(function(){e(".mck-box-md,.mck-box-ft").animate({height:"toggle"}),Q.hasClass("minimized")?(Q.css("height","100%"),Q.removeClass("minimized")):(Q.css("height","0%"),Q.addClass("minimized"))}),s.init=function(){Qe.clearMckMessageArray(),e(a).on("click","."+Y,function(){e(this).hasClass("mck-msg-preview")&&e(this).hide()}),pt.initSearchAutoType(),B.click(function(){pt.addContactsToContactSearchList()}),M.click(function(){pt.addGroupsToGroupSearchList()}),l.keydown(function(e){if(l.hasClass("mck-text-req")&&l.removeClass("mck-text-req"),13===e.keyCode&&(e.shiftKey||e.ctrlKey)){if(e.preventDefault(),t.getSelection){var s=t.getSelection(),o=s.getRangeAt(0),i=a.createElement("br"),n=a.createTextNode("Â ");return o.deleteContents(),o.insertNode(i),o.collapse(!1),o.insertNode(n),o.selectNodeContents(n),s.removeAllRanges(),s.addRange(o),l.animate({scrollTop:l.prop("scrollHeight")},0),!1}}else 13===e.keyCode?(e.preventDefault(),1===G&&ht.sendTypingStatus(0,me.data("mck-id")),m.is(":disabled")&&c.hasClass("vis")?alert("Please wait file is uploading."):d.submit()):0===G&&ht.sendTypingStatus(1,me.data("mck-id"))}),e(a).on("click",".mck-btn-clear-messages",function(){confirm(MCK_LABELS["clear.messages.alert"])&&ut.deleteConversation()}),e(a).on("click",".applozic-tm-launcher",function(t){t.preventDefault();var a=e(this).data("mck-id");a=void 0!==a&&""!==a?a.toString():"";var s=e(this).data("mck-name");s=void 0!==s&&""!==s?s.toString():"";var o=e(this).data("mck-supportid");o=void 0!==o&&""!==o?o.toString():"";var i=e(this).data("mck-topicid");i=void 0!==i&&""!==i?i.toString():"";var n=e(this).data("mck-msg");if(n=void 0!==n&&""!==n?n.toString():"","function"==typeof ve&&i){var r=ve(i);"object"==typeof r&&"undefined"!==r.title&&(O[i]=r)}var c={topicId:i,tabId:a,userName:s,isMessage:!0},l={type:5,contentType:0,message:n};c.messagePxy=l,o?(c.isGroup=!0,c.supportId=o,ut.getConversationId(c)):(c.isGroup=!1,pt.loadTab(c,ut.dispatchMessage))}),e(a).on("click",".applozic-wt-launcher",function(t){t.preventDefault();var a=e(this).data("mck-id");a=void 0!==a&&""!==a?a.toString():"";var s=e(this).data("mck-name");s=void 0!==s&&""!==s?s.toString():"";var o=e(this).data("mck-topicid");o=void 0!==o&&""!==o?o.toString():"";var i=e(this).data("mck-topic-status");if(i=i?-1===Ye.indexOf(i)?Ye[0]:i.toString():Ye[0],"function"==typeof ve){var n=ve(o);"object"==typeof n&&"undefined"!==n.title&&(O[o]=n)}ut.getConversationId({tabId:a,isGroup:!1,userName:s,topicId:o,topicStatus:i,isMessage:!1})}),e(a).on("click",".applozic-ct-launcher",function(t){t.preventDefault();var a=e(this).data("mck-id");a=void 0!==a&&""!==a?a.toString():"";var s=e(this).data("mck-name");s=void 0!==s&&""!==s?s.toString():"";var o=e(this).data("mck-topicid");o=void 0!==o&&""!==o?o.toString():"";var i=e(this).data("mck-topic-status"),n={tabId:a,isGroup:!1,userName:s,topicId:o,topicStatus:i=i?-1===Ye.indexOf(i)?Ye[0]:i.toString():Ye[0],isMessage:!1};if("function"==typeof Se){var r=Se(o);"object"==typeof r&&(r.topicDetail&&"object"==typeof r.topicDetail&&"undefined"!==r.topicDetail.title&&(O[o]=r.topicDetail),r.fallBackTemplatesList&&r.fallBackTemplatesList.length>0&&(n.fallBackTemplatesList=r.fallBackTemplatesList))}ut.getConversationId(n)}),e(a).on("click","."+Y+", .mck-contact-list ."+Y,function(t){t.preventDefault();var a=this;e(this).parents(".mck-search-list").length?(o.bind("blur"),setTimeout(function(){s.openChat(a)},600)):s.openChat(this)}),e(a).on("click",".mck-conversation-tab-link",function(t){t.preventDefault();e(this);var a=me.data("mck-id"),s=me.data("isgroup");pt.loadTab({tabId:"",isGroup:!1,lastActiveTabId:a,isLastActiveTabGroup:s})}),e(a).on("click",".mck-close-sidebox",function(e){e.preventDefault(),r.mckModal("hide");var t=me.data("mck-conversationid");if(me.data("mck-id",""),me.data("mck-topicid",""),me.data("mck-name",""),me.data("mck-conversationid",""),t){var a=K[t];if("object"==typeof a){var s=a.topicId;"function"==typeof ie&&ie(Ge,s)}}ht.unsubscibeToTypingChannel()}),e(a).on("click",".mck-price-submit",function(e){e.preventDefault(),s.sendPriceMessage()}),F.keydown(function(e){13===e.keyCode&&s.sendPriceMessage()}),me.bind("scroll",function(){if(me.find(".mck-contact-list").length>0)me.scrollTop()+me.innerHeight()>=me[0].scrollHeight&&(s=me.data("datetime"))>0&&!A&&ut.loadMessageList({tabId:"",isGroup:!1,startTime:s});else if(0===me.scrollTop()){var e=me.data("mck-id");if(void 0===e||""===e)return;var t=me.data("isgroup"),a=me.data("mck-conversationid");a=a?a.toString():"";var s=ae.data("datetime");s>0&&!A&&ut.loadMessageList({tabId:e,isGroup:t,conversationId:a,startTime:s})}}),F.on("click",function(e){e.preventDefault(),F.removeClass("mck-text-req")}),x.on("click",function(e){e.preventDefault();var t=me.data("mck-id"),a=me.data("isgroup"),s=!me.data("blocked");if(a)return E.removeClass("vis").addClass("n-vis"),void P.removeClass("vis").addClass("n-vis");var o=s?MCK_LABELS["block.user.alert"]:MCK_LABELS["unblock.user.alert"];confirm(o)&&vt.blockUser(t,s)}),Z.on("click",function(e){e.preventDefault();var t=me.data("mck-id");me.data("isgroup")?confirm(MCK_LABELS["exit.group.alert"])&&mckGroupService.leaveGroup({apzCallback:dt.onGroupLeft,groupId:t}):ne.removeClass("vis").addClass("n-vis")}),e(a).on("click",".mck-add-to-group",function(t){t.preventDefault();var a=e(this).data("mck-id");void 0!==a&&dt.addGroupMemberFromSearch(a),ue.mckModal("hide")}),e(a).on("click",".mck-btn-remove-member",function(t){t.preventDefault();var a=e(this).parents(".mck-li-group-member").data("mck-id"),s=j.data("mck-id");if(void 0!==s&&void 0!==a){var o=mckGroupUtils.getGroup(s);"object"==typeof o&&Ge===o.adminName?confirm(MCK_LABELS["remove.member.alert"])&&mckGroupService.removeGroupMember({groupId:s,userId:a,apzCallback:dt.onRemovedGroupMember}):le.removeClass("vis").addClass("n-vis")}}),q.on("click",function(e){e.preventDefault();var t=j.data("mck-id");t?confirm(MCK_LABELS["exit.group.alert"])&&mckGroupService.leaveGroup({groupId:t,apzCallback:dt.onGroupLeft}):pt.loadTab({tabId:"",isGroup:!1})}),z.on("click",function(e){e.preventDefault();var t=me.data("mck-id");if(me.data("isgroup")){var a={groupId:t},s=me.data("mck-conversationid");s&&(a.conversationId=s),dt.loadGroupInfo(a)}else ne.removeClass("vis").addClass("n-vis")}),p.on("click",function(e){e.preventDefault(),dt.loadCreateGroupTab()}),V.on("click",function(e){e.preventDefault();var t=j.data("mck-id"),a=j.data("mck-conversation-id");if(t){var s={tabId:t,isGroup:!0};a&&(s.conversationId=a),pt.loadTab(s)}else pt.loadTab({tabId:"",isGroup:!1})}),te.on("click",function(t){t.preventDefault();var a=j.data("mck-id");if(a){var s=mckGroupUtils.getGroup(a);if(!s||s.adminName!==Ge)return void le.removeClass("vis").addClass("n-vis");ge.html(""),ue.mckModal(),b.removeClass("n-vis").addClass("vis"),it.length>0?dt.addMembersToGroupSearchList():Fe?tt.length>0?(e.each(tt,function(e,t){it.push(t.contactId)}),dt.addMembersToGroupSearchList()):(b.removeClass("vis").addClass("n-vis"),Ce.removeClass("n-vis").addClass("vis")):vt.getUserStatus({callback:dt.addMembersToGroupSearchList})}}),de.keypress(function(e){if(13===e.which){var t=de.val();return""!==t&&dt.addGroupMemberFromSearch(t),de.val(""),!0}}),e(a).on("click",".mck-group-member-search-link",function(e){e.preventDefault();var t=de.val();""!==t&&dt.addGroupMemberFromSearch(t),de.val("")}),e(a).on("click",".mck-show-more",function(t){t.preventDefault();var a=e(this),s=a.data("tabId"),o=me.data("isgroup"),i=me.data("mck-conversationid");i=i?i.toString():"";var n=a.data("datetime");ut.loadMessageList({tabId:s,isGroup:o,conversationId:i,startTime:n})}),e(a).on("click",".mck-accept",function(t){var a=e(this).data("mck-conversationid"),s=e(this).data("mck-topic-price");if("function"==typeof ke&&s&&a){var o=K[a],n=i.val(),r=dt.getGroupDisplayName(n);"object"==typeof o?(ke({custId:Ge,suppId:r,productId:o.topicId,price:s}),ut.sendConversationCloseUpdate(a)):ut.getTopicId({conversationId:a,suppId:r,priceText:s})}}),d.submit(function(){1===G&&ht.sendTypingStatus(0,me.data("mck-id"));var a=e.trim(mckUtils.textVal(l[0]));if(c.hasClass("n-vis")&&T.length>0&&(T=[]),0===a.length&&0===T.length)return l.addClass("mck-text-req"),!1;if("function"==typeof fe&&!fe(a))return!1;var o={type:5,contentType:0,message:a},n=me.data("mck-conversationid"),r=me.data("mck-topicid");if(n)o.conversationId=n;else if(r){var d={topicId:r},p=O[r];"object"==typeof p&&(d.topicDetail=t.JSON.stringify(p)),o.conversationPxy=d}return!0===me.data("isgroup")?o.groupId=i.val():o.to=i.val(),m.attr("disabled",!0),v.removeClass("vis").addClass("n-vis"),v.html(""),R.html(""),S.removeClass("vis").addClass("n-vis"),s.sendMessage(o),!1}),L.on("click",function(){e(this).val(""),v.removeClass("vis").addClass("n-vis"),S.removeClass("vis").addClass("n-vis")}),e(a).bind("click",function(t){e(".mck-context-menu").removeClass("vis").addClass("n-vis"),!g.hasClass("on")||e(t.target).hasClass("mck-icon-upload")||e(t.target).hasClass("mck-btn-attach")||ct.fileMenuToggle(),l.removeClass("mck-text-req"),a.activeElement&&a.activeElement!==l&&1===G&&ht.sendTypingStatus(0,me.data("mck-id")),a.activeElement&&"mck-group-name-save"!==a.activeElement.id&&h.removeClass("mck-req-border"),a.activeElement&&"mck-btn-group-create"!==a.activeElement.id&&oe.removeClass("mck-req-border"),e(".mcktypeahead.mck-dropdown-menu").hide()}),e(".mck-tabview-item").click(function(){e(".mck-tabview-item").removeClass("active"),e(this).addClass("active")})},s.openChat=function(t){var a=e(t),s=a.data("mck-id");s=void 0!==s&&""!==s?s.toString():"";var i=a.data("mck-name");i=void 0!==i&&""!==i?i.toString():"";var n=a.data("mck-topicid");n=void 0!==n&&""!==n?n.toString():"";var r=!0===a.data("isgroup"),c=a.data("mck-conversationid");if(c=void 0!==c&&""!==c?c.toString():"",n&&!c){var l=e(elem).data("mck-topic-status");l=l?-1===Ye.indexOf(l)?Ye[0]:l.toString():Ye[0],ut.getConversationId({tabId:s,isGroup:r,userName:i,topicId:n,topicStatus:l,isMessage:!1})}else pt.loadTab({tabId:s,isGroup:r,userName:i,conversationId:c,topicId:n});o.val("")},s.sendMessage=function(t){if("object"==typeof t){var a=t.metadata?t.metadata:{},o=e("#mck-text-box").data("AL_REPLY");if(void 0===o||""===o||t.forward||(a.AL_REPLY=o),t.metadata=a,void 0!==t.message&&0!==t.message.length||0!==T.length){if(t.conversationId){var i=K[t.conversationId];if("undefined"!==i&&i.closed)return pt.closeConversation(),void m.attr("disabled",!1)}if(me.data("blocked"))return lt.toggleBlockUser(c,!0),void m.attr("disabled",!1);var n="";if(t.groupId?void 0===(n=mckGroupUtils.getGroup(t.groupId))&&(n=mckGroupUtils.createGroup(t.groupId)):n=t.clientGroupId?mckGroupUtils.getGroupByClientGroupId(t.clientGroupId):pt.fetchContact(t.to),e("#mck-message-cell .mck-no-data-text").length>0&&e(".mck-no-data-text").remove(),t.message&&0===T.length){var r=re.hasClass("n-vis"),c=me.data("mck-id"),d=mckUtils.randomId();t.key=d,12!==t.contentType&&c&&c.toString()===n.contactId&&102!==t.contentType&&s.addMessageToTab(t,n);var p={tabId:n.contactId,isTopPanelAdded:r};s.submitMessage(t,p)}else T.length>0&&e.each(T,function(e,a){var o=re.hasClass("n-vis"),i=me.data("mck-id"),r=mckUtils.randomId();t.key=r,t.fileMeta=a,t.contentType=1,12!==t.contentType&&i&&i.toString()===n.contactId&&s.addMessageToTab(t,n);var c={tabId:n.contactId,isTopPanelAdded:o};s.submitMessage(t,c)});l.removeClass("mck-text-req"),m.attr("disabled",!1),e("."+d+" .mck-message-status").removeClass("mck-icon-sent").addClass("mck-icon-time"),pt.addTooltip(d),pt.clearMessageField(!0),T=[],delete at[n.contactId]}else l.addClass("mck-text-req")}},s.addMessageToTab=function(e,t){var a={to:e.to,groupId:e.groupId,deviceKey:e.deviceKey,contentType:e.contentType,message:e.message,conversationId:e.conversationId,topicId:e.topicId,sendToDevice:!0,createdAtTime:(new Date).getTime(),key:e.key,storeOnDevice:!0,sent:!1,read:!0,metadata:e.metadata?e.metadata:""};a.type=e.type?e.type:5,e.fileMeta&&(a.fileMeta=e.fileMeta),pt.addMessage(a,t,!0,!0,!1)},s.sendForwardMessage=function(e){var a=Qe.getMessageByKey(e);if(void 0!==a){a.fileMeta&&T.push(a.fileMeta);var o={type:5,contentType:a.contentType,message:a.message,forward:"forward"};a.metadata&&(a.metadata.AL_REPLY&&(a.metadata.AL_REPLY=""),o.metadata=a.metadata);var n=me.data("mck-conversationid"),r=me.data("mck-topicid");if(n)o.conversationId=n;else if(r){var c={topicId:r},l=O[r];"object"==typeof l&&(c.topicDetail=t.JSON.stringify(l)),o.conversationPxy=c}!0===me.data("isgroup")?o.groupId=i.val():o.to=i.val(),s.sendMessage(o)}},s.sendWelcomeMessage=function(e){var t=mckUtils.randomId(),a=me.data("mck-id"),o=me.data("isgroup"),i={key:t,type:4,contentType:0,to:e.sender,message:e.messageContent};if(a&&a.toString()===e.sender&&!o){var n=pt.fetchContact(a);s.addMessageToTab(i,n)}mckUtils.ajax({type:"GET",url:MCK_BASE_URL+_e,global:!1,data:"sender="+encodeURIComponent(e.sender)+"&messageContent="+encodeURIComponent(e.messageContent),contentType:"text/plain",success:function(t){e.callback&&e.callback(t)}})},s.submitMessage=function(a,s){var o=a.key,i=a.metadata?a.metadata:{};Pe&&(a.metadata={userStatus:4});var n=e("#mck-text-box").data("AL_REPLY");void 0===n||""===n||a.forward||(i.AL_REPLY=n,e("#mck-text-box").data("AL_REPLY","")),a.source=Ae;var r=e("#mck-message-cell .mck-message-inner div[name='message']."+o);102!=a.contentType&&103!=a.contentType&&(a.metadata=Ne),a.metadata=i,mckUtils.ajax({type:"POST",url:MCK_BASE_URL+be,global:!1,data:t.JSON.stringify(a),contentType:"application/json",success:function(t){var i=me.data("mck-id");if("object"==typeof t){var n=t.messageKey;if(i&&i.toString()===s.tabId){var c=t.conversationId;me.data("mck-conversationid",c),r.removeClass(o).addClass(n),r.data("msgkey",n),e("."+n+" .mck-message-status").removeClass("mck-icon-time").addClass("mck-icon-sent").attr("title","sent"),pt.addTooltip(n),s.isTopPanelAdded&&ae.data("datetime",t.createdAt);var l=!0;a.groupId&&6===mckGroupUtils.getGroup(a.groupId).type&&(l=!1),l&&pt.messageContextMenu(n)}if(a.conversationPxy){var d=a.conversationPxy;a.topicId&&(J[a.topicId]=[c]),K[c]=d}}else"CONVERSATION_CLOSED"===t||"BUSY_WITH_OTHER"===t?(m.attr("disabled",!1),pt.closeConversation(t),r.remove(),s.isTopPanelAdded&&re.removeClass("vis").addClass("n-vis")):"error"===t&&(m.attr("disabled",!1),v.html("Unable to process your request. Please try again"),v.removeClass("n-vis").addClass("vis"),r.remove(),s.isTopPanelAdded&&re.removeClass("vis").addClass("n-vis"))},error:function(){v.html("Unable to process your request. Please try again."),v.removeClass("n-vis").addClass("vis"),r&&r.remove(),s.isTopPanelAdded&&re.removeClass("vis").addClass("n-vis")}}),$("#mck-reply-to-div").removeClass("vis").addClass("n-vis")},s.downloadImage=function(e){window.open(e,"_blank")},s.replyMessage=function(e){var t="",a=(me.data("mck-id"),ut.getReplyMessageByKey(e));l.focus().select(),$("#mck-reply-to-div").removeClass("n-vis").addClass("vis"),t=5===a.type?"You":pt.getTabDisplayName(a.to,!1),$("#mck-reply-to").html(t),"object"==typeof a.fileMeta||2===a.contentType?$("#mck-reply-msg").html(pt.getImageForMessagePreview(a)):$("#mck-reply-msg").html(a.message),$("#mck-text-box").data("AL_REPLY",e)},$("#close").click(function(){$("#mck-reply-to-div").removeClass("vis").addClass("n-vis"),$("#mck-text-box").data("AL_REPLY","")}),s.deleteMessage=function(a){var s=me.data("mck-id");void 0!==s&&mckUtils.ajax({url:MCK_BASE_URL+Te+"?key="+a,type:"get",success:function(o){"success"===o?(me.data("mck-id")===s&&(e("."+a).remove(),me.is(":empty")&&re.removeClass("vis").addClass("n-vis")),Qe.clearMckMessageArray()):t.console.log("Unable to delete message. Please reload page.")}})},s.deleteConversation=function(){var e=me.data("mck-id"),t=me.data("isgroup"),a=me.data("mck-conversationid");if(void 0!==e){var s=t?"groupId="+e:"userId="+encodeURIComponent(e);a&&(s+="&conversationId="+a),A=!0,mckUtils.ajax({type:"get",url:MCK_BASE_URL+Ke,global:!1,data:s,success:function(){me.data("mck-id")===e&&(me.html(""),ae.data("datetime",""),k.removeClass("n-vis").addClass("vis"),I.removeClass("n-vis").addClass("vis"),re.removeClass("vis").addClass("n-vis"),A=!1)},error:function(){}})}},s.getMessages=function(e){var t="";void 0!==e.userId&&""!==e.userId?(t=e.isGroup?"&groupId="+e.userId:"&userId="+encodeURIComponent(e.userId),e.startTime&&(t+="&endTime="+e.startTime),t+="&pageSize=30",(Be||Ue)&&e.conversationId&&(t+="&conversationId="+e.conversationId,void 0===nt[e.userId]&&(t+="&conversationReq=true"))):(e.startTime&&(t+="&endTime="+e.startTime),t+="&mainPageSize=100");var a=new Object;mckUtils.ajax({url:MCK_BASE_URL+ye+"?startIndex=0"+t,type:"get",success:function(t){a.status="success",a.data=t,e.callback&&e.callback(a)},error:function(t,s,o){401===t.status&&(sessionStorage.clear(),console.log("Please reload page.")),a.status="error",e.callback&&e.callback(a)}})},s.getMessageList=function(t){var a=t.id;if(void 0!==t.clientGroupId&&""!==t.clientGroupId){s=t.pageSize?"&pageSize="+t.pageSize:"&pageSize=50";s+="&clientGroupId="+t.clientGroupId,t.startTime&&(s+="&endTime="+t.startTime);o={clientGroupId:t.clientGroupId}}else if(void 0!==a&&""!==a){s=t.pageSize?"&pageSize="+t.pageSize:"&pageSize=50";s+=""+t.isGroup=="true"?"&groupId="+a:"&userId="+a,t.startTime&&(s+="&endTime="+t.startTime);o={id:a}}else{var s=t.pageSize?"&mainPageSize="+t.pageSize:"&mainPageSize=50";t.startTime&&(s+="&endTime="+t.startTime);var o={id:""}}t.topicId&&(a||t.clientGroupId)&&(t.conversationId&&(s+="&conversationId="+t.conversationId),t.topicId&&(o.topicId=t.topicId)),mckUtils.ajax({url:MCK_BASE_URL+ye+"?startIndex=0"+s,type:"get",global:!1,success:function(a){if(o.status="success",void 0===a.message||0===a.message.length)o.messages=[];else{var s=a.message,i=new Array;e.each(s,function(e,t){if(void 0!==t.to||void 0!==t.groupId){var a=pt.getMessageFeed(t);i.push(a)}}),o.messages=i}a.groupFeeds.length>0&&(o.id=a.groupFeeds[0].id),t.callback(o)},error:function(e,a,s){401===e.status&&(sessionStorage.clear(),console.log("Please reload page.")),o.status="error",t.callback(o)}})},s.getReplyMessageByKey=function(e){return void 0===Qe.getMessageByKey(e)&&mckUtils.ajax({url:MCK_BASE_URL+Ie,async:!1,type:"get",data:"keys="+e,success:function(e){Qe.updateMckMessageArray(e)}}),Qe.getMessageByKey(e)},s.loadMessageList=function(a,s){var o=!1,i=!1,r="";void 0!==a.tabId&&""!==a.tabId?(r=a.isGroup?"&groupId="+a.tabId:"&userId="+encodeURIComponent(a.tabId),o=!0,a.startTime&&(r+="&endTime="+a.startTime),r+="&pageSize=30",(Be||Ue)&&a.conversationId&&(r+="&conversationId="+a.conversationId,void 0===nt[a.tabId]?(i=!0,r+="&conversationReq=true"):pt.addConversationMenu(a.tabId,a.isGroup))):(A=!0,a.startTime&&(r+="&endTime="+a.startTime),r+="&mainPageSize=60"),a.startTime||me.html(""),y.removeClass("n-vis").addClass("vis"),mckUtils.ajax({url:MCK_BASE_URL+ye+"?startIndex=0"+r,type:"get",global:!1,success:function(r){var c=!0,l=me.data("mck-id"),d=me.data("isgroup");if(a.isGroup&&!a.startTime||y.removeClass("vis").addClass("n-vis"),A=!1,(void 0===l||a.tabId===l&&""+d==""+a.isGroup)&&(r+""!="null"&&void 0!==r.message&&0!==r.message.length||(c=!1,o?a.startTime?(X.removeClass("n-vis").addClass("vis"),X.fadeOut(5e3,function(){X.removeClass("vis").addClass("n-vis")}),ae.data("datetime","")):a.isGroup||0!==e("#mck-message-cell .mck-message-inner div[name='message']").length||(re.removeClass("vis").addClass("n-vis"),se.removeClass("vis").addClass("n-vis"),I.removeClass("n-vis").addClass("vis")):(I.removeClass("vis").addClass("n-vis"),a.startTime?(pe.removeClass("n-vis").addClass("vis"),pe.fadeOut(5e3,function(){pe.removeClass("vis").addClass("n-vis")})):(I.removeClass("vis").addClass("n-vis"),se.removeClass("n-vis").addClass("vis")),me.data("datetime",""))),r+""!="null"&&"error"!==r.status))if(o){if(c&&(a.startTime>0?pt.processMessageList(r,!1,!0):a.isGroup||(pt.processMessageList(r,!0,!0),re.removeClass("n-vis").addClass("vis"))),!a.startTime>0&&!a.isGroup&&"function"==typeof ce&&ce(a.tabId),r.userDetails.length>0&&e.each(r.userDetails,function(e,s){if(D[s.userId]=s,!a.isGroup&&(s.connected?t.MCK_OL_MAP[s.userId]=!0:(t.MCK_OL_MAP[s.userId]=!1,void 0!==s.lastSeenAtTime&&(N[s.userId]=s.lastSeenAtTime)),W||a.isGroup||(s.blockedByThis?(U[s.userId]=!0,lt.toggleBlockUser(a.tabId,!0)):s.blockedByOther?(_[s.userId]=!0,u.removeClass("mck-tab-title-w-status"),f.removeClass("vis").addClass("n-vis"),C.removeClass("vis").addClass("n-vis"),me.data("blocked",!1)):lt.toggleBlockUser(a.tabId,!1)),s.userName&&!a.startTime)){var o=pt.getTabDisplayName(a.tabId,a.isGroup,s.userName);u.html(o),u.attr("title",o)}}),!De||a.isGroup||a.startTime||t.MCK_OL_MAP[a.tabId]||rt.manageOfflineMessageTime(a.tabId),r.conversationPxys.length>0){var m=new Array;e.each(r.conversationPxys,function(a,s){if("object"==typeof s&&(m.push(s),K[s.id]=s,J[s.topicId]=[s.id],s.topicDetail))try{O[s.topicId]=e.parseJSON(s.topicDetail)}catch(e){t.console.log("Incorect Topic Detail!")}}),i&&(nt[a.tabId]=m,pt.addConversationMenu(a.tabId,a.isGroup))}if(a.conversationId){var p=K[a.conversationId];"object"==typeof p&&p.closed&&pt.closeConversation()}a.startTime||(a.isGroup?(dt.addGroupStatus(mckGroupUtils.getGroup(a.tabId)),pt.updateUnreadCount("group_"+a.tabId,0,!0)):pt.updateUnreadCount("user_"+a.tabId,0,!0),"function"==typeof s&&s(a)),r.groupFeeds.length>0&&e.each(r.groupFeeds,function(t,s){var o=mckGroupUtils.addGroup(s);if(!a.startTime){var i=s.membersId,n=[];if(e.each(i,function(e,t){void 0===pt.getContact(t)&&n.push(t)}),n.length>0)a.isMessages=c,a.messageData=r,a.isLoadMessageList=!0,vt.getUsersDetail(n,a);else{dt.addGroupStatus(o);var l=!0;if(7===o.type){w.removeClass("vis").addClass("n-vis");var d=pt.getContactFromGroupOfTwo(o);lt.lastSeenOfGroupOfTwo(d.contactId)}6===o.type&&(dt.validateOpenGroupUser(o),l=dt.isAppendOpenGroupContextMenu(o)),y.removeClass("vis").addClass("n-vis"),c?(I.removeClass("vis").addClass("n-vis"),pt.processMessageList(r,!0,l),6!==o.type&&re.removeClass("n-vis").addClass("vis")):0===e("#mck-message-cell .mck-message-inner div[name='message']").length&&(re.removeClass("vis").addClass("n-vis"),I.removeClass("n-vis").addClass("vis")),"function"==typeof ce&&ce(a.tabId)}}})}else a.startTime||(t.MCK_OL_MAP=[]),r.userDetails.length>0&&e.each(r.userDetails,function(e,a){D[a.userId]=a,a.connected?t.MCK_OL_MAP[a.userId]=!0:(t.MCK_OL_MAP[a.userId]=!1,void 0!==a.lastSeenAtTime&&(N[a.userId]=a.lastSeenAtTime)),pt.updateUnreadCount("user_"+a.userId,a.unreadCount,!1);var s=pt.getContact(""+a.userId);void 0===s?pt.createContactWithDetail(a):pt.updateContactDetail(s,a)}),r.groupFeeds.length>0&&e.each(r.groupFeeds,function(e,t){pt.updateUnreadCount("group_"+t.id,t.unreadCount,!1),mckGroupUtils.addGroup(t)}),r.blockedUserPxyList.blockedToUserList.length>0&&e.each(r.blockedUserPxyList.blockedToUserList,function(e,t){t.userBlocked&&(U[t.blockedTo]=!0)}),r.blockedUserPxyList.blockedByUserList.length>0&&e.each(r.blockedUserPxyList.blockedByUserList,function(e,t){t.userBlocked&&(_[t.blockedBy]=!0)}),r.conversationPxys.length>0&&e.each(r.conversationPxys,function(a,s){if(K[s.id]=s,J[s.topicId]=[s.id],s.topicDetail)try{O[s.topicId]=e.parseJSON(s.topicDetail)}catch(e){t.console.log("Incorect Topic Detail!")}}),c?(a.startTime?a.startTime&&(a.isReload=!1,o||Qe.updateLatestMessageArray(r.message)):(a.isReload=!0,o||Qe.setLatestMessageArray(r.message)),o&&Qe.updateMckMessageArray(r.message),pt.addContactsFromMessageList(r,a)):me.data("datetime",""),a.isLaunch&&pt.updateUnreadCountonChatIcon(r.userDetails);var v=n.data("forwardMessageKey");void 0!==v&&(ut.sendForwardMessage(v),n.data("forwardMessageKey",""))},error:function(e,a,s){401===e.status&&(sessionStorage.clear(),console.log("Please reload page.")),A=!1,y.removeClass("vis").addClass("n-vis"),t.console.log("Unable to load messages. Please reload page.")}})},s.updateContactList=function(e,t){var a="startIndex=0&pageSize=1&"+(t?"groupId="+e:"userId="+encodeURIComponent(e));mckUtils.ajax({url:MCK_BASE_URL+ye,data:a,global:!1,type:"get",success:function(a){if(a+""=="null"||void 0===a.message||0===a.message.length)pt.clearContactMessageData(e,t);else{var s=a.message[0];void 0!==s&&(s.groupId?pt.addGroupFromMessage(s,!0):pt.addContactsFromMessage(s,!0))}},error:function(a,s,o){401===a.status&&(sessionStorage.clear(),console.log("Please reload page.")),pt.clearContactMessageData(e,t)}})},s.sendDeliveryUpdate=function(e){var t="key="+e.pairedMessageKey;mckUtils.ajax({url:MCK_BASE_URL+we,data:t,global:!1,type:"get",success:function(){},error:function(){}})},s.sendReadUpdate=function(e){if(void 0!==e&&""!==e){var t="key="+e;mckUtils.ajax({url:MCK_BASE_URL+xe,data:t,global:!1,type:"get",success:function(){},error:function(){}})}},s.conversationReadUpdate=function(e,t){var a=t?"group_"+e:"user_"+e;if(e&&pt.getUnreadCount(a)>0){var s=t?"groupId="+e:"userId="+encodeURIComponent(e);mckUtils.ajax({url:MCK_BASE_URL+Re,data:s,global:!1,type:"get",success:function(){pt.updateUnreadCount(a,0,!0)},error:function(){}})}},s.getConversationId=function(a){if(!a.isGroup&&!a.isMessage&&a.topicStatus!==Ye[1]){var o=J[a.topicId];if(o&&"object"==typeof(n=K[o])){if(me.data("mck-conversationid",n.id),a.conversationId=n.id,void 0!==nt[a.tabId]){var i=nt[a.tabId];i.push(n),nt[a.tabId]=i}return void pt.loadTab(a)}}if(a.topicId){var n={topicId:a.topicId,userId:a.tabId,status:a.topicStatus};a.isGroup&&(n.supportIds=[],n.supportIds.push(a.supportId));var r=O[a.topicId];"object"==typeof r&&(n.topicDetail=t.JSON.stringify(r)),a.fallBackTemplatesList&&a.fallBackTemplatesList.length>0&&(n.fallBackTemplatesList=a.fallBackTemplatesList),mckUtils.ajax({url:MCK_BASE_URL+Le,global:!1,data:t.JSON.stringify(n),type:"post",contentType:"application/json",success:function(o){if("object"==typeof o&&"success"===o.status){var i=o.response;if("object"==typeof i&&"undefined"!==i.conversationPxy){var n=i.conversationPxy;if(K[n.id]=n,J[n.topicId]=[n.id],n.topicDetail)try{O[n.topicId]=e.parseJSON(n.topicDetail)}catch(e){t.console.log("Incorect Topic Detail!")}if(me.data("mck-conversationid",n.id),a.conversationId=n.id,void 0!==nt[a.tabId]){var r=nt[a.tabId];r.push(n),nt[a.tabId]=r}if(a.isGroup){var c=mckGroupUtils.addGroup(i);a.tabId=c.contactId}a.isMessage&&n.created?pt.loadTab(a,s.dispatchMessage):pt.loadTab(a)}}},error:function(){}})}},s.fetchConversationByTopicId=function(a){var s="topic="+a.topicId;if(a.tabId)s+=""+a.isGroup=="true"?"&groupId="+a.tabId:"&userId="+encodeURIComponent(a.tabId);else{if(!a.clientGroupId)return!1;s+="&clientGroupId="+a.clientGroupId}a.pageSize&&(s+="&pageSize="+a.pageSize),mckUtils.ajax({url:MCK_BASE_URL+Ee,data:s,type:"get",success:function(s){if("object"==typeof s&&"success"===s.status){var o=s.response;if(o.length>0&&e.each(o,function(s,o){if(K[o.id]=o,J[o.topicId]=[o.id],o.topicDetail)try{O[o.topicId]=e.parseJSON(o.topicDetail)}catch(e){t.console.log("Incorect Topic Detail!")}if(a.tabId&&void 0!==nt[a.tabId]){var i=nt[a.tabId];i.push(o),nt[a.tabId]=i}}),a.isExtMessageList)if(o.length>0)a.conversationId=o[0].id,a.pageSize=50,ut.getMessageList(a);else if("function"==typeof a.callback){i={};a.tabId?(i.id=a.tabId,i.isGroup=a.isGroup):a.clientGroupId&&(i.clientGroupId=a.clientGroupId),i.topicId=a.topicId,i.status="success",i.messages=[],a.callback(i)}}else if(a.isExtMessageList&&"function"==typeof a.callback){var i={};a.tabId?i.id=a.tabId:a.clientGroupId&&(i.clientGroupId=a.clientGroupId),i.topicId=a.topicId,i.status="error",i.errorMessage="Unable to process request. Please try again.",a.callback(i)}},error:function(){if("function"==typeof a.callback){var e={};a.tabId?e.id=a.tabId:a.clientGroupId&&(e.clientGroupId=a.clientGroupId),e.topicId=a.topicId,e.status="error",e.errorMessage="Unable to process request. Please try again.",a.callback(e)}}})},s.getTopicId=function(a){if(a.conversationId){var o="id="+a.conversationId;mckUtils.ajax({url:MCK_BASE_URL+Me,data:o,global:!1,type:"get",async:void 0===a.async||a.async,success:function(o){if("object"==typeof o&&"success"===o.status){var i=o.response;if("object"==typeof i){if(J[i.topicId]=[a.conversationId],K[a.conversationId]=i,i.topicDetail)try{O[i.topicId]=e.parseJSON(i.topicDetail)}catch(e){t.console.log("Incorect Topic Detail!")}if("function"==typeof ke&&a.priceText&&(ke({custId:Ge,suppId:a.suppId,productId:i.topicId,price:a.priceText}),s.sendConversationCloseUpdate(a.conversationId)),a.messageType&&"object"==typeof a.message){var n=a.message.groupId?a.message.groupId:a.message.to;if(void 0!==nt[n]){var r=nt[n];r.push(i),nt[n]=r}(void 0===a.populate||a.populate)&&pt.populateMessage(a.messageType,a.message,a.notifyUser)}"function"==typeof a.callback&&a.callback(i)}}},error:function(){}})}},s.sendConversationCloseUpdate=function(e){if(e){var t="id="+e;mckUtils.ajax({url:MCK_BASE_URL+Oe,data:t,global:!1,type:"get",success:function(){},error:function(){}})}},s.sendPriceMessage=function(){var t=F.val();if(""!==t){t=e.trim(t);var a=i.val(),o=me.data("mck-conversationid",o),n={type:5,contentType:4,message:t};if(!0===me.data("isgroup")?n.groupId=a:n.to=a,me.data("mck-conversationid")){o=me.data("mck-conversationid");n.conversationId=o;var r=K[o];"object"!==r?s.getTopicId({conversationId:o,suppId:a,priceText:t}):"function"==typeof ke&&ke({custId:Ge,suppId:a,productId:r.topicId,price:t}),F.val("")}s.sendMessage(n)}else F.addClass("mck-text-req")},s.dispatchMessage=function(a){if("object"===a.messagePxy){var o=a.messagePxy;if(a.topicId){var i=O[a.topicId];if("object"==typeof i&&"undefined"!==i.title)if(o.message||(o.message=e.trim(i.title)),a.conversationId)o.conversationId=a.conversationId;else if(a.topicId){var n={topicId:a.topicId};"object"==typeof i&&(n.topicDetail=t.JSON.stringify(i)),o.conversationPxy=n}if(!o.message&&i.link){var r={blobKey:e.trim(i.link),contentType:"image/png"};o.fileMeta=r,o.contentType=5,(T=[]).push(r)}}a.isGroup?o.groupId=a.tabId:o.to=a.tabId,s.sendMessage(o)}},s.getGroup=function(a){var o=[];e.each(a.users,function(e,t){void 0!==t.userId&&(void 0!==t.groupRole&&-1===H.indexOf(t.groupRole)||o.push(t))});var i={groupName:e.trim(a.groupName),users:o,type:a.type};a.clientGroupId&&(i.clientGroupId=a.clientGroupId),a.groupIcon&&(i.imageUrl=a.groupIcon),i.metadata=MCK_LABELS["group.metadata"];var n=new Object;mckUtils.ajax({url:MCK_BASE_URL+he,global:!1,data:t.JSON.stringify(i),type:"post",contentType:"application/json",success:function(o){if(a.isInternal&&ee.attr("disabled",!1).html(MCK_LABELS["create.group.title"]),"object"==typeof o&&"success"===o.status){var i=o.response;if("object"==typeof i){var r=mckGroupUtils.addGroup(i);i.users.length>0&&e.each(i.users,function(e,a){D[a.userId]=a,a.connected?t.MCK_OL_MAP[a.userId]=!0:(t.MCK_OL_MAP[a.userId]=!1,void 0!==a.lastSeenAtTime&&(N[a.userId]=a.lastSeenAtTime)),pt.updateUnreadCount("user_"+a.userId,a.unreadCount,!1);var s=pt.getContact(""+a.userId);void 0===s?pt.createContactWithDetail(a):pt.updateContactDetail(s,a)}),a.tabId=r.contactId,a.isGroup=!0,a.isMessage?pt.loadTab(a,s.dispatchMessage):a.isInternal?(me.data("mck-id",r.contactId),me.data("isgroup",!0),dt.loadGroupInfo({groupId:r.contactId})):pt.loadTab(a),"function"==typeof a.callback&&(n.status="success",n.data=r,a.callback(n))}}else"error"===o.status&&"function"==typeof a.callback&&(n.status="error",n.errorMessage=o.errorResponse[0].description,a.callback(n))},error:function(){a.isInternal&&ee.attr("disabled",!1).html(MCK_LABELS["create.group.title"]),"function"==typeof a.callback&&(n.status="error",n.errorMessage="Unable to process request.",a.callback(n))}})},s.sendVideoCallMessage=function(e,t,a,o){var n="CALL_MISSED"==t?"Missed Call":"CALL_REJECTED"==t?"Call Rejected":"";""!=n&&void 0!=n||(n="video message");var r={to:i.val(),type:5,contentType:a,message:n,metadata:{MSG_TYPE:t,CALL_ID:e,CALL_AUDIO_ONLY:o},senderName:Ge};return s.sendMessage(r),r},s.sendVideoCallEndMessage=function(e,t,a,o,n){var r="";n&&(r=mckDateUtils.convertMilisIntoTime(n));var c="CALL_MISSED"==t?"Missed Call":"CALL_REJECTED"==t?"Call Rejected":"CALL_END"==t?"Call End \n Duration: "+r:"video message";""!=c&&void 0!=c||(c="video message");var l={to:i.val(),type:5,contentType:a,message:c,metadata:{MSG_TYPE:t,CALL_ID:e,CALL_AUDIO_ONLY:o,CALL_DURATION:n}};return s.sendMessage(l),l}}function c(){var s=this,o="",i=e("#mck-search"),n=e("#mck-msg-to"),r=e(".mck-file-lb"),c=e(".mck-file-sz"),l=e("#mck-sidebox"),d=e("#mck-file-box"),m=e("#mck-msg-sbmt"),p=e("#mck-msg-form"),u=e("#mck-text-box"),v=e("#mck-msg-error"),g=(e("#mck-show-more"),e("#mck-tab-title")),f=e("#mck-tab-status"),k=e("#mck-message-cell"),C=e(".mck-typing-box"),b=e("#mck-no-messages"),h=e("#mck-product-box"),y=e(".mck-product-icon"),I=e(".mck-product-title"),M=e(".mck-product-subtitle"),S=e("#mck-product-box .mck-caret"),L=e(".mck-product-rt-up .mck-product-key"),G=e("#mck-contact-search-input-box"),E=e(".mck-product-rt-up .mck-product-value"),w=e(".mck-product-rt-down .mck-product-key"),D=e(".mck-product-rt-down .mck-product-value"),P=(e("#li-mck-group-info"),e("#li-mck-leave-group"),e("#mck-group-info-tab")),j=e("#mck-group-search-tab"),F=e("#mck-no-search-groups"),z=e("#mck-group-create-tab"),$=e("#mck-group-search-list"),q=(e("#mck-group-search-tabview"),e(".mck-group-menu-options")),H=e(".mck-videocall-btn"),V=e("#mck-group-search-input"),J=e("#mck-group-search-input-box"),Z=e("#mck-contact-search-list"),Q=e("#mck-contacts-content"),ae=e("#mck-contact-search-tab"),oe=(e("#mck-contact-search-tabview"),e("#mck-contact-search-input")),ie=(e("#mck-search-list"),e("#mck-no-search-contacts")),re=e("#mck-search-tab-box li a"),le=e("#mck-search-tabview-box"),me=e("#mck-sidebox-search"),pe=e("#mck-contact-loading"),ue=e("#mck-typing-label"),ve=e("#mck-price-widget"),fe=e("#mck-msg-response"),ke=e("#mck_response_text"),he=e("#li-mck-block-user"),Ie=e("#li-mck-video-call"),Me=e("#mck-search-loading"),Se=e("#mck-tab-individual"),Te=e("#mck-attachfile-box"),xe=e("#mck-attachmenu-box"),Ee=e("#mck-sidebox-content"),Ae=e("#mck-tab-option-panel"),Oe=e("#mck-tab-conversation"),Ne=e("#mck-conversation-header"),Pe=e("#mck-no-conversations"),Re=e("#mck-conversation-list"),je=e(".mck-tab-message-option"),ze=e(".mck-box-ft .mck-box-form"),$e=e("#mck-btn-clear-messages"),qe=e("#mck-offline-message-box"),We=e("#mck-message-cell .mck-message-inner"),Ye=(e("#mck-msg-new"),"/rest/ws/aws/file/"),Ze=/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi,Xe=new RegExp(Ze),ct='<div name="message" data-msgdelivered="${msgDeliveredExpr}" data-msgsent="${msgSentExpr}" data-msgtype="${msgTypeExpr}" data-msgtime="${msgCreatedAtTime}" data-msgcontent="${replyIdExpr}" data-msgkey="${msgKeyExpr}" data-contact="${toExpr}" class="mck-m-b ${msgKeyExpr} ${msgFloatExpr} ${msgAvatorClassExpr}"><div class="mck-clear"><div class="blk-lg-12"><div class="mck-msg-avator blk-lg-3">{{html msgImgExpr}}</div><div class="mck-msg-box ${msgClassExpr}"><div class= "move-right mck-msg-text"></div><div class ="mck-msg-reply mck-verticalLine ${msgReplyToVisibleExpr}"><div class="mck-msgto">${msgReplyTo} </div></div><div class ="mck-msg-reply mck-verticalLine ${msgReplyDivExpr}"><div class="mck-msgreply-border ${textreplyVisExpr}">${msgReply}</div><div class="mck-msgreply-border ${msgpreviewvisExpr}">{{html msgPreview}}</div></div><div class="${nameTextExpr} ${showNameExpr}"><span class="mck-ol-status ${contOlExpr}"><span class="mck-ol-icon" title="${onlineLabel}"></span>&nbsp;</span>${msgNameExpr}</div><div class="mck-file-text notranslate mck-attachment downloadimage ${downloadIconVisibleExpr}" data-filemetakey="${fileMetaKeyExpr}" data-filename="${fileNameExpr}" data-fileurl= "${fileUrlExpr}" data-filesize="${fileSizeExpr}"><div>{{html fileExpr}}</div> {{html downloadMediaUrlExpr}}</div><div class="mck-msg-text mck-msg-content"></div></div></div><div class="${msgFloatExpr}-muted mck-text-light mck-text-muted mck-text-xs mck-t-xs">${createdAtTimeExpr} <span class="${statusIconExpr} mck-message-status"></span></div></div><div class="n-vis mck-context-menu"><ul><li><a class="mck-message-forward">${msgForwardExpr}</a></li><li><a class="mck-message-delete">${msgDeleteExpr}</a></li><li><a class="mck-message-reply">${msgReplyExpr}</a></li></ul></div></div>',kt='<li id="li-${contHtmlExpr}" class="${contIdExpr}" data-msg-time="${msgCreatedAtTimeExpr}"><a class="${mckLauncherExpr}" href="#" data-mck-conversationid="${conversationExpr}" data-mck-id="${contIdExpr}" data-isgroup="${contTabExpr}"><div class="mck-row" title="${contNameExpr}"><div class="mck-conversation-topic mck-truncate ${contHeaderExpr}">${titleExpr}</div><div class="blk-lg-3">{{html contImgExpr}}</div><div class="blk-lg-9"><div class="mck-row"><div class="blk-lg-8 mck-cont-name mck-truncate"><div class="mck-ol-status ${contOlExpr}"><span class="mck-ol-icon" title="${onlineLabel}"></span>&nbsp;</div><strong>${contNameExpr}</strong></div><div class="mck-text-muted move-right mck-cont-msg-date mck-truncate blk-lg-4">${msgCreatedDateExpr}</div></div><div class="mck-row"><div class="mck-cont-msg-wrapper blk-lg-6 mck-truncate msgTextExpr"></div><div class="mck-unread-count-box move-right mck-truncate ${contUnreadExpr}"><span class="mck-unread-count-text">{{html contUnreadCount}}</span></div></div></div></div></a></li>',Ct='<li id="li-${convIdExpr}" class="${convIdExpr}"><a class="${mckLauncherExpr}" href="#" data-mck-conversationid="${convIdExpr}" data-mck-id="${tabIdExpr}" data-isgroup="${isGroupExpr}" data-mck-topicid="${topicIdExpr}" data-isconvtab="true"><div class="mck-row mck-truncate" title="${convTitleExpr}">${convTitleExpr}</div></a></li>',bt='<li id="li-${contHtmlExpr}" class="${contIdExpr}"><a class="applozic-launcher" href="#" data-mck-id="${contIdExpr}" data-isgroup="${contTabExpr}"><div class="mck-row" title="${contNameExpr}"><div class="blk-lg-3">{{html contImgExpr}}</div><div class="blk-lg-9"><div class="mck-row"><div class="blk-lg-12 mck-cont-name mck-truncate"><strong>${contNameExpr}</strong><div class="move-right mck-group-count-box mck-group-count-text ${displayGroupUserCountExpr}">${groupUserCountExpr}</div></div><div class="blk-lg-12 mck-text-muted">${contLastSeenExpr}</div></div></div></div></a></li>';e.template("convTemplate",Ct),e.template("messageTemplate",ct),e.template("contactTemplate",kt),e.template("searchContactbox",bt),s.openConversation=function(){"none"===l.css("display")&&(e(".mckModal").mckModal("hide"),l.mckModal()),n.focus()},s.initEmojis=function(){try{e("#mck-text-box").emojiarea({button:"#mck-btn-smiley",wysiwyg:!0,menuPosition:"top"})}catch(e){o||(o=setTimeout(function(){s.initEmojis()},3e4))}},s.loadTab=function(a,o){var i=We.data("mck-id");if(i)if(u.html().length>1||d.hasClass("vis")){var r={text:u.html(),files:[]};d.hasClass("vis")&&e(".mck-file-box").each(function(){var t=e(this),a={filelb:t.find(".mck-file-lb").html(),filesize:t.find(".mck-file-sz").html()},s=t.data("mckfile");"object"==typeof s&&(a.fileMeta=s),r.files.push(a)}),at[i]=r}else delete at[i];if(A=!0,s.clearMessageField(!1),s.addDraftMessage(a.tabId),v.html(""),v.removeClass("vis").addClass("n-vis"),ke.html(""),fe.removeClass("vis").addClass("n-vis"),p[0].reset(),p.removeClass("n-vis").addClass("vis"),We.html(""),v.removeClass("mck-no-mb"),Q.removeClass("n-vis").addClass("vis"),ze.removeClass("vis").addClass("n-vis"),me.removeClass("vis").addClass("n-vis"),P.removeClass("vis").addClass("n-vis"),z.removeClass("vis").addClass("n-vis"),Ee.removeClass("n-vis").addClass("vis"),h.removeClass("vis").addClass("n-vis"),Ne.addClass("n-vis"),pe.removeClass("vis").addClass("n-vis"),We.removeClass("mck-group-inner"),f.removeClass("vis").addClass("n-vis"),g.removeClass("mck-tab-title-w-status"),g.removeClass("mck-tab-title-w-typing"),C.removeClass("vis").addClass("n-vis"),ue.html(MCK_LABELS.typing),We.data("isgroup",a.isGroup),We.data("datetime",""),a.tabId){if(n.val(a.tabId),We.data("mck-id",a.tabId),We.data("mck-conversationid",a.conversationId),We.data("mck-topicid",a.topicId),Ae.data("tabId",a.tabId),Ae.removeClass("n-vis").addClass("vis"),Q.removeClass("vis").addClass("n-vis"),ze.removeClass("n-vis").addClass("vis"),$e.removeClass("n-vis").addClass("vis"),q.removeClass("vis").addClass("n-vis"),a.isGroup?(We.addClass("mck-group-inner"),he.removeClass("vis").addClass("n-vis"),Ie.removeClass("vis").addClass("n-vis"),H.removeClass("vis").addClass("n-vis")):(he.removeClass("n-vis").addClass("vis"),Ie.removeClass("n-vis").addClass("vis"),ee&&H.removeClass("n-vis").addClass("vis")),!a.topicId&&a.conversationId){var c=K[a.conversationId];"object"==typeof c&&(a.topicId=c.topicId)}if(a.topicId){var l=O[a.topicId];"object"==typeof l&&(Be?(We.data("mck-title",l.title),Ne.html(l.title),Ne.removeClass("n-vis")):Ue&&(s.setProductProperties(l,a.topicId),S.addClass("n-vis"),h.addClass("mck-product-box-wc"),Re.addClass("n-vis"),h.removeClass("n-vis").addClass("vis")))}X&&t.google&&"object"==typeof t.google.maps?(Te.removeClass("vis").addClass("n-vis"),xe.removeClass("n-vis").addClass("vis")):(xe.removeClass("vis").addClass("n-vis"),Te.removeClass("n-vis").addClass("vis"));var m=s.getTabDisplayName(a.tabId,a.isGroup,a.userName);s.isGroupDeleted(a.tabId,a.isGroup)&&(v.html(MCK_LABELS["group.deleted"]),v.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),p.removeClass("vis").addClass("n-vis")),g.html(m),g.attr("title",m),Oe.removeClass("vis").addClass("n-vis"),le.removeClass("vis").addClass("n-vis"),Se.removeClass("n-vis").addClass("vis"),"support"===B&&e(".mck-tab-link").removeClass("vis").addClass("n-vis"),be&&(ve.removeClass("n-vis").addClass("vis"),We.addClass("mck-msg-w-panel")),W&&(v.html("Deactivated"),v.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),p.removeClass("vis").addClass("n-vis")),ht.subscibeToTypingChannel(a.tabId,a.isGroup),"function"==typeof de&&de({tabId:a.tabId,isGroup:a.isGroup})}else{a.tabId="",De&&pt.hideOfflineMessage(),Se.removeClass("vis").addClass("n-vis"),Oe.removeClass("n-vis").addClass("vis"),le.removeClass("n-vis").addClass("vis"),h.removeClass("vis").addClass("n-vis"),We.data("mck-id",""),We.data("mck-conversationid",""),We.data("mck-topicid",""),ve.removeClass("vis").addClass("n-vis"),We.removeClass("mck-msg-w-panel"),Ae.removeClass("vis").addClass("n-vis"),$e.removeClass("vis").addClass("n-vis"),n.val("");var k=Qe.getLatestMessageArray();if(ht.unsubscibeToTypingChannel(),null!==k&&k.length>0)return a.isReload=!0,pt.addContactsFromMessageList({message:k},a),s.openConversation(),void(A=!1)}ut.loadMessageList(a,o),s.openConversation()},s.setProductProperties=function(e,t){I.html(e.title),y.html(s.getTopicLink(e.link));var a=e.subtitle?e.subtitle:"";M.html(a);var o=e.key1?e.key1:"",i=e.value1?":"+e.value1:"";L.html(o),E.html(i);var n=e.key2?e.key2:"",r=e.value2?":"+e.value2:"";w.html(n),D.html(r),"function"==typeof se&&(e.topicId=t,se(e))},s.getTopicLink=function(e){return e?'<img src="'+e+'">':'<span class="mck-icon-no-image"></span>'},s.processMessageList=function(t,a,o){var i,n=We.children("div[name='message']:first"),r=We.data("mck-id"),c=We.data("isgroup")?mckGroupUtils.getGroup(r):pt.fetchContact(r);if(void 0===t.message.length){var l=[];l.push(t.message),Qe.updateMckMessageArray(l),s.addMessage(t.message,c,!1,!1,o),i=t.createdAtTime}else Qe.updateMckMessageArray(t.message),e.each(t.message,function(e,t){void 0!==t.to&&(s.addMessage(t,c,!1,!1,o),i=t.createdAtTime)});Ae.data("datetime",i),!a&&n.length>0?We.scrollTop(n.offset().top-We.offset().top+We.scrollTop()):a&&We.animate({scrollTop:We.prop("scrollHeight")},"fast")},s.closeConversation=function(e){if("function"==typeof ne){var t=ne();if("object"==typeof t)var a="BUSY_WITH_OTHER"===e?t.onBusyWithOtherUser:t.onConversationClose}a||(a="Chat disabled with user"),v.html(a),v.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),p.removeClass("vis").addClass("n-vis")},s.addTooltip=function(t){e("."+t+" .mck-icon-time").attr("title","pending"),e("."+t+" .mck-btn-trash").attr("title","delete"),e("."+t+" .mck-icon-sent").attr("title","sent"),e("."+t+" .mck-btn-forward").attr("title","forward message"),e("."+t+" .mck-icon-delivered").attr("title","delivered"),e("."+t+" .mck-icon-read").attr("title","delivered and read"),e("."+t+" .msgtype-outbox-cr").attr("title","sent via Carrier"),e("."+t+" .msgtype-outbox-mck").attr("title","sent"),e("."+t+" .msgtype-inbox-cr").attr("title","received via Carrier"),e("."+t+" .msgtype-inbox-mck").attr("title","recieved")},s.fetchContact=function(e){var t=s.getContact(e);return void 0===t&&(t=s.createContact(e)),t},s.getContact=function(e){return"object"==typeof x[e]?x[e]:void 0},s.getContactDisplayName=function(e){return"string"==typeof st[e]?st[e]:void 0},s.addMessage=function(o,i,n,r,c){var l="",d="",m="",p="vis",u="n-vis",v="",g="n-vis";if("object"==typeof o.metadata&&void 0!==o.metadata.AL_REPLY&&(l=o.metadata.AL_REPLY,void 0!==(d=ut.getReplyMessageByKey(l))&&((i.isGroup&&d||!i.isGroup&&void 0===d.fileMeta)&&(g="vis"),v=5===d.type?"You":pt.getTabDisplayName(d.to,!1),"object"!=typeof d.fileMeta&&2!==d.contentType||(m=s.getImageForReplyMessage(d),p="n-vis",u="vis",g="n-vis"))),6!==o.type&&7!==o.type&&!(o.metadata&&"HIDDEN"===o.metadata.category||102===o.contentType||10===o.contentType&&o.metadata&&"true"===o.metadata.hide||e("#mck-message-cell ."+o.key).length>0)){b.hasClass("vis")&&b.removeClass("vis").addClass("n-vis");var f="",k="mck-msg-right",C="mck-icon-time",h="vis";0!==o.type&&4!==o.type&&6!==o.type||(k="mck-msg-left"),4!==o.contentType&&10!==o.contentType&&103!==o.contentType||(k="mck-msg-center"),C=s.getStatusIconName(o);var y=o.key,I="'"+o.deviceKey+"','"+o.to+"','"+o.to+"','"+y+"'",M="",S="",T="",L="n-vis",x="";if(vt.loadUserProfile(o.to),!o.groupId||4===o.contentType||7===i.type||0!==o.type&&4!==o.type&&6!==o.type||(M=s.getTabDisplayName(o.to,!1),L="vis",T=s.getNameTextClassByAlphabet(M)),we){x="mck-msg-avator-bubble";var G="",E=M;"mck-msg-right"===k?(G=pt.fetchContact(Ge),E=s.getTabDisplayName(G.displayName,!1)):"mck-msg-left"===k&&(G=o.groupId?pt.fetchContact(o.to):i),G&&(S=s.getContactImageLink(G,E))}o.groupId&&10===o.contentType&&(M="",S="",T="");var A="n-vis",U="n-vis",_="",w="",D=o.message;"object"==typeof o.fileMeta&&(_=o.fileMeta.name,w=o.fileMeta.size),"object"==typeof o.fileMeta&&(o.fileMeta.contentType.indexOf("audio")||o.fileMeta.contentType.indexOf("image")||o.fileMeta.contentType.indexOf("video"))&&(A="vis");var N="n-vis";_e&&t.MCK_OL_MAP[o.to]&&10!==o.contentType&&(N="vis");var P=[{msgReply:d?d.message+"\n":"",msgReplyTo:d?v+"\n":"",msgReplyDivExpr:d?"vis":"n-vis",msgReplyToVisibleExpr:g,msgPreview:m?s.getImageForReplyMessage(d):"",msgpreviewvisExpr:u,textreplyVisExpr:p,msgKeyExpr:o.key,msgDeliveredExpr:o.delivered,msgSentExpr:o.sent,msgCreatedAtTime:o.createdAtTime,msgTypeExpr:o.type,msgDeleteExpr:MCK_LABELS.delete,msgReplyExpr:MCK_LABELS.reply,msgForwardExpr:MCK_LABELS.forward,msgSourceExpr:o.source,statusIconExpr:C,contactExpr:h,toExpr:o.to,msgAvatorClassExpr:x,showNameExpr:L,msgNameExpr:M,msgImgExpr:S,nameTextExpr:T,msgFloatExpr:k,replyIdExpr:y,createdAtTimeExpr:mckDateUtils.getDate(o.createdAtTime),msgFeatExpr:U,replyMessageParametersExpr:I,downloadMediaUrlExpr:s.getFileAttachment(o),msgClassExpr:f,msgExpr:D,selfDestructTimeExpr:o.timeToLive,fileMetaKeyExpr:o.fileMetaKey,downloadIconVisibleExpr:A,fileExpr:s.getFilePath(o),fileUrlExpr:s.getFileurl(o),fileNameExpr:_,fileSizeExpr:w,contOlExpr:N}];n?e.tmpl("messageTemplate",P).appendTo("#mck-message-cell .mck-message-inner"):e.tmpl("messageTemplate",P).prependTo("#mck-message-cell .mck-message-inner");var R="";if(o.message){var B=o.message.replace(/\n/g,"<br/>");null!==t.emoji&&void 0!==t.emoji?(R=t.emoji.replace_unified(B),R=t.emoji.replace_colons(R)):R=B}if(o.conversationId){var j=K[o.conversationId];if("object"!=typeof j&&ut.getTopicId({conversationId:o.conversationId}),n&&(We.data("mck-conversationid",o.conversationId),j)){var F=O[j.topicId];"object"==typeof F&&(Ue?s.setProductProperties(F,j.topicId):Be&&Ne.html(F.title))}}if(4===o.contentType){var z=R;R="Final agreed price: "+R,be||(R+='<br/><button class="mck-accept" data-mck-topic-price="'+z+'" data-mck-conversationid="'+o.conversationId+'">Accept</button>')}var $=e("."+y+" .mck-msg-content");if(-1===R.indexOf("emoji-inner")&&0===o.contentType)for(var q=R.split("<br/>"),H=0;H<q.length;H++){var V=a.createElement("div");V.appendChild(a.createTextNode(q[H])),q[H]&&q[H].match(Xe)&&(V=e(V).linkify({target:"_blank"})),$.append(V)}else $.html(R),$.linkify({target:"_blank"});o.fileMeta&&(e("."+y+" .mck-file-text a:first").trigger("click"),e("."+y+" .mck-file-text").removeClass("n-vis").addClass("vis"),""===$.html()&&$.removeClass("vis").addClass("n-vis")),2===o.contentType&&($.removeClass("vis").addClass("n-vis"),e("."+y+" .mck-file-text").removeClass("n-vis").addClass("vis")),r&&We.animate({scrollTop:We.prop("scrollHeight")},"fast"),je.hasClass("n-vis")&&(o.groupId?6!==mckGroupUtils.getGroup(o.groupId).type&&je.removeClass("n-vis").addClass("vis"):je.removeClass("n-vis").addClass("vis")),s.addTooltip(o.key),4!==o.contentType&&10!==o.contentType&&c&&s.messageContextMenu(o.key),o.groupId&&10===o.contentType&&n&&mckGroupService.getGroupFeed({groupId:o.groupId,isReloadTab:!0,apzCallback:dt.onGroupFeed})}},s.addContactForSearchList=function(a,o){var i=a.userCount,n=a.isGroup,r=s.getTabDisplayName(a.contactId,n),c=s.getContactImageLink(a,r),l=(n?a.contactId:a.contactId,n?"gs-group-"+a.htmlId:"cs-user-"+a.htmlId),d="",m=n&&Ke;e("#li-"+l+" .mck-group-count-text").html(i),n||U[a.contactId]||(t.MCK_OL_MAP[a.contactId]?d=MCK_LABELS.online:N[a.contactId]&&(d=mckDateUtils.getLastSeenAtStatus(N[a.contactId])));var p=[{contHtmlExpr:l,contIdExpr:a.contactId,contTabExpr:a.isGroup,contImgExpr:c,contLastSeenExpr:d,contNameExpr:r,groupUserCountExpr:a.userCount,displayGroupUserCountExpr:m?"vis":"n-vis"}];e.tmpl("searchContactbox",p).prependTo("#"+o)},s.getFileurl=function(e){return"object"==typeof e.fileMeta?te+Ye+e.fileMeta.blobKey:""},s.getFilePath=function(t){if(2===t.contentType)try{var a=e.parseJSON(t.message);if(a.lat&&a.lon)return'<a href="http://maps.google.com/maps?z=17&t=m&q=loc:'+a.lat+","+a.lon+'" target="_blank"><img src="https://maps.googleapis.com/maps/api/staticmap?zoom=17&size=200x150&center='+a.lat+","+a.lon+"&maptype=roadmap&markers=color:red|"+a.lat+","+a.lon+"&key="+Le+'"/></a>'}catch(e){if(-1!==t.message.indexOf(","))return'<a href="http://maps.google.com/maps?z=17&t=m&q=loc:'+t.message+'" target="_blank"><img src="https://maps.googleapis.com/maps/api/staticmap?zoom=17&size=200x150&center='+t.message+"&maptype=roadmap&markers=color:red|"+t.message+"&key="+Le+'" /></a>'}return"object"==typeof t.fileMeta?-1!==t.fileMeta.contentType.indexOf("image")?-1!==t.fileMeta.contentType.indexOf("svg")?'<a href="#" role="link" class="file-preview-link fancybox-media fancybox" data-type="'+t.fileMeta.contentType+'" data-url="'+te+Ye+t.fileMeta.blobKey+'" data-name="'+t.fileMeta.name+'"><img src="'+te+Ye+t.fileMeta.blobKey+'" area-hidden="true"></img></a>':5===t.contentType?'<a href="#" role="link" class="file-preview-link fancybox-media fancybox" data-type="'+t.fileMeta.contentType+'" data-url="'+t.fileMeta.blobKey+'" data-name="'+t.fileMeta.name+'"><img src="'+t.fileMeta.blobKey+'" area-hidden="true"></img></a>':'<a href="#" role="link" class="file-preview-link fancybox-media fancybox" data-type="'+t.fileMeta.contentType+'" data-url="'+te+Ye+t.fileMeta.blobKey+'" data-name="'+t.fileMeta.name+'"><img src="'+t.fileMeta.thumbnailUrl+'" area-hidden="true" ></img></a>':-1!==t.fileMeta.contentType.indexOf("video")?'<a href= "#" ><video controls class="mck-video-player"><source src="'+te+Ye+t.fileMeta.blobKey+'" type="video/mp4"><source src="'+te+Ye+t.fileMeta.blobKey+'" type="video/ogg"></video></a>':-1!==t.fileMeta.contentType.indexOf("audio")?'<a href="#"><audio controls class="mck-audio-player"><source src="'+te+Ye+t.fileMeta.blobKey+'" type="audio/ogg"><source src="'+te+Ye+t.fileMeta.blobKey+'" type="audio/mpeg"></audio><p class="mck-file-tag"></p></a>':'<a href="#" role="link" class="file-preview-link" target="_blank"></a>':""},s.getImageForMessagePreview=function(t){if("object"==typeof t.fileMeta)return-1!==t.fileMeta.contentType.indexOf("image")?'<span>photo</span> <img src="'+te+Ye+t.fileMeta.blobKey+'" class="mck-image-reply move-right"/>':-1!==t.fileMeta.contentType.indexOf("audio")?'<span>audio</span><span class="mck-file-detail move-right"><span class="mck-file-name"><span class="mck-icon-attachment"></span>&nbsp;'+t.fileMeta.name+'</span>&nbsp;<span class="file-size">'+mt.getFilePreviewSize(t.fileMeta.size)+"</span></span>":'<span class="mck-file-detail move-right"><span class="mck-file-name"><span class="mck-icon-attachment"></span>&nbsp;'+t.fileMeta.name+'</span>&nbsp;<span class="file-size">'+mt.getFilePreviewSize(t.fileMeta.size)+"</span></span>";if(2===t.contentType){var a=e.parseJSON(t.message);return'<span>location</span><img src="https://maps.googleapis.com/maps/api/staticmap?zoom=17&size=200x150&center='+a.lat+","+a.lon+"&maptype=roadmap&markers=color:red|"+a.lat+","+a.lon+'" class="mck-image-reply move-right"/>'}},s.getImageForReplyMessage=function(t){var a=pt.getTabDisplayName(t.to,!1);if("object"==typeof t.fileMeta)return-1!==t.fileMeta.contentType.indexOf("image")?'<div><div class="mck-imagereply mck-margin"><div class="mck-msgto">'+a+'</div><div><span class="mck-icon-camera mck-camera"></span><span>Photo</span></div></div><div class="mck-imagereply"><img src="'+te+Ye+t.fileMeta.blobKey+'" class="mck-image-reply mck-msg-text mck-msg-content"/></div></div>':-1!==t.fileMeta.contentType.indexOf("audio")?'<div class="mck-attachmentmsgto">'+a+'</div><span class="mck-file-detail mck-msg-text mck-msg-content"><span class="mck-file-name"><span class="mck-icon-attachment"></span>&nbsp;'+t.fileMeta.name+'</span>&nbsp;<span class="file-size">'+mt.getFilePreviewSize(t.fileMeta.size)+"</span></span>":'<div class="mck-attachmentmsgto">'+a+'</div><span class="mck-file-detail"><span class="mck-file-name"><span class="mck-icon-attachment"></span>&nbsp;'+t.fileMeta.name+'</span>&nbsp;<span class="file-size">'+mt.getFilePreviewSize(t.fileMeta.size)+"</span></span>";if(2===t.contentType){var s=e.parseJSON(t.message);return'<div><div class="mck-imagereply mck-margin"><div class="mck-msgto">'+a+'</div><span class="mck-icon-marker mck-location-icon"></span><span>Location</span></div><div class="mck-imagereply"><img src="https://maps.googleapis.com/maps/api/staticmap?zoom=17&size=200x150&center='+s.lat+","+s.lon+"&maptype=roadmap&markers=color:red|"+s.lat+","+s.lon+'" class="mck-image-reply mck-msg-text "/></div></div>'}},s.getFileAttachment=function(e){if("object"==typeof e.fileMeta)return-1!==e.fileMeta.contentType.indexOf("image")||-1!==e.fileMeta.contentType.indexOf("audio")||e.fileMeta.contentType.indexOf("video"),'<a href="'+te+Ye+e.fileMeta.blobKey+'" role="link" class="file-preview-link"><span class="file-detail mck-image-download"><span class="mck-file-name"><span class="mck-icon-attachment"></span>&nbsp;'+e.fileMeta.name+'</span>&nbsp;<span class="file-size">'+mt.getFilePreviewSize(e.fileMeta.size)+"</span></span></a>"},s.getFileIcon=function(e){return e.fileMetaKey&&"object"==typeof e.fileMeta?-1!==e.fileMeta.contentType.indexOf("image")?'<span class="mck-icon-camera"></span>&nbsp;<span>Image</span>':-1!==e.fileMeta.contentType.indexOf("audio")?'<span class="mck-icon-attachment"></span>&nbsp;<span>Audio</span>':-1!==e.fileMeta.contentType.indexOf("video")?'<span class="mck-icon-attachment"></span>&nbsp;<span>Video</span>':'<span class="mck-icon-attachment"></span>&nbsp;<span>File</span>':""},s.getContactFromGroupOfTwo=function(e){for(var t=0;t<e.members.length;t++)if(Ge!==""+e.members[t])return pt.fetchContact(""+e.members[t])},s.getContactImageLink=function(e,t){var a="";if(e.isGroup&&7!==e.type)a=dt.getGroupImage(e.imageUrl);else{if(e.isGroup&&7===e.type&&e.members.length>1&&(e=s.getContactFromGroupOfTwo(e)),"function"==typeof Ce){var o=Ce(e.contactId);o&&void 0!==o&&(a='<img src="'+o+'"/>')}a||(e.photoSrc?a='<img src="'+e.photoSrc+'"/>':e.photoData?a='<img src="data:image/jpeg;base64,'+e.photoData+'"/>':e.photoLink?a='<img src="'+MCK_BASE_URL+"/contact.image?photoLink="+e.photoLink+'"/>':(t||(t=e.displayName),a=s.getContactImageByAlphabet(t)))}return a},s.getContactImageByAlphabet=function(e){if(void 0===e||""===e)return'<div class="mck-alpha-contact-image mck-alpha-user"><span class="mck-icon-user"></span></div>';var t=e.charAt(0),a=/^[a-zA-Z]+$/;return t.match(a)?'<div class="mck-videocall-image alpha_'+(t=t.toUpperCase())+'"><span class="mck-contact-icon">'+t+"</span></div>":'<div class="mck-videocall-image alpha_user"><span class="mck-icon-user"></span></div>'},s.getNameTextClassByAlphabet=function(e){if(void 0===e||""===e)return"mck-text-user";var t=(e=e.toString()).charAt(0),a=/^[a-zA-Z]+$/;return t.match(a)?"mck-text-"+(t=t.toLowerCase()):"mck-text-user"},s.addContactsFromMessageList=function(t,a){var o;if(b.removeClass("vis").addClass("n-vis"),t+""!="null"){if(Pe.removeClass("vis").addClass("n-vis"),0==We.has(e("#mck-contact-list")).length&&We.html('<ul id="mck-contact-list" class="mck-contact-list mck-nav mck-nav-tabs mck-nav-stacked"></ul>'),void 0===t.message.length?(t.message.groupId?s.addGroupFromMessage(t.message):s.addContactsFromMessage(t.message),o=t.message.createdAtTime):e.each(t.message,function(e,t){void 0!==t.to&&(t.groupId?s.addGroupFromMessage(t,!0):s.addContactsFromMessage(t,!0),o=t.createdAtTime)}),We.data("datetime",o),a.isReload){var i="";if(a.lastActiveTabId){var n=a.isLastActiveTabGroup?"group-"+a.lastActiveTabId:"user-"+mckContactUtils.formatContactId(a.lastActiveTabId);i=e("#li-"+n)}i.length>0?We.animate({scrollTop:i.offset().top-We.offset().top+We.scrollTop()},"fast"):We.animate({scrollTop:0},0)}}else o=""},s.addGroupFromMessageList=function(t,a){t+""!="null"&&(a&&We.html('<ul id="mck-group-list" class="mck-contact-list mck-nav mck-nav-tabs mck-nav-stacked"></ul>'),void 0===t.message.length?s.addGroupFromMessage(t.message):e.each(t.message,function(e,t){void 0!==t.to&&s.addGroupFromMessage(t,!0)}))},s.createContact=function(e){var t=s.getContactDisplayName(e);void 0===t&&(t=e);var a={contactId:e,htmlId:mckContactUtils.formatContactId(e),displayName:t,name:t+" <"+e+"> [Main]",value:e,photoLink:"",photoSrc:"",photoData:"",email:"",unsaved:!0,isGroup:!1};return x[e]=a,a},s.createContactWithDetail=function(e){var t=e.displayName,a=e.userId;t||(t=s.getContactDisplayName(a)),void 0===t?t=a:st[a]=t;var o=e.photoLink?e.photoLink:"";o||(o=e.imageLink?e.imageLink:"");var i=e.imageData?e.imageData:"",n={contactId:a,htmlId:mckContactUtils.formatContactId(a),displayName:t,name:t+" <"+a+"> [Main]",value:a,photoLink:"",photoSrc:o,photoData:i,email:"",unsaved:!0,isGroup:!1};return x[a]=n,n},s.updateContactDetail=function(e,t){var a=t.displayName,o=t.userId;e.displayName&&e.displayName!==e.contactId||(a||(a=s.getContactDisplayName(o)),void 0===a?a=o:st[o]=a,e.displayName=a);var i=t.photoLink;i||(i=t.imageLink?t.imageLink:""),i&&!e.photoSrc&&(e.photoSrc=i);var n=t.imageData?t.imageData:"";return n&&!e.photoData&&(e.photoData=n),x[o]=e,e},s.addContactsFromMessage=function(e,t){var a=s.getUserIdFromMessage(e);if(a.length>0&&a[0])for(var o=0;o<a.length;o++){var i=s.fetchContact(""+a[o]);s.updateRecentConversationList(i,e,t)}},s.addGroupFromMessage=function(e,t){var a=e.groupId,o=mckGroupUtils.getGroup(""+a);void 0===o&&(o=mckGroupUtils.createGroup(a),mckGroupService.loadGroups({apzCallback:dt.loadGroups})),s.updateRecentConversationList(o,e,t)},s.updateRecentConversationList=function(t,a,o){var i="mck-contact-list",n=t.isGroup?"group-"+t.htmlId:"user-"+t.htmlId;e("#"+i+" #li-"+n).length>0?(e("#"+i+" #li-"+t.htmlId+" .mck-cont-msg-wrapper").is(":empty")||o)&&void 0!==a&&s.updateContact(t,a,i):s.addContact(t,i,a)},s.addContactsToSearchList=function(){var t=[],a=[];e.each(tt,function(e,t){a.push(t.contactId)});var o=a.filter(function(e,t){return a.indexOf(e)===t});o.sort(),Me.removeClass("vis").addClass("n-vis"),o.length>0?e.each(o,function(a,o){if(o){var i=s.fetchContact(""+o);t.push(i),0===e("#li-cs-user-"+i.htmlId).length&&s.addContactForSearchList(i,"mck-contact-search-list")}}):ie.removeClass("n-vis").addClass("vis"),s.initAutoSuggest({contactsArray:t,$searchId:oe,isContactSearch:!0})},s.initAutoSuggest=function(t){for(var a,o=t.contactsArray,i=t.$searchId,n=[],r={},c=[],l=0;l<o.length;l++){var d=o[l];d.displayName=s.getTabDisplayName(d.contactId,d.isGroup),a=d.displayName?e.trim(d.displayName):e.trim(d.contactId),r[a]=d,n.push(a),c.push(a)}var m=function(e){var t=r[e],a=t.displayName.split(" "),s=a.length,o=a[0],i="",n="";2===s?n=a[1]:s>=3&&(n=a[s-1],i=a[s-2]);var c=new RegExp(this.query,"i");return c.test(t.displayName)||c.test(t.contactId)||c.test(i)||c.test(n)||c.test(t.email)||c.test(o+" "+n)},p=function(e){return r[e].displayName},u=function(e){var a=r[e];t.isContactSearch?(pt.loadTab({tabId:a.contactId,isGroup:a.isGroup}),ze.removeClass("n-vis").addClass("vis")):dt.addGroupMemberFromSearch(a.contactId)};if(i.hasClass("mck-typeahead"))return i.mcktypeahead().data("mcktypeahead").source=n,i.mcktypeahead().data("mcktypeahead").matcher=m,i.mcktypeahead().data("mcktypeahead").highlighter=p,void(i.mcktypeahead().data("mcktypeahead").updater=u);i.addClass("mck-typeahead"),i.mcktypeahead({source:n,matcher:m,highlighter:p,updater:u})},s.initSearchAutoType=function(){He&&(oe.keypress(function(e){if(13===e.which){var t=oe.val();t&&(t=void 0!==t&&""!==t?t.toString():"")&&(pt.loadTab({tabId:t,isGroup:!1,isSearch:!0}),ze.removeClass("n-vis").addClass("vis")),oe.val("")}}),V.keypress(function(e){if(13===e.which)return!0}),e(a).on("click",".mck-group-search-link",function(e){return e.preventDefault(),!0}),e(a).on("click",".mck-contact-search-link",function(e){e.preventDefault();var t=oe.val();""!==t&&(pt.loadTab({tabId:t,isGroup:!1,isSearch:!0}),ze.removeClass("n-vis").addClass("vis")),oe.val("")}))},s.removeContact=function(t){var a=t.isGroup?"group-"+t.htmlId:"user-"+t.htmlId;e("#li-"+a).remove()},s.updateContact=function(t,a,o){var i=t.isGroup?"group-"+t.htmlId:"user-"+t.htmlId,n=e("#li-"+i),r=n.data("msg-time");if(a&&a.createdAtTime>r){var c=a.groupId?"group_"+t.contactId:"user_"+t.contactId,l=s.getUnreadCount(c),d=s.getMessageTextForContactPreview(a,t,15);e("#li-"+i+" .mck-cont-msg-date").html(void 0===a.createdAtTime?"":mckDateUtils.getTimeOrDate(a?a.createdAtTime:"",!0));var m=e("#li-"+i+" .mck-cont-msg-wrapper");if(m.html(""),"object"==typeof d?m.append(d):m.html(d),a.conversationId){var p=a.conversationId,u=K[p];if("object"==typeof u){var v=u.topicId;if(v&&Be){var g=O[v];"object"==typeof g&&e("#li-"+i+" .mck-conversation-topic").html(g.title)}}e("#li-"+i+" a").data("mck-conversationid",p)}l>0&&(e("#li-"+i+" .mck-unread-count-text").html(l),e("#li-"+i+" .mck-unread-count-box").removeClass("n-vis").addClass("vis"));var f=e("#"+o+" li:nth-child(1)").data("msg-time");n.data("msg-time",a.createdAtTime),(void 0===f||(a?a.createdAtTime:"")>=f)&&0!==e("#mck-contact-list li").index(n)&&e("#"+o+" li:nth-child(1)").before(n)}},s.clearContactMessageData=function(t,a){var s=mckContactUtils.formatContactId(t),o=a?"group-"+s:"user-"+s;e("#li-"+o+" .mck-cont-msg-date").html(""),e("#li-"+o+" .mck-cont-msg-wrapper").html("")},s.addContact=function(a,o,i){var n=s.getMessageTextForContactPreview(i,a,100),r=a.userCount,c="",l=!1;if(void 0!==i){if(i.conversationId){c=i.conversationId;var d=K[c]}i.groupId&&(l=!0)}var m=s.getTabDisplayName(a.contactId,l),p=s.getContactImageLink(a,m),u=!1,v=l?"group_"+a.contactId:"user_"+a.contactId,g=s.getUnreadCount(v),f=g>0&&"mck-search-list"!==o?"vis":"n-vis",k="n-vis",C=l?"group-"+a.htmlId:"user-"+a.htmlId,b=l&&Ke;if(e("#li-"+C+" .mck-group-count-text").html(r),e("#li-"+C+" .mck-group-count-box").removeClass("n-vis").addClass("vis"),l||U[a.contactId]||_[a.contactId]||!_e||!t.MCK_OL_MAP[a.contactId]||(k="vis",u=!0),7===a.type&&a.members.length>1){var h=mckGroupUtils.getGroup(i.groupId),y=pt.getContactFromGroupOfTwo(h);l&&_e&&t.MCK_OL_MAP[y.contactId]&&(k="vis",u=!0)}var I="n-vis";if("object"==typeof d&&Be){var M=O[d.topicId];if("object"==typeof M){I="vis";var S=M.title}}var T=[{contHtmlExpr:C=l?"group-"+a.htmlId:"user-"+a.htmlId,contIdExpr:a.contactId,contTabExpr:l,msgCreatedAtTimeExpr:i?i.createdAtTime:"",mckLauncherExpr:Y,contImgExpr:p,contOlExpr:k,onlineLabel:MCK_LABELS.online,contUnreadExpr:f,contUnreadCount:g,contNameExpr:m,conversationExpr:c,contHeaderExpr:I,titleExpr:S,groupUserCountExpr:l?a.userCount:"",displayGroupUserCountExpr:b?"vis":"n-vis",msgCreatedDateExpr:i?mckDateUtils.getTimeOrDate(i.createdAtTime,!0):""}],L=e("#"+o+" li:nth-child(1)").data("msg-time");void 0===L||(i?i.createdAtTime:"")>=L||-1!==o.indexOf("search")&&u?e.tmpl("contactTemplate",T).prependTo("#"+o):e.tmpl("contactTemplate",T).appendTo("#"+o);var x=e("#li-"+C+" .msgTextExpr");"object"==typeof n?x.append(n):x.html(n)},s.addContactsToContactSearchList=function(){ie.removeClass("vis").addClass("n-vis"),F.removeClass("vis").addClass("n-vis"),ae.hasClass("active")||(re.removeClass("active"),ae.addClass("active")),$.removeClass("vis").addClass("n-vis"),Z.removeClass("n-vis").addClass("vis"),J.removeClass("vis").addClass("n-vis"),G.removeClass("n-vis").addClass("vis"),Z.html(""),Q.removeClass("vis").addClass("n-vis"),Ee.removeClass("vis").addClass("n-vis"),P.removeClass("vis").addClass("n-vis"),z.removeClass("vis").addClass("n-vis"),me.removeClass("n-vis").addClass("vis"),Me.removeClass("n-vis").addClass("vis"),0!==tt.length?pt.addContactsToSearchList():Fe?(Me.removeClass("vis").addClass("n-vis"),ie.removeClass("n-vis").addClass("vis")):vt.loadContacts(),oe.focus()},s.addGroupsToGroupSearchList=function(){var t=[],a=[];if(ie.removeClass("vis").addClass("n-vis"),F.removeClass("vis").addClass("n-vis"),j.hasClass("active")||(re.removeClass("active"),j.addClass("active")),Z.removeClass("vis").addClass("n-vis"),$.removeClass("n-vis").addClass("vis"),G.removeClass("vis").addClass("n-vis"),J.removeClass("n-vis").addClass("vis"),$.html(""),Q.removeClass("vis").addClass("n-vis"),Ee.removeClass("vis").addClass("n-vis"),P.removeClass("vis").addClass("n-vis"),z.removeClass("vis").addClass("n-vis"),me.removeClass("n-vis").addClass("vis"),Me.removeClass("n-vis").addClass("vis"),et.length>0){e.each(et,function(e,t){a.push(t.contactId)});var o=a.filter(function(e,t){return a.indexOf(e)===t});o.sort(),e.each(o,function(a,o){if(o){var i=mckGroupUtils.getGroup(""+o);t.push(i),0===e("#li-gs-group-"+i.htmlId).length&&s.addContactForSearchList(i,"mck-group-search-list")}})}else F.removeClass("n-vis").addClass("vis");s.initAutoSuggest({contactsArray:t,$searchId:V,isContactSearch:!0}),Me.removeClass("vis").addClass("n-vis")},s.addConversationMenu=function(t,a){var s=We.data("mck-id");if(Re.html(""),t===s){var o=nt[t];if(void 0===o||0===o.length||1===o.length)return S.addClass("n-vis"),h.addClass("mck-product-box-wc"),void Re.addClass("n-vis");Re.removeClass("n-vis"),S.removeClass("n-vis"),h.removeClass("mck-product-box-wc"),e.each(o,function(s,o){if(0===e("#mck-conversation-list #li-"+o.id).length){var i="";if(o.topicDetail){var n=e.parseJSON(o.topicDetail);i="object"==typeof n?n.title:o.topicDetail}i||(i=o.topicId);var r=[{convIdExpr:o.id,tabIdExpr:t,isGroupExpr:a,topicIdExpr:o.topicId,convTitleExpr:i,mckLauncherExpr:Y}];e.tmpl("convTemplate",r).appendTo(Re)}}),e("#mck-conversation-list li").length<2&&(S.addClass("n-vis"),h.addClass("mck-product-box-wc"),Re.addClass("n-vis"))}},s.loadContacts=function(t){t+""!="null"&&void 0!==t&&void 0!==t.contacts&&0!==t.contacts.length&&(tt.length=0,it.length=0,e.each(t.contacts,function(e,t){if(void 0!==t.userId){var a=s.getContact(""+t.userId);a=void 0===a?s.createContactWithDetail(t):s.updateContactDetail(a,t),tt.push(a),it.push(a.contactId)}}))},s.getStatusIcon=function(e){return'<span class="'+s.getStatusIconName(e)+" move-right "+e.key+'_status status-icon"></span>'},s.getStatusIconName=function(e){return 7===e.type||6===e.type||4===e.type||0===e.type?"":5===e.status?"mck-icon-read":4===e.status?"mck-icon-delivered":3===e.type||5===e.type||1===e.type&&(0===e.source||1===e.source)?"mck-icon-sent":""},s.clearMessageField=function(e){u.html(""),m.attr("disabled",!1),d.removeClass("vis").removeClass("mck-text-req").addClass("n-vis").attr("required","").html(""),e?u.focus().select():(i.blur(),u.blur())},s.addDraftMessage=function(t){if(T=[],t&&"object"==typeof at[t]){var a=at[t];u.html(a.text),a.files.length>0&&(e.each(a.files,function(e,t){mt.addFileBox(t)}),r.html(a.filelb),c.html(a.filesize),d.removeClass("n-vis").removeClass("mck-text-req").addClass("vis").removeAttr("required"))}else T=[]},s.showOfflineMessage=function(){"object"==typeof ye&&ye.innerHTML?(qe.html(ye.innerHTML),qe.removeClass("n-vis").addClass("vis")):t.console.log("Offline message innerHTML required.")},s.hideOfflineMessage=function(){rt.stopOfflineMessageCounter(),qe.removeClass("vis").addClass("n-vis")},s.removeConversationThread=function(t,a){Qe.clearMckMessageArray();var s=a?mckGroupUtils.getGroup(t):pt.getContact(t),o=We.data("mck-id"),i=We.data("isgroup");if(void 0===o||""===o){var n=void 0!==s?s.htmlId:mckContactUtils.formatContactId(t);e("#li-"+(a?"group-"+n:"user-"+n)).remove()}else o===t&&i===a&&(Ae.data("datetime",""),b.removeClass("n-vis").addClass("vis"),k.removeClass("n-vis").addClass("vis"),je.removeClass("vis").addClass("n-vis"))},s.removedDeletedMessage=function(t,a,s){Qe.clearMckMessageArray();var o=e("."+t);o.length>0?(o.remove(),We.is(":empty")&&(k.removeClass("n-vis").addClass("vis"),je.removeClass("vis").addClass("n-vis"))):void 0!==a&&e("#mck-contact-list").length>0&&ut.updateContactList(a,s)},s.getMessageTextForContactPreview=function(e,s,o){var i="";if(void 0!==e){if(e.message)if(2===e.contentType)i='<span class="mck-icon-marker"></span>';else{var n=e.message;if(mckUtils.startsWith(n,"<img"))return'<span class="mck-icon-camera"></span>&nbsp;<span>image</span>';null!==t.emoji&&void 0!==t.emoji?(i=t.emoji.replace_unified(n),i=-1!==(i=t.emoji.replace_colons(i)).indexOf("</span>")?i.substring(0,i.lastIndexOf("</span>")):i.substring(0,o)):i=n,s.isGroup||-1===i.indexOf("emoji-inner")&&0===e.contentType&&((c=a.createElement("p")).appendChild(a.createTextNode(i)),i=c)}else e.fileMetaKey&&"object"==typeof e.fileMeta&&(i=pt.getFileIcon(e));if(s.isGroup&&3!==s.type&&7!==s.type){var r=e.to.split(",")[0]===Ge?"Me":pt.getTabDisplayName(e.to.split(",")[0],!1);if(10!==e.contentType&&(i=r+": "+i),-1===i.indexOf("emoji-inner")&&e&&e.message&&0===e.contentType){var c=a.createElement("p");c.appendChild(a.createTextNode(i)),i=c}}}return i},s.getTextForMessagePreview=function(t,s){var o="";if(void 0!==t){if(2===t.contentType)o="Shared location";else if(t.message){var i=t.message;if(mckUtils.startsWith(i,"<img"))o="Image attachment";else{var n=a.createElement("div");n.innerHTML=i,o=(i=e.trim(mckUtils.textVal(n))).substring(0,50)}}else t.fileMetaKey&&"object"==typeof t.fileMeta&&(o=-1!==t.fileMeta.contentType.indexOf("image")?"Image attachment":"File attachment");s.isGroup&&3!==s.type&&7!==s.type&&(o=(t.to.split(",")[0]===Ge?"Me":pt.getTabDisplayName(t.to.split(",")[0],!1))+": "+o)}return o},s.getUserIdFromMessage=function(e){var t=e.to;return t.lastIndexOf(",")===t.length-1&&(t=t.substring(0,t.length-1)),t.split(",")},s.getUserIdArrayFromMessageList=function(t){var a=new Array;return void 0===t.length?a.concat(s.getUserIdFromMessage(t)):e.each(t,function(e,t){void 0!==t.to&&(a=a.concat(s.getUserIdFromMessage(t)))}),a},s.messageContextMenu=function(a){var s=e("."+a+" .mck-msg-box");s.addEventListener?s.addEventListener("contextmenu",function(e){e.preventDefault()},!1):s.bind("contextmenu",function(s){s.preventDefault(),e(".mck-context-menu").removeClass("vis").addClass("n-vis"),e("."+a+" .mck-context-menu").removeClass("n-vis").addClass("vis"),t.event.returnValue=!1})},s.isValidMetaData=function(e){return!e.metadata||"HIDDEN"!==e.metadata.category&&"ARCHIVE"!==e.metadata.category},s.updateDraftMessage=function(t,a){if("object"==typeof a){var s={text:"",files:[]},o={fileMeta:a,filelb:mt.getFilePreviewPath(a),filesize:mt.getFilePreviewSize(a.size)};void 0!==t&&"object"==typeof at[t]&&(s=at[t],e.each(s.files,function(e,t){t.filelb===o.filelb&&s.files.splice(e,1)})),s.files.push(o)}at[t]=s},s.updateUnreadCount=function(e,t,a){var o=s.getUnreadCount(e);ot[e]=t,(a||ft.length>0)&&((R+=t-o)<0&&(R=0),R>0?ft.html(R):ft.html(""))},s.incrementUnreadCount=function(e){R+=1,ot[e]=void 0===ot[e]?1:ot[e]+1,ft.length>0&&ft.html(R)},s.getUnreadCount=function(e){return void 0===ot[e]?(ot[e]=0,0):ot[e]},s.isGroupDeleted=function(e,t){if(t){var a=dt.getDeletedAtTime(e);return void 0!==a&&a>0}return!1},s.getTabDisplayName=function(e,t,a){var o="";if(t)return dt.getGroupDisplayName(e);"function"==typeof ge&&(o=ge(e)),void 0!==a&&a&&(o=a,st[e]=a),o||(o=s.getContactDisplayName(e));var i=s.fetchContact(""+e);return o?(i.displayName=o,x[i.contactId]=i):void 0!==i.displayName&&(o=i.displayName),o||(o=e),o},s.populateMessage=function(t,a,s){var o=mckDateUtils.convertMilisIntoTime(a.metadata.CALL_DURATION);vt.loadUserProfile(a.to),103==a.contentType&&(4==a.type&&"CALL_REJECTED"==a.metadata.MSG_TYPE?a.message="you rejected a Video call from "+a.to:5==a.type&&"CALL_REJECTED"==a.metadata.MSG_TYPE?a.message=a.to+"rejected a Video call from you":4==a.type&&"CALL_END"==a.metadata.MSG_TYPE?a.message="you were in a call with "+a.to+"\n call duration : "+o:5==a.type&&"CALL_END"==a.metadata.MSG_TYPE?a.message="you were in a call with "+a.to+"\n call duration : "+o:4==a.type&&"CALL_MISSED"==a.metadata.MSG_TYPE?a.message="you missed a Video call from "+a.to:5==a.type&&"CALL_MISSED"==a.metadata.MSG_TYPE&&(a.message=a.to+"missed a Video call from you"));var i=We.data("mck-id"),n=pt.isValidMetaData(a),r=a.groupId?mckGroupUtils.getGroup(a.groupId):pt.getContact(a.to);if(void 0===i||""===i){var c=e("#mck-contact-list").length;if(c>0&&n&&(a.groupId?pt.addGroupFromMessage(a,!0):pt.addContactsFromMessage(a,!0)),"APPLOZIC_01"===t||"MESSAGE_RECEIVED"===t){if(void 0===r&&(r=a.groupId?mckGroupUtils.createGroup(a.groupId):pt.createContact(a.to)),Ve)return void pt.loadTab({tabId:r.contactId,isGroup:r.isGroup,conversationId:a.conversationId});d=a.groupId?"group_"+r.contactId:"user_"+r.contactId;n&&(10!==a.contentType&&102!==a.contentType&&pt.incrementUnreadCount(d),gt.notifyUser(a));var l=a.groupId?"group-"+r.htmlId:"user-"+r.htmlId;e("#li-"+l+" .mck-unread-count-text").html(pt.getUnreadCount(d)),pt.getUnreadCount(d)>0&&e("#li-"+l+" .mck-unread-count-box").removeClass("n-vis").addClass("vis"),ut.sendDeliveryUpdate(a)}}else if(void 0===r&&(r=a.groupId?mckGroupUtils.createGroup(a.groupId):pt.createContact(a.to)),"APPLOZIC_01"===t||"MESSAGE_RECEIVED"===t){if(void 0!==r){v=We.data("isgroup");if((void 0===a.oldKey||0===e("."+a.oldKey).length)&&0===e("."+a.key).length||10===a.contentType){if(void 0===i||i!==r.contactId||v!==r.isGroup||P.hasClass("vis")){if(Ve)return void pt.loadTab({tabId:r.contactId,isGroup:r.isGroup,conversationId:a.conversationId});if(n&&10!==a.contentType||102!==a.contentType){var d=a.groupId?"group_"+r.contactId:"user_"+r.contactId;pt.incrementUnreadCount(d)}ut.sendDeliveryUpdate(a)}else{g=!0;if(v&&6===r.type&&(g=dt.isAppendOpenGroupContextMenu(r)),a.conversationId&&(Be||Ue)){var m=We.data("mck-conversationid");if(m&&m.toString()===a.conversationId.toString())a.metadata&&"HIDDEN"===a.metadata.category||pt.addMessage(a,r,!0,!0,g),ut.sendReadUpdate(a.pairedMessageKey);else if(Ve)return void pt.loadTab({tabId:r.contactId,isGroup:r.isGroup,conversationId:a.conversationId})}else{if(7===r.type){var p=mckGroupUtils.getGroup(a.groupId),u=pt.getContactFromGroupOfTwo(p);lt.lastSeenOfGroupOfTwo(u.contactId),pt.addMessage(a,r,!0,!0,g)}(!a.metadata||"HIDDEN"!==a.metadata.category&&7!==r.type)&&pt.addMessage(a,r,!0,!0,g),ut.sendReadUpdate(a.pairedMessageKey)}a.groupId||(e("#mck-tab-status").html(MCK_LABELS.online),lt.updateUserStatus({userId:a.to,status:1}))}s&&6!==r.type&&gt.notifyUser(a)}}}else if("APPLOZIC_02"===t&&102==!a.contentType&&((void 0===a.oldKey||0===e("."+a.oldKey).length)&&0===e("."+a.key).length||10===a.contentType))if(c>0)pt.addContactsFromMessage(a,!0);else if(void 0!==r){var v=We.data("isgroup");if(void 0!==i&&i===r.contactId&&v===r.isGroup){var g=!0;v&&6===r.type&&(g=dt.isAppendOpenGroupContextMenu(r)),a.metadata&&"HIDDEN"===a.metadata.category||pt.addMessage(a,r,!0,!0,g),3===a.type&&(e("."+a.key+" .mck-message-status").removeClass("mck-icon-time").addClass("mck-icon-sent"),pt.addTooltip(a.key))}}pe.removeClass("vis").addClass("n-vis")},s.getMessageFeed=function(t){var a={};if(a.key=t.key,a.timeStamp=t.createdAtTime,a.message=t.message,a.from=4===t.type?t.to:Ge,t.groupId?a.to=t.groupId:a.to=5===t.type?t.to:Ge,a.status="read",a.type=4===t.type?"inbox":"outbox",5===t.type&&(3===t.status?a.status="sent":4===t.status&&(a.status="delivered")),"object"==typeof t.fileMeta){var s=e.extend({},t.fileMeta);void 0!==s.url&&""!==s.url||(s.url=te+"/rest/ws/aws/file/"+t.fileMeta.blobKey),delete s.blobKey,a.file=s}return a.source=t.source,a.metadata=t.metadata,a},s.updateUnreadCountonChatIcon=function(t){if(Je&&t.length>0){var a=null,s=0;t.length>0&&(e.each(t,function(e,t){t.unreadCount>0&&null!==a||t.unreadCount>0&&(a=t.userId,s=t.unreadCount)}),R>0&&"none"===l.css("display")&&(null!==a&&s===R?pt.loadTab({tabId:a,isGroup:!1}):pt.loadTab({tabId:"",isGroup:!1})))}},s.loadMessageListOnUserDetailFetch=function(t){pe.removeClass("vis").addClass("n-vis");var a=We.data("mck-id"),s=We.data("isgroup");if(void 0===a||t.tabId===a&&""+s==""+t.isGroup){var o=mckGroupUtils.getGroup(t.tabId);dt.addGroupStatus(o);var i=6!==o.type,i=!0;6===o.type&&(dt.validateOpenGroupUser(o),i=dt.isAppendOpenGroupContextMenu(o)),t.isMessages?(b.removeClass("vis").addClass("n-vis"),pt.processMessageList(t.messageData,!0,i),6!==o.type&&je.removeClass("n-vis").addClass("vis"),"function"==typeof ce&&ce(t.tabId)):0===e("#mck-message-cell .mck-message-inner div[name='message']").length&&(je.removeClass("vis").addClass("n-vis"),b.removeClass("n-vis").addClass("vis"))}}}function l(){var a=this,s=e("#mck-msg-form"),o=e("#mck-msg-error"),i=e("#mck-tab-title"),n=e("#mck-tab-status"),r=e(".mck-typing-box"),c=e("#mck-block-button"),l=e("#mck-message-cell .mck-message-inner");a.updateUserStatus=function(e){if("object"==typeof D[e.userId]){var t=D[e.userId];0===e.status?(t.connected=!1,t.lastSeenAtTime=e.lastSeenAtTime):1===e.status&&(t.connected=!0)}else{var a=new Array;a.push(e.userId),vt.getUsersDetail(a,{})}},a.getUserDetail=function(e){return"object"==typeof D[e]?D[e]:void 0},a.checkUserConnectedStatus=function(){var t=new Array,s=new Array;e(".mck-user-ol-status").each(function(){var a=e(this).data("mck-id");if(void 0!==a&&""!==a){t.push(a);var s=mckContactUtils.formatContactId(""+a);e(this).addClass(s),e(this).next().addClass(s)}}),t.length>0&&(e.each(t,function(e,t){void 0===D[t]&&s.push(t)}),s.length>0?vt.getUsersDetail(s,{setStatus:!0}):a.updateUserConnectedStatus())},a.updateUserConnectedStatus=function(){e(".mck-user-ol-status").each(function(){var t=e(this),a=t.data("mck-id");if(a){var s=D[a];void 0!==D[a]&&s.connected?(t.removeClass("n-vis").addClass("vis"),t.next().html("("+MCK_LABELS.online+")")):(t.removeClass("vis").addClass("n-vis"),t.next().html("(Offline)"))}})},a.lastSeenOfGroupOfTwo=function(e){if(t.MCK_OL_MAP[e])n.attr("title",MCK_LABELS.online).html(MCK_LABELS.online),n.removeClass("n-vis").addClass("vis");else if(N[e]){var a=mckDateUtils.getLastSeenAtStatus(N[e]);n.html(a),n.attr("title",a),i.addClass("mck-tab-title-w-status"),n.removeClass("n-vis").addClass("vis")}},a.toggleBlockUser=function(e,a){if(a)o.html(MCK_LABELS.blocked),o.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),s.removeClass("vis").addClass("n-vis"),i.removeClass("mck-tab-title-w-status"),n.removeClass("vis").addClass("n-vis"),r.removeClass("vis").addClass("n-vis"),l.data("blocked",!0),c.html(MCK_LABELS["unblock.user"]).attr("title",MCK_LABELS["unblock.user"]);else if(o.html(""),o.removeClass("vis").addClass("n-vis").removeClass("mck-no-mb"),s.removeClass("n-vis").addClass("vis"),l.data("blocked",!1),c.html(MCK_LABELS["block.user"]).attr("title",MCK_LABELS["block.user"]),!_[e]&&(t.MCK_OL_MAP[e]||N[e])){if(t.MCK_OL_MAP[e])n.attr("title",MCK_LABELS.online).html(MCK_LABELS.online);else if(N[e]){var d=mckDateUtils.getLastSeenAtStatus(N[e]);n.html(d),n.attr("title",d)}i.addClass("mck-tab-title-w-status"),n.removeClass("n-vis").addClass("vis")}}}function d(){var a=this,s=(e("#mck-search-list"),e("#mck-sidebox-search")),o=e("#mck-search-loading"),i=(e("#mck-search-cell .mck-message-inner"),e("#mck-message-cell .mck-message-inner"),e(".mck-tab-message-option"),e("#mck-contact-loading"),"/rest/ws/user/block"),n="/rest/ws/user/info",r="/rest/ws/user/v2/detail",c="/rest/ws/user/filter",l="/rest/ws/user/chat/status";a.getContactDisplayName=function(e){var t=[];if(e.length>0&&e[0]){for(var a="",s=e.filter(function(t,a){return e.indexOf(t)===a}),o=0;o<s.length;o++){var i=s[o];void 0===st[i]&&(a+="userIds="+encodeURIComponent(i)+"&")}a.lastIndexOf("&")===a.length-1&&(a=a.substring(0,a.length-1)),a&&mckUtils.ajax({url:MCK_BASE_URL+n,data:a,global:!1,type:"get",success:function(e){for(var a in e)e.hasOwnProperty(a)&&(t.push([a,e[a]]),st[a]=e[a],pt.fetchContact(a).displayName=e[a]);Qe.updateMckContactNameArray(t)},error:function(){}})}},a.loadContacts=function(){var a=[];mckUtils.ajax({url:MCK_BASE_URL+c+"?startIndex=0&pageSize=30&orderBy=1",type:"get",global:!1,success:function(o){if(s.hasClass("vis"))return"object"==typeof o&&o.users.length>0&&(e.each(o.users,function(e,s){if(void 0!==s.userId){var o=pt.getContact(""+s.userId);o=void 0===o?pt.createContactWithDetail(s):pt.updateContactDetail(o,s),tt.push(o),a.push([s.userId,o.displayName]),s.connected?t.MCK_OL_MAP[s.userId]=!0:(t.MCK_OL_MAP[s.userId]=!1,void 0!==s.lastSeenAtTime&&(N[s.userId]=s.lastSeenAtTime))}}),a.length>0&&Qe.updateMckContactNameArray(a)),void pt.addContactsToSearchList()},error:function(){o.removeClass("vis").addClass("n-vis"),t.console.log("Unable to load contacts. Please reload page.")}})},a.loadUserProfile=function(e){if(void 0!==e){var t=[],s=""+e.split(",")[0];t.push(s),a.loadUserProfiles(t)}},a.loadUserProfiles=function(t){var s=[];e.each(t,function(e,t){void 0===pt.getContact(t)&&s.push(t)}),a.getUsersDetail(s,{async:!1})},a.getUsersDetail=function(a,s){if(!(void 0===a||a.length<1)){for(var o=void 0===s.cached||s.cached,i=[],n=a.filter(function(e,t){return a.indexOf(e)===t}),c=0;c<n.length;c++){var l=n[c];o&&void 0!==D[l]||i.push(l)}if(0!==i.length){var d=new Object;mckUtils.ajax({url:MCK_BASE_URL+r,type:"post",async:void 0===s.async||s.async,data:JSON.stringify({userIdList:i}),contentType:"application/json",success:function(a){"success"===a.status&&a.response.length>0&&e.each(a.response,function(e,a){D[a.userId]=a,t.MCK_OL_MAP[a.userId]=a.connected;var s=pt.getContact(""+a.userId);s=void 0===s?pt.createContactWithDetail(a):pt.updateContactDetail(s,a)}),s.setStatus?lt.updateUserConnectedStatus():s.message?pt.populateMessage(s.messageType,s.message,s.notifyUser):s.isLoadMessageList&&pt.loadMessageListOnUserDetailFetch(s),d.status="success",d.data=a,s.callback&&s.callback(d)},error:function(){s.setStatus?lt.updateUserConnectedStatus():s.message?pt.populateMessage(s.messageType,s.message,s.notifyUser):s.isLoadMessageList&&pt.loadMessageListOnUserDetailFetch(s),d.status="error",s.callback&&s.callback(d)}})}else s.setStatus?lt.updateUserConnectedStatus():s.message?pt.populateMessage(s.messageType,s.message,s.notifyUser):s.isLoadMessageList&&pt.loadMessageListOnUserDetailFetch(s)}},a.getUserStatus=function(t){var a=new Object;mckUtils.ajax({url:MCK_BASE_URL+l,type:"get",success:function(s){s.users.length>0&&(it=[],e.each(s.users,function(e,t){var a=pt.getContact(""+t.userId);a=void 0===a?pt.createContactWithDetail(t):pt.updateContactDetail(a,t),it.push(a.contactId)})),a.status="success",a.data=s,t.callback&&t.callback(a)},error:function(){a.status="error",t.callback&&t.callback(a)}})},a.blockUser=function(e,t){if(e&&void 0!==t){var a="userId="+e+"&block="+t;mckUtils.ajax({url:MCK_BASE_URL+i,type:"get",data:a,success:function(a){"object"==typeof a&&"success"===a.status&&(U[e]=t,lt.toggleBlockUser(e,t))},error:function(){}})}}}function m(){var s=this,o={0:"User",1:"Admin",2:"Moderator",3:"Member"},i=e("#mck-msg-form"),n=e("#mck-msg-error"),r=e("#mck-tab-title"),c=e("#mck-tab-status"),l=e("#mck-no-gsm-text"),d=e("#mck-gms-loading"),m=e("#mck-contact-loading"),p=(e("#mck-tab-menu-box"),e("#mck-search-loading"),e("#mck-group-info-tab")),u=e("#mck-sidebox-search"),v=(e("#mck-group-name-box"),e("#mck-group-back-link")),g=e("#mck-group-name-edit"),f=e("#mck-group-name-save"),k=e("#mck-sidebox-content"),C=e("#mck-tab-option-panel"),b=e("#mck-btn-group-create"),h=e("#mck-group-create-tab"),y=e("#mck-contacts-content"),I=e("#mck-btn-group-update"),M=e("#mck-group-create-type"),S=e("#mck-group-icon-upload"),T=e("#mck-group-icon-change"),L=e("#mck-group-member-list"),x=e("#mck-group-update-panel"),G=e(".mck-tab-message-option"),E=e("#mck-group-create-title"),A=e(".mck-group-menu-options"),_=e("#mck-group-member-search"),w=e("#mck-btn-group-icon-save"),D=(e("#mck-group-info-icon-box"),e(".mck-group-admin-options")),P=e("#mck-group-add-member-box"),R=e("#mck-message-cell .mck-message-inner"),B=e("#mck-group-name-sec .mck-group-title"),j=(e("#mck-group-create-icon-box"),e("#mck-group-info-icon-loading")),F=e("#mck-gm-search-box"),$=(e("#mck-group-member-search-list"),e("#mck-group-create-icon-loading")),q=e("#mck-group-info-icon-box .mck-group-icon"),H=e("#mck-group-create-icon-box .mck-group-icon"),W=e("#mck-group-create-icon-box .mck-overlay-box"),Y=e("#mck-gc-overlay-label"),Z='<li id="li-gm-${contHtmlExpr}" class="${contIdExpr} mck-li-group-member" data-mck-id="${contIdExpr}" data-role="${roleVal}" data-alpha="${contFirstAlphaExpr}"><div class="mck-row mck-group-member-info" title="${contNameExpr}"><div class="blk-lg-3">{{html contImgExpr}}</div><div class="blk-lg-9"><div class="mck-row"><div class="blk-lg-8 mck-cont-name mck-truncate"><strong>${contNameExpr}</strong></div><div class="blk-lg-4 mck-group-admin-text move-right vis"><span>${roleExpr}</span></div></div><div class="mck-row"><div class="blk-lg-8 mck-truncate mck-last-seen-status" title="${contLastSeenExpr}">${contLastSeenExpr}</div><div class="blk-lg-4 mck-group-admin-options move-right ${enableAdminMenuExpr}"><div class="mck-menu-box n-vis"><div class="mck-dropdown-toggle mck-group-admin-menu-toggle mck-text-center" data-toggle="mckdropdown" aria-expanded="true"><span class="mck-caret"></span></div><ul id="mck-group-admin-menu" class="mck-dropdown-menu mck-group-admin-menu mck-tab-menu-box menu-right" role="menu"><li><a href="#" class="mck-btn-remove-member menu-item" title="${removeMemberLabel}">${removeMemberLabel}</a></li><li><a href="#" class="mck-btn-change-role menu-item" title="${changeRoleLabel}">${changeRoleLabel}</a></li></ul></div></div></div><div id="mck-group-change-role-box" class="mck-row mck-group-change-role-box n-vis"><div class="blk-lg-4"><div class="mck-label">Select role </div></div><div class="blk-lg-8 move-right"><select id="mck-change-role-type" class="mck-select"><option value="0">User</option><option value="1">Admin</option><option value="2">Moderator</option><option value="3" selected>Member</option></select></div></div></div></div></li>',Q='<li id="li-${contHtmlExpr}" class="${contIdExpr} mck-li-group-member" data-mck-id="${contIdExpr}"><a class="mck-add-to-group" href="#" data-mck-id="${contIdExpr}"><div class="mck-row" title="${contNameExpr}"><div class="blk-lg-3">{{html contImgExpr}}</div><div class="blk-lg-9"><div class="mck-row"><div class="blk-lg-12 mck-cont-name mck-truncate"><strong>${contNameExpr}</strong></div></div><div class="mck-row"><div class="blk-lg-12 mck-truncate mck-last-seen-status" title="${contLastSeenExpr}">${contLastSeenExpr}</div></div></div></div></a></li>';e.template("groupMemberTemplate",Z),e.template("groupMemberSearchTemplate",Q);var X=30;e(".mck-group-name-box div[contenteditable]").keypress(function(t){return!!(8===t.which||37===t.keyCode||38===t.keyCode||39===t.keyCode||40===t.keyCode||t.ctrlKey&&97===t.which)||(13!==t.keyCode||t.shiftKey||t.ctrlKey?X>this.innerHTML.length:!!e(t.target).hasClass("mck-group-create-title")&&(s.submitCreateGroup(),!1))}).on("paste",function(e){var t=this;setTimeout(function(){return t.innerText.length>X&&(t.innerHTML=t.innerText.substring(0,X),mckUtils.setEndOfContenteditable(t)),!1},"fast")}).on("drop",function(e){e.preventDefault(),e.stopPropagation()}),e(a).on("click",".mck-btn-change-role",function(t){t.preventDefault();var a=e(this).parents(".mck-li-group-member").find(".mck-group-change-role-box"),s=e(this).parents(".mck-li-group-member").data("role");a.find("select").val(s),a.removeClass("n-vis").addClass("vis"),x.removeClass("n-vis").addClass("vis")}),I.on("click",function(){var t=[];if(e(".mck-group-change-role-box.vis").each(function(a,s){var o=e(this),i=parseInt(o.find("select").val());if(i!==o.parents(".mck-li-group-member").data("role")){var n={userId:o.parents(".mck-li-group-member").data("mck-id"),role:i};t.push(n)}}),t.length>0){var a=R.data("mck-id"),s=R.data("isgroup");if(a&&s){I.attr("disabled",!0).html(MCK_LABELS["group.info.updating"]);var o={groupId:a,users:t,apzCallback:dt.onUpdateGroupInfo};mckGroupService.updateGroupInfo(o)}}}),e("#mck-group-info-icon-box .mck-overlay").on("click",function(e){T.trigger("click")}),e("#mck-group-create-icon-box .mck-overlay").on("click",function(e){S.trigger("click")}),e(a).on("mouseenter",".mck-group-create-icon-box.mck-hover-on",function(){e(this).find(".mck-overlay-box").removeClass("n-vis")}).on("mouseleave",".mck-group-create-icon-box.mck-hover-on",function(){var t=e(this);0===t.find(".mck-group-icon-default").length&&t.find(".mck-overlay-box").addClass("n-vis")}),e(a).on("mouseenter",".mck-group-info-icon-box.mck-hover-on",function(){e(this).find(".mck-overlay-box").removeClass("n-vis")}).on("mouseleave",".mck-group-info-icon-box.mck-hover-on",function(){e(this).find(".mck-overlay-box").addClass("n-vis")}),g.on("click",function(){B.attr("contenteditable",!0).focus(),mckUtils.setEndOfContenteditable(B[0]),f.removeClass("n-vis").addClass("vis"),g.removeClass("vis").addClass("n-vis")}),f.on("click",function(){var t=e.trim(B.text());if(t.length>0){var a=R.data("mck-id"),s=R.data("isgroup");if(a&&s){g.removeClass("n-vis").addClass("vis"),f.removeClass("vis").addClass("n-vis"),B.attr("contenteditable",!1);var o={groupId:a,name:t,apzCallback:dt.onUpdateGroupInfo};mckGroupService.updateGroupInfo(o)}}else B.addClass("mck-req-border")}),w.on("click",function(){var e=q.data("iconurl");if(e){var t=R.data("mck-id"),a=R.data("isgroup");if(t&&a){setTimeout(function(){w.removeClass("vis").addClass("n-vis")},1e3),q.data("iconurl","");var s={groupId:t,imageUrl:e,apzCallback:dt.onUpdateGroupInfo};mckGroupService.updateGroupInfo(s)}}else B.addClass("mck-req-border")}),b.on("click",function(){s.submitCreateGroup()}),s.submitCreateGroup=function(){var t=e.trim(E.text()),a=M.val(),s=H.data("iconurl");if(t.length>0){var o={groupName:t};a&&(a=parseInt(a),-1!==V.indexOf(a)&&(o.type=a)),s&&(o.groupIcon=s),H.data("iconurl",""),o.isInternal=!0,b.attr("disabled",!0).html(MCK_LABELS["group.create.submit"]),ut.getGroup(o)}else E.addClass("mck-req-border")},s.loadGroups=function(t){var a=t.data;et.length=0,e.each(a,function(e,t){if(void 0!==t.id){var t=mckGroupUtils.addGroup(t);et.push(t)}})},s.getDeletedAtTime=function(e){if("object"==typeof MCK_GROUP_MAP[e])return MCK_GROUP_MAP[e].deletedAtTime},s.getGroupDisplayName=function(e){if("object"==typeof MCK_GROUP_MAP[e]){var t=MCK_GROUP_MAP[e],a=t.displayName;if(7===t.type){var s=pt.getContactFromGroupOfTwo(t);void 0!==s&&(a=pt.getTabDisplayName(s.contactId,!1))}if(3===t.type&&-1!==a.indexOf(Ge)&&(a=a.replace(Ge,"").replace(":",""),"function"==typeof ge)){var o=ge(a);a=o||a}return a||5!==t.type||(a="Broadcast"),a||(a=t.contactId),a}return e},s.getGroupImage=function(e){return e?'<img src="'+e+'"/>':'<img src="'+MCK_BASE_URL+'/resources/sidebox/css/app/images/mck-icon-group.png"/>'},s.getGroupDefaultIcon=function(){return'<div class="mck-group-icon-default"></div>'},s.addMemberToGroup=function(e,t){return"object"==typeof e.members&&(-1===e.members.indexOf(t)&&e.members.push(t),"object"==typeof e.removedMembersId&&-1!==e.removedMembersId.indexOf(t)&&e.removedMembersId.splice(e.removedMembersId.indexOf(t),1),MCK_GROUP_MAP[e.contactId]=e),e},s.removeMemberFromGroup=function(e,t){return"object"!=typeof e.removedMembersId||e.removedMembersId.length<1?(e.removedMembersId=[],e.removedMembersId.push(t)):-1===e.removedMembersId.indexOf(t)&&e.removedMembersId.push(t),MCK_GROUP_MAP[e.contactId]=e,e},s.authenticateGroupUser=function(e){var t=!1;if(!s.isGroupLeft(e)&&e.members.length>0)for(var a=0;a<e.members.length;a++)if(Ge===""+e.members[a])return t=!0,!0;return t},s.isAppendOpenGroupContextMenu=function(e){return 0!==he.deleteChatAccess&&(!!s.authenticateGroupUser(e)&&(e.adminName===Ge||2===he.deleteChatAccess))},s.validateOpenGroupUser=function(e){if(6===e.type){if(!s.authenticateGroupUser(e)){if(he.disableChatForNonGroupMember){var t=he.defaultChatDisabledMessage;t||(t="Chat disabled"),n.html(t),n.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),i.removeClass("vis").addClass("n-vis"),r.removeClass("mck-tab-title-w-status"),c.removeClass("vis").addClass("n-vis")}A.removeClass("vis").addClass("n-vis"),G.removeClass("vis").addClass("n-vis"),C.removeClass("vis").addClass("n-vis"),void 0===z[e.contactId]&&ht.subscribeToOpenGroup(e)}return e.adminName===Ge?0===he.deleteChatAccess&&G.removeClass("vis").addClass("n-vis"):(he.allowInfoAccessGroupMembers||A.removeClass("vis").addClass("n-vis"),2!==he.deleteChatAccess&&G.removeClass("vis").addClass("n-vis"),he.allowInfoAccessGroupMembers||2===he.deleteChatAccess||C.removeClass("vis").addClass("n-vis")),!1}return!0},s.addGroupStatus=function(e){var t=s.isGroupLeft(e);if(6!==e.type&&(t||Oe))t&&dt.onGroupLeft("",{groupId:e.contactId}),r.removeClass("mck-tab-title-w-status"),c.removeClass("vis").addClass("n-vis");else if(e.members.length>0){for(var a="",o=!1,i=e.members.length<=30?e.members.length:25,n=0;n<i;n++)if(Ge!==""+e.members[n]&&-1===e.removedMembersId.indexOf(e.members[n])){var l=pt.fetchContact(""+e.members[n]);a+=" "+pt.getTabDisplayName(l.contactId,!1)+","}else o=!0;(5!==e.type&&6!==e.type||o&&5!==e.type)&&(a+=" You"),e.members.length>30&&(a+=" and "+(e.members.length-25)+" more"),a=a.replace(/,\s*$/,""),c.html(a),c.attr("title",a),c.removeClass("n-vis").addClass("vis"),r.addClass("mck-tab-title-w-status"),A.removeClass("n-vis").addClass("vis")}else r.removeClass("mck-tab-title-w-status"),c.removeClass("vis").addClass("n-vis");7===e.type&&(c.html(""),A.removeClass("vis").addClass("n-vis"))},s.disableGroupTab=function(){n.html(MCK_LABELS["group.chat.disabled"]),n.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),i.removeClass("vis").addClass("n-vis"),r.removeClass("mck-tab-title-w-status"),c.removeClass("vis").addClass("n-vis")},s.isGroupLeft=function(t){var a=!1;return t.removedMembersId&&t.removedMembersId.length>0&&e.each(t.removedMembersId,function(e,t){t===Ge&&(a=!0)}),a},s.onGroupLeft=function(e,t){if(m.removeClass("vis").addClass("n-vis"),"object"!=typeof e||"error"!==e.status){var a=t.groupId;if(p.hasClass("vis"))a===p.data("mck-id")&&v.trigger("click");else if(k.hasClass("vis")){var o=R.data("mck-id"),i=R.data("isgroup");o===a.toString()&&i&&(A.removeClass("vis").addClass("n-vis"),s.disableGroupTab())}}else alert("Unable to process your request. "+e.errorMessage)},s.onAddedGroupMember=function(t,a){if(m.removeClass("vis").addClass("n-vis"),"object"!=typeof t||"error"!==t.status){var o=a.groupId,i=a.userId,n="";if(o?n=mckGroupUtils.getGroup(o):a.clientGroupId&&(n=mckGroupUtils.getGroupByClientGroupId(a.clientGroupId)),"object"==typeof n){if(n=s.addMemberToGroup(n,i),p.hasClass("vis")){if(o===p.data("mck-id")){var r=pt.fetchContact(""+i);0===e("#li-gm-"+r.htmlId).length&&s.addGroupMember(n,r),s.sortGroupMemberHtmlList(),s.enableGroupAdminMenuToggle()}}else if(k.hasClass("vis")){var c=R.data("mck-id"),l=R.data("isgroup");c===o.toString()&&l&&s.addGroupStatus(n)}}else mckGroupService.getGroupFeed({groupId:o,clientGroupId:a.clientGroupId,apzCallback:dt.onGroupFeed})}else alert("Unable to process your request. "+t.errorMessage)},s.onRemovedGroupMember=function(t,a){if(m.removeClass("vis").addClass("n-vis"),"object"!=typeof t||"error"!==t.status){var o=a.groupId,i=a.userId,n="";if(o?n=mckGroupUtils.getGroup(o):a.clientGroupId&&(n=mckGroupUtils.getGroupByClientGroupId(a.clientGroupId)),"object"==typeof n){if(n=s.removeMemberFromGroup(n,i),p.hasClass("vis")){if(o===p.data("mck-id")){var r=pt.fetchContact(""+i),c=e("#li-gm-"+r.htmlId);c.length>0&&c.remove()}}else if(k.hasClass("vis")){var l=R.data("mck-id"),d=R.data("isgroup");l===o.toString()&&d&&s.addGroupStatus(n)}}else mckGroupService.getGroupFeed({groupId:o,clientGroupId:a.clientGroupId,apzCallback:dt.onGroupFeed})}else alert("Unable to process your request. "+t.errorMessage)},s.onGroupFeed=function(t,a){if(m.removeClass("vis").addClass("n-vis"),"success"===t.status){var o=t.data,r=o.conversationPxy,c=mckGroupUtils.getGroup(o.id);o.deletedAtTime&&(n.html(MCK_LABELS["group.deleted"]),n.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),i.removeClass("vis").addClass("n-vis"));var l=new Array;"object"==typeof r&&(K[r.id]=r,J[r.topicId]=[r.id],r.topicDetail&&(O[r.topicId]=e.parseJSON(r.topicDetail)),l.push(r)),l.length>0&&(nt[a.groupId]=l),vt.loadUserProfiles(o.membersId),a.isMessage&&"object"==typeof a.message&&pt.populateMessage(a.messageType,a.message,a.notifyUser),a.isReloadTab&&s.reloadGroupTab(c)}},s.onUpdateGroupInfo=function(t,a){if(m.removeClass("vis").addClass("n-vis"),I.attr("disabled",!1).html("Update"),x.removeClass("vis").addClass("n-vis"),"object"!=typeof t||"error"!==t.status){var o=a.groupId,i=a.groupInfo,n=mckGroupUtils.getGroup(o);if("object"==typeof n){if(i.imageUrl&&(n.imageUrl=i.imageUrl),i.newName&&(n.displayName=i.newName),i.users&&i.users.length>0&&e.each(i.users,function(e,t){t.userId&&(n.users[t.userId]=t)}),p.hasClass("vis"))i.imageUrl&&q.html(s.getGroupImage(n.imageUrl)),B.html(n.displayName),i.users&&i.users.length>0&&(L.html(""),s.addMembersToGroupInfoList(n),n.adminName===Ge?P.removeClass("n-vis").addClass("vis"):P.removeClass("vis").addClass("n-vis"));else if(k.hasClass("vis")){var c=R.data("mck-id"),l=R.data("isgroup");c===o.toString()&&l?r.html(n.displayName):e("#li-group-"+n.htmlId).length>0&&(e("#li-group-"+n.htmlId+" .mck-cont-name strong").html(n.displayName),i.imageUrl&&e("#li-group-"+n.htmlId+" .blk-lg-3").html("<img src=' "+n.imageUrl+"'>"))}MCK_GROUP_MAP[n.contactId]=n}}else alert("Unable to process your request. "+t.errorMessage)},s.getGroupFeedFromMessage=function(e){var t=e.message;if(t){if(e.groupId=t.groupId,e.isMessage=!0,t.conversationId){var a=K[t.conversationId];"object"==typeof a&&"object"==typeof O[a.topicId]||(e.conversationId=t.conversationId)}e.apzCallback=dt.onGroupFeed,mckGroupService.getGroupFeed(e)}},s.reloadGroupTab=function(e){var t=R.data("mck-id"),a=R.data("isgroup");t===e.contactId.toString()&&a&&s.addGroupStatus(e)},s.loadGroupTab=function(t){if("error"===t.status)alert("Unable to process your request. "+t.errorMessage);else{var a=t.data;pt.loadTab({tabId:a.contactId,isGroup:!0}),e("#mck-search").val("")}},s.addMembersToGroupInfoList=function(t){var a=t.members;a.sort(),L.html(""),e.each(a,function(a,o){if(o){var i=pt.fetchContact(""+o);0===e("#li-gm-"+i.htmlId).length&&s.addGroupMember(t,i)}}),s.sortGroupMemberHtmlList(),s.enableGroupAdminMenuToggle()},s.enableGroupAdminMenuToggle=function(){e(".mck-group-member-info").bind("mouseenter",function(){e(this).find(".mck-menu-box").removeClass("n-vis")}).bind("mouseleave",function(){e(this).find(".mck-menu-box").removeClass("open").addClass("n-vis")})},s.addGroupMember=function(a,s){var i="n-vis",n="n-vis",r=a.users[s.contactId],c="Member",l=3;r&&void 0!==r.role&&(l=r.role,c=o[r.role]);var d=pt.getTabDisplayName(s.contactId,!1);s.contactId===a.adminName&&(i="vis"),a.adminName===Ge&&(n="vis"),s.contactId===Ge&&(d="You",n="n-vis");var m=pt.getContactImageLink(s,d),p="";U[s.contactId]||(t.MCK_OL_MAP[s.contactId]?p=MCK_LABELS.online:N[s.contactId]&&(p=mckDateUtils.getLastSeenAtStatus(N[s.contactId])));var u=[{roleExpr:c,roleVal:l,removeMemberLabel:MCK_LABELS["remove.member"],changeRoleLabel:MCK_LABELS["change.role"],contHtmlExpr:s.htmlId,contIdExpr:s.contactId,contImgExpr:m,contLastSeenExpr:p,contNameExpr:d,contFirstAlphaExpr:d.charAt(0).toUpperCase(),isAdminExpr:i,enableAdminMenuExpr:n}];e.tmpl("groupMemberTemplate",u).appendTo("#mck-group-member-list")},s.addMembersToGroupSearchList=function(){var t=R.data("mck-id");if(R.data("isgroup")){var a=mckGroupUtils.getGroup(t),o=it,i=[];(o=o.filter(function(e,t){return o.indexOf(e)===t})).sort();var n=a.members;e.each(o,function(e,t){if(t){var o=pt.fetchContact(""+t);(-1===n.indexOf(o.contactId)||-1!==n.indexOf(o.contactId)&&-1!==a.removedMembersId.indexOf(o.contactId))&&(s.addGroupSearchMember(o),i.push(o))}}),s.enableGroupAdminMenuToggle(),i.length>0?l.removeClass("vis").addClass("n-vis"):l.removeClass("n-vis").addClass("vis"),pt.initAutoSuggest({contactsArray:i,$searchId:_,isContactSearch:!1})}d.removeClass("vis").addClass("n-vis")},s.addGroupSearchMember=function(a){var s=pt.getTabDisplayName(a.contactId,!1),o=pt.getContactImageLink(a,s),i="user-"+a.htmlId,n="";U[a.contactId]||(t.MCK_OL_MAP[a.contactId]?n=MCK_LABELS.online:N[a.contactId]&&(n=mckDateUtils.getLastSeenAtStatus(N[a.contactId])));var r=[{contHtmlExpr:i,contIdExpr:a.contactId,contImgExpr:o,contLastSeenExpr:n,contNameExpr:s}];e.tmpl("groupMemberSearchTemplate",r).appendTo("#mck-group-member-search-list")},s.loadCreateGroupTab=function(){y.removeClass("vis").addClass("n-vis"),k.removeClass("vis").addClass("n-vis"),u.removeClass("vis").addClass("n-vis"),p.removeClass("vis").addClass("n-vis"),$.removeClass("vis").addClass("n-vis"),H.data("iconurl",""),E.html(""),W.removeClass("n-vis"),Y.html(MCK_LABELS["add.group.icon"]),H.html(s.getGroupDefaultIcon()),h.removeClass("n-vis").addClass("vis")},s.loadGroupInfo=function(e){if(e.groupId){B.attr("contenteditable",!1),f.removeClass("vis").addClass("n-vis"),g.removeClass("n-vis").addClass("vis"),y.removeClass("vis").addClass("n-vis"),k.removeClass("vis").addClass("n-vis"),u.removeClass("vis").addClass("n-vis"),x.removeClass("vis").addClass("n-vis"),h.removeClass("vis").addClass("n-vis"),w.removeClass("vis").addClass("n-vis"),j.removeClass("vis").addClass("n-vis"),p.removeClass("n-vis").addClass("vis"),p.data("mck-id",e.groupId),q.data("iconurl",""),e.conversationId&&p.data("mck-conversation-id",e.conversationId),L.html("");var t=mckGroupUtils.getGroup(e.groupId);"object"==typeof t?(q.html(s.getGroupImage(t.imageUrl)),B.html(t.displayName),s.addMembersToGroupInfoList(t),t.adminName===Ge?P.removeClass("n-vis").addClass("vis"):P.removeClass("vis").addClass("n-vis")):mckGroupService.getGroupFeed({groupId:e.groupId,apzCallback:dt.onGroupFeed})}},s.sortGroupMemberHtmlList=function(){e("#mck-group-member-list .mck-li-group-member").sort(function(e,t){return e.dataset.alpha>t.dataset.alpha}).appendTo("#mck-group-member-list")},s.addGroupMemberFromSearch=function(e){var t=p.data("mck-id");if(void 0!==t&&void 0!==e){var a=mckGroupUtils.getGroup(t);"object"==typeof a&&Ge===a.adminName?(vt.loadUserProfile(e),mckGroupService.addGroupMember({groupId:t,userId:e,apzCallback:dt.onAddedGroupMember})):D.removeClass("vis").addClass("n-vis")}F.mckModal("hide")}}function p(){var a=this,s=[],o=[],i=[],n=[];a.updateLatestMessage=function(e){var t=[];t.push(e),a.updateLatestMessageArray(t),a.updateMckMessageArray(t)},a.getLatestMessageArray=function(){return void 0!==t.sessionStorage?e.parseJSON(t.sessionStorage.getItem("mckLatestMessageArray")):s},a.setLatestMessageArray=function(e){void 0!==t.sessionStorage?t.sessionStorage.setItem("mckLatestMessageArray",t.JSON.stringify(e)):s=e},a.updateLatestMessageArray=function(a){if(void 0!==t.sessionStorage){var o=e.parseJSON(t.sessionStorage.getItem("mckLatestMessageArray"));return null!==o?(o=o.concat(a),t.sessionStorage.setItem("mckLatestMessageArray",t.JSON.stringify(o))):t.sessionStorage.setItem("mckLatestMessageArray",t.JSON.stringify(a)),a}return s=s.concat(a)},a.getMckMessageArray=function(){return void 0!==t.sessionStorage?e.parseJSON(t.sessionStorage.getItem("mckMessageArray")):o},a.clearMckMessageArray=function(){void 0!==t.sessionStorage?(t.sessionStorage.removeItem("mckMessageArray"),t.sessionStorage.removeItem("mckLatestMessageArray")):(o.length=0,s.length=0)},a.clearAppHeaders=function(){void 0!==t.sessionStorage&&t.sessionStorage.removeItem("mckAppHeaders")},a.setAppHeaders=function(e){void 0!==t.sessionStorage&&t.sessionStorage.setItem("mckAppHeaders",t.JSON.stringify(e))},a.getAppHeaders=function(a){return void 0!==t.sessionStorage?e.parseJSON(t.sessionStorage.getItem("mckAppHeaders")):{}},a.getMessageByKey=function(e){return i[e]},a.updateMckMessageArray=function(a){for(var s=0;s<a.length;s++){var n=a[s];i[n.key]=n}if(void 0!==t.sessionStorage){var r=e.parseJSON(t.sessionStorage.getItem("mckMessageArray"));return null!==r?(r=r.concat(a),t.sessionStorage.setItem("mckMessageArray",t.JSON.stringify(r))):t.sessionStorage.setItem("mckMessageArray",t.JSON.stringify(a)),a}return o=o.concat(a)},a.getMckContactNameArray=function(){return void 0!==t.sessionStorage?e.parseJSON(t.sessionStorage.getItem("mckContactNameArray")):n},a.setMckContactNameArray=function(e){void 0!==t.sessionStorage?t.sessionStorage.setItem("mckContactNameArray",t.JSON.stringify(e)):n=e},a.updateMckContactNameArray=function(a){if(void 0!==t.sessionStorage){var s=e.parseJSON(t.sessionStorage.getItem("mckContactNameArray"));return null!==s&&(a=a.concat(s)),t.sessionStorage.setItem("mckContactNameArray",t.JSON.stringify(a)),a}return n=n.concat(a)},a.clearMckContactNameArray=function(){void 0!==t.sessionStorage?t.sessionStorage.removeItem("mckContactNameArray"):n.length=0}}function u(){var a=this,s="",o="",i=!1,n=e("#mck-my-loc"),r=e("#mck-loc-box"),c=e("#mck-loc-lat"),l=e("#mck-loc-lon"),d=e("#mck-btn-loc"),m=e("#mck-sidebox-ft"),p=e("#mck-file-menu"),u=e("#mck-btn-attach"),v=e("#mck-map-content"),g=e("#mck-loc-address");a.init=function(){X&&t.google&&"object"==typeof t.google.maps&&(s=new t.google.maps.Geocoder,u.on("click",function(){a.fileMenuToggle()}),d.on("click",function(){i?r.mckModal():(mckMapUtils.getCurrentLocation(a.onGetCurrLocation,a.onErrorCurrLocation),i=!0)})),n.on("click",function(){mckMapUtils.getCurrentLocation(a.onGetMyCurrLocation,a.onErrorMyCurrLocation)})},a.fileMenuReposition=function(){var e=m.offset();e.bottom=t.innerHeight-e.top,p.css({bottom:e.bottom>51?e.bottom:51,right:0})},a.fileMenuToggle=function(){u.hasClass("on")?(u.removeClass("on"),p.hide()):(a.fileMenuReposition(),u.addClass("on"),p.show())},a.onGetCurrLocation=function(e){MCK_CURR_LATITIUDE=e.coords.latitude,MCK_CURR_LONGITUDE=e.coords.longitude,a.openMapBox()},a.onErrorCurrLocation=function(){MCK_CURR_LATITIUDE=46.15242437752303,MCK_CURR_LONGITUDE=2.7470703125,a.openMapBox()},a.onErrorMyCurrLocation=function(e){alert("Unable to retrieve your location. ERROR("+e.code+"): "+e.message)},a.onGetMyCurrLocation=function(e){if(MCK_CURR_LATITIUDE=e.coords.latitude,MCK_CURR_LONGITUDE=e.coords.longitude,c.val(MCK_CURR_LATITIUDE),l.val(MCK_CURR_LONGITUDE),c.trigger("change"),l.trigger("change"),o)g.val(o);else if(s){var t={lat:MCK_CURR_LATITIUDE,lng:MCK_CURR_LONGITUDE};s.geocode({location:t},function(e,t){"OK"===t&&e[1]&&(o=e[1].formatted_address)})}},a.openMapBox=function(){v.locationpicker({location:{latitude:MCK_CURR_LATITIUDE,longitude:MCK_CURR_LONGITUDE},radius:0,scrollwheel:!0,inputBinding:{latitudeInput:c,longitudeInput:l,locationNameInput:g},enableAutocomplete:!0,enableReverseGeocode:!0,onchanged:function(e){MCK_CURR_LATITIUDE=e.latitude,MCK_CURR_LONGITUDE=e.longitude}}),r.on("shown.bs.mck-box",function(){v.locationpicker("autosize")}),r.mckModal()}}function v(){var a=e("#mck-msg-to"),s=(e("#mck-btn-loc"),e("#mck-loc-box")),o=e("#mck-msg-sbmt"),i=e("#mck-msg-error"),n=e("#mck-loc-submit"),r=e("#mck-msg-response"),c=e("#mck_response_text"),l=e("#mck-message-cell .mck-message-inner");n.on("click",function(){var e={type:5,contentType:2,message:t.JSON.stringify(mckMapUtils.getSelectedLocation())},n=l.data("mck-conversationid"),d=l.data("mck-topicid");if(n)e.conversationId=n;else if(d){var m={topicId:d},p=O[d];"object"==typeof p&&(m.topicDetail=t.JSON.stringify(p)),e.conversationPxy=m}!0===l.data("isgroup")?e.groupId=a.val():e.to=a.val(),o.attr("disabled",!0),i.removeClass("vis").addClass("n-vis"),i.html(""),c.html(""),r.removeClass("vis").addClass("n-vis"),ut.sendMessage(e),s.mckModal("hide")})}function g(){var t=this,s=1024,o=1048576,i=["CREATE","UPDATE"],n=e("#mck-file-box"),r=e(".mck-overlay"),c=e("#mck-msg-sbmt"),l=e("#mck-text-box"),d=e("#mck-file-input"),m=e(".mck-overlay-box"),p=e(".mck-file-upload"),u=e("#mck-group-icon-upload"),v=e("#mck-group-icon-change"),g=e("#mck-group-info-icon-box"),f=e("#mck-btn-group-icon-save"),k=e("#mck-message-cell .mck-message-inner"),C=e("#mck-group-create-icon-box"),b=e("#mck-group-info-icon-loading"),y=e("#mck-group-create-icon-loading"),M=e("#mck-group-info-icon-box .mck-group-icon"),S=e("#mck-group-create-icon-box .mck-group-icon"),L=e("#mck-gc-overlay-label"),x="/rest/ws/aws/file",G="/rest/ws/aws/file/url",E="/rest/ws/upload/file",A="/rest/ws/aws/file/delete",U='<div id="mck-filebox-${fileIdExpr}" class="mck-file-box ${fileIdExpr}"><div class="mck-file-expr"><span class="mck-file-content blk-lg-8"><span class="mck-file-lb">{{html fileNameExpr}}</span>&nbsp;<span class="mck-file-sz">${fileSizeExpr}</span></span><span class="progress progress-striped active blk-lg-3" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><span class="progress-bar progress-bar-success bar" stye></span></span><span class="move-right"><button type="button" class="mck-box-close mck-remove-file" data-dismiss="div" aria-hidden="true">x</button></span></div></div>';e.template("fileboxTemplate",U),t.init=function(){p.on("click",function(){d.trigger("click")}),u.on("change",function(){var a=e(this)[0].files[0];return t.uplaodFileToAWS(a,i[0]),!1}),v.on("change",function(){var a=e(this)[0].files[0];return t.uplaodFileToAWS(a,i[1]),!1}),d.on("change",function(){var a=e(this)[0].files[0],s={};s.file=a,s.name=a.name,t.uploadFile(s)}),e(a).on("click",".mck-remove-file",function(){var a=e(this).parents(".mck-file-box"),s=a.data("mckfile");a.remove(),c.attr("disabled",!1),0===n.find(".mck-file-box").length&&(n.removeClass("vis").addClass("n-vis"),l.attr("required","")),"object"==typeof s&&(t.deleteFileMeta(s.blobKey),e.each(T,function(e,t){void 0!==t&&t.blobKey===s.blobKey&&T.splice(e,1)}))})},t.uploadFile=function(a){var s=a.file,i=new Object,r=[];if(void 0!==s){if(e(".mck-file-box").length>4&&r.push("Can't upload more than 5 files at a time"),s.size>pe*o&&r.push("file size can not be more than "+pe+" MB"),!(r.length>0)){var d=mckUtils.randomId(),m=[{fileIdExpr:d,fileName:a.name,fileNameExpr:'<a href="#">'+a.name+"</a>",fileSizeExpr:t.getFilePreviewSize(s.size)}];e.tmpl("fileboxTemplate",m).appendTo("#mck-file-box");var u=e(".mck-file-box."+d),v=e(".mck-file-box."+d+" .mck-file-lb"),g=e(".mck-file-box."+d+" .progress .bar"),f=e(".mck-file-box."+d+" .progress"),C=e(".mck-file-box."+d+" .mck-remove-file");if(g.css("width","0%"),f.removeClass("n-vis").addClass("vis"),C.attr("disabled",!0),p.attr("disabled",!0),n.removeClass("n-vis").addClass("vis"),a.name===e(".mck-file-box."+d+" .mck-file-lb a").html()){var b=k.data("mck-id"),h=a.name+s.size;Xe[h]=b,c.attr("disabled",!0),i.files=[],i.files.push(s);var y=new XMLHttpRequest;(y.upload||y).addEventListener("progress",function(e){var t=parseInt(e.loaded/e.total*100,10);g.css("width",t+"%")}),y.addEventListener("load",function(a){var s=e.parseJSON(this.responseText);if("object"==typeof s.fileMeta){var o=s.fileMeta,i=t.getFilePreviewPath(o),n=o.name,r=o.size,d=k.data("mck-id"),m=n+r,g=Xe[m];return b!==d?(pt.updateDraftMessage(g,o),void delete Xe[m]):(C.attr("disabled",!1),p.attr("disabled",!1),c.attr("disabled",!1),delete Xe[m],v.html(i),f.removeClass("vis").addClass("n-vis"),e(".mck-file-box .progress").removeClass("vis").addClass("n-vis"),l.removeAttr("required"),T.push(o),u.data("mckfile",o),p.children("input").val(""),!1)}C.attr("disabled",!1),c.attr("disabled",!1),C.trigger("click")}),e.ajax({type:"GET",url:te+G,global:!1,data:"data="+(new Date).getTime(),crosDomain:!0,success:function(e){var t=new FormData;t.append("files[]",s),y.open("POST",e,!0),y.send(t)},error:function(){}})}return!1}alert(r.toString())}},t.uplaodFileToAWS=function(e,t){var a=new FormData,s=[];if(void 0!==e)if(-1===e.type.indexOf("image")&&s.push("Please upload image file."),s.length>0)alert(s.toString());else{r.attr("disabled",!0),i[0]===t?(C.find(".mck-overlay-box").removeClass("n-vis"),C.removeClass("mck-hover-on"),y.removeClass("n-vis").addClass("vis")):(g.find(".mck-overlay-box").removeClass("n-vis"),g.removeClass("mck-hover-on"),b.removeClass("n-vis").addClass("vis"));var o=new XMLHttpRequest;o.addEventListener("load",function(e){var a=this.responseText;return a&&(i[0]===t?(S.html('<img src="'+a+'"/>'),S.data("iconurl",a),L.html(MCK_LABELS["change.group.icon"]),y.removeClass("vis").addClass("n-vis"),C.addClass("mck-hover-on")):(M.html('<img src="'+a+'"/>'),M.data("iconurl",a),b.removeClass("vis").addClass("n-vis"),g.addClass("mck-hover-on"),setTimeout(function(){f.removeClass("n-vis").addClass("vis")},1500)),setTimeout(function(){m.addClass("n-vis")},1500)),r.attr("disabled",!1),i[0]===t?u.val(""):v.val(""),!1}),a.append("file",e),o.open("post",MCK_BASE_URL+E,!0),o.setRequestHeader("UserId-Enabled",!0),o.setRequestHeader("Authorization","Basic "+h),o.setRequestHeader("Application-Key",F),o.setRequestHeader("Device-Key",I),re&&o.setRequestHeader("Access-Token",re),o.send(a)}},t.deleteFileMeta=function(e){mckUtils.ajax({url:te+A+"?key="+e,type:"post",success:function(){},error:function(){}})},t.getFilePreviewPath=function(e){return"object"==typeof e?'<a href="'+te+x+e.blobKey+'" target="_blank">'+e.name+"</a>":""},t.getFilePreviewSize=function(e){return e?e>o?"("+parseInt(e/o)+" MB)":e>s?"("+parseInt(e/s)+" KB)":"("+parseInt(e)+" B)":""},t.addFileBox=function(t){var a=mckUtils.randomId(),s="";"object"==typeof t.fileMeta&&(a=t.fileMeta.createdAtTime,s=t.fileMeta.name);var o=[{fileNameExpr:t.filelb,fileSizeExpr:t.filesize,fileIdExpr:a,fileName:s}];e.tmpl("fileboxTemplate",o).appendTo("#mck-file-box");var i=e(".mck-file-box."+a),n=i.find(".mck-remove-file"),r=i.find(".progress");"object"==typeof t.fileMeta?(i.data("mckblob",t.fileMeta.blobKey),l.removeAttr("required"),c.attr("disabled",!1),n.attr("disabled",!1),r.removeClass("vis").addClass("n-vis"),T.push(t.fileMeta)):(c.attr("disabled",!0),n.attr("disabled",!0),r.removeClass("n-vis").addClass("vis"))}}function f(){var t,a,s,o,i,n,r,c,l,d,m=this,p="/rest/ws/plugin/update/sw/id";m.init=function(){t=e("#mck-sidebox"),s=e("#mck-msg-preview"),n=e("#mck-group-info-tab"),c=e("#mck-sidebox-launcher"),a=e("#mck-message-cell .mck-message-inner"),o=e("#mck-msg-preview .mck-preview-icon"),i=e("#mck-msg-preview .mck-preview-cont-name"),l=e("#mck-msg-preview .mck-preview-msg-content"),d=e("#mck-msg-preview .mck-preview-file-content")},m.notifyUser=function(e){if(7!==e.type){var t=e.groupId?mckGroupUtils.getGroup(""+e.groupId):pt.fetchContact(""+e.to.split(",")[0]),a=!1;e.groupId&&(a=!0),vt.loadUserProfile(e.to);var s=pt.getTabDisplayName(t.contactId,a);if(m.showNewMessageNotification(e,t,s),ze&&!P){var o=Te,i=pt.getTextForMessagePreview(e,t);if("function"==typeof Ce&&!t.isGroup){var n=Ce(t.contactId);n&&void 0!==n&&(o=n)}mckNotificationUtils.sendDesktopNotification(s,o,i)}}},m.showNewMessageNotification=function(e,t,r){if($e&&102!==e.contentType){var c=a.data("mck-id"),m=a.data("isgroup");if(c===t.contactId&&m===t.isGroup&&!n.hasClass("vis")){if(!e.conversationId||!Be&&!Ue)return;var p=a.data("mck-conversationid");if((p=void 0!==p&&""!==p?p.toString():"")===e.conversationId.toString())return}s.data("isgroup",t.isGroup);var u=e.conversationId?e.conversationId:"";s.data("mck-conversationid",u);var v=pt.getContactImageLink(t,r);if(e.message){var g=pt.getMessageTextForContactPreview(e,t,50);l.html(""),"object"==typeof g?l.append(g):l.html(g),l.removeClass("n-vis").addClass("vis")}else l.html("");e.fileMetaKey?(d.html(pt.getFileIcon(e)),d.removeClass("n-vis").addClass("vis"),""===l.html()&&l.removeClass("vis").addClass("n-vis")):(d.html(""),d.removeClass("vis").addClass("n-vis")),i.html(r),o.html(v),s.data("mck-id",t.contactId),s.show(),setTimeout(function(){s.fadeOut(3e3)},1e4)}},m.unsubscribeToServiceWorker=function(){r&&navigator.serviceWorker.ready.then(function(e){r.unsubscribe().then(function(e){r=null,console.log("Unsubscribed to notification successfully")})})},m.sendSubscriptionIdToServer=function(){if(r){var e=r.endpoint.split("/").slice(-1)[0];e&&mckUtils.ajax({url:MCK_BASE_URL+p,type:"post",data:"registrationId="+e,success:function(e){},error:function(e,t,a){401===e.status&&(sessionStorage.clear(),console.log("Please reload page."))}})}},m.subscribeToServiceWorker=function(){qe&&"serviceWorker"in navigator&&(navigator.serviceWorker.register("./service-worker.js",{scope:"./"}),navigator.serviceWorker.ready.then(function(e){e.pushManager.subscribe({userVisibleOnly:!0}).then(function(e){console.log("The reg ID is:: ",e.endpoint.split("/").slice(-1)),r=e,m.sendSubscriptionIdToServer()})}))}}function k(a){var s,o,i=this,n=a.events,r=null,c=null,l="",d=null,m=[],p="",u=e("#mck-sidebox"),v=e("#mck-tab-title"),g=e(".mck-typing-box"),f=e("#mck-tab-status"),k=(e("#mck-offline-message-box"),e("#mck-typing-label")),C=e("#mck-message-cell .mck-message-inner");i.init=function(){if(void 0!==S){var e=mckUtils.startsWith(S,"https")?"15675":"15674";"function"==typeof t.SockJS&&(p||(p=new SockJS(S+":"+e+"/stomp")),(c=t.Stomp.over(p)).heartbeat.outgoing=0,c.heartbeat.incoming=0,c.onclose=function(){i.disconnect()},c.connect("guest","guest",i.onConnect,i.onError,"/"),t.addEventListener("beforeunload",function(e){i.disconnect()}))}},i.checkConnected=function(e){c.connected?(s&&clearInterval(s),o&&clearInterval(o),s=setInterval(function(){i.connectToSocket(e)},6e5),o=setInterval(function(){i.sendStatus(1)},12e5)):i.connectToSocket(e)},i.connectToSocket=function(e){if(!c.connected){if(e&&"block"===u.css("display")){var t=C.data("mck-id");if(t){var a=C.data("isgroup"),s=C.data("mck-conversationid"),o=C.data("mck-topicid");Qe.clearMckMessageArray(),pt.loadTab({tabId:t,isGroup:a,conversationId:s,topicId:o})}else Qe.clearMckMessageArray(),pt.loadTab({tabId:"",isGroup:!1})}i.init()}},i.stopConnectedCheck=function(){s&&clearInterval(s),o&&clearInterval(o),s="",o="",i.disconnect()},i.disconnect=function(){c&&c.connected&&(i.sendStatus(0),c.disconnect())},i.unsubscibeToTypingChannel=function(){c&&c.connected&&d&&(1===G&&i.sendTypingStatus(0,l),d.unsubscribe()),d=null},i.unsubscibeToNotification=function(){c&&c.connected&&r&&r.unsubscribe(),r=null},i.subscibeToTypingChannel=function(e,t){var a=t?e:Ge;c&&c.connected?d=c.subscribe("/topic/typing-"+F+"-"+a,i.onTypingStatus):i.reconnect()},i.subscribeToOpenGroup=function(e){if(c&&c.connected){var t=c.subscribe("/topic/group-"+F+"-"+e.contactId,i.onOpenGroupMessage);m.push(t.id),z[e.contactId]=t.id}else i.reconnect()},i.sendTypingStatus=function(e,t){if(c&&c.connected){if(1===e&&1===G&&c.send("/topic/typing-"+F+"-"+l,{"content-type":"text/plain"},F+","+Ge+","+e),t){if(t===l&&e===G&&1===e)return;l=t,c.send("/topic/typing-"+F+"-"+t,{"content-type":"text/plain"},F+","+Ge+","+e),setTimeout(function(){G=0},6e4)}else 0===e&&c.send("/topic/typing-"+F+"-"+l,{"content-type":"text/plain"},F+","+Ge+","+e);G=e}},i.onTypingStatus=function(e){if(null!=d&&d.id===e.headers.subscription){var t=e.body,a=t.split(",")[1],s=Number(t.split(",")[2]),o=e.headers.destination.substring(e.headers.destination.lastIndexOf("-")+1,e.headers.destination.length),i=C.data("mck-id"),n=C.data("isgroup"),r=mckGroupUtils.getGroup(i);if(!U[a]&&!_[a])if(1===s){if(!(Ge===a&&n||i!==a&&i!==o)){if(n=C.data("isgroup")){if(a!==Ge){if(dt.authenticateGroupUser(r)||6===r.type&&!he.disableChatForNonGroupMember){v.addClass("mck-tab-title-w-typing"),f.removeClass("vis").addClass("n-vis");var c=pt.getTabDisplayName(a,!1);c=c.split(" ")[0],k.html(c+" "+MCK_LABELS["is.typing"])}7===r.type&&(v.addClass("mck-tab-title-w-typing"),k.html(MCK_LABELS["is.typing"]),f.html(""))}}else v.addClass("mck-tab-title-w-typing"),f.removeClass("vis").addClass("n-vis"),k.html(MCK_LABELS.typing);g.removeClass("n-vis").addClass("vis"),setTimeout(function(){v.removeClass("mck-tab-title-w-typing"),g.removeClass("vis").addClass("n-vis"),v.hasClass(void 0===r||7!=r.type)&&f.removeClass("n-vis").addClass("vis"),k.html(MCK_LABELS.typing)},6e4)}}else v.removeClass("mck-tab-title-w-typing"),g.removeClass("vis").addClass("n-vis"),!v.hasClass("mck-tab-title-w-status")||void 0!==r&&7==r.type||f.removeClass("n-vis").addClass("vis"),k.html(MCK_LABELS.typing)}},i.reconnect=function(){i.unsubscibeToTypingChannel(),i.unsubscibeToNotification(),i.disconnect(),i.init()},i.onError=function(e){t.console.log("Error in channel notification. "+e),n.onConnectFailed()},i.sendStatus=function(e){c&&c.connected&&c.send("/topic/status-v2",{"content-type":"text/plain"},b+","+I+","+e)},i.onConnect=function(){c.connected?(r&&i.unsubscibeToNotification(),r=c.subscribe("/topic/"+b,i.onMessage),i.sendStatus(1),i.checkConnected(!0)):setTimeout(function(){r=c.subscribe("/topic/"+b,i.onMessage),i.sendStatus(1),i.checkConnected(!0)},5e3),n.onConnect()},i.onOpenGroupMessage=function(t){if(-1!==m.indexOf(t.headers.subscription)){var a=e.parseJSON(t.body),s=a.type,o=a.message;if("APPLOZIC_03"===s)Qe.updateLatestMessage(o),0!==o.type&&4!==o.type&&(e("."+o.key+" .mck-message-status").removeClass("mck-icon-time").addClass("mck-icon-sent"),pt.addTooltip(o.key)),n.onMessageSentUpdate({messageKey:o.key});else if("APPLOZIC_01"===s||"APPLOZIC_02"===s||"MESSAGE_RECEIVED"===s){Qe.updateLatestMessage(o);var i=o.groupId?mckGroupUtils.getGroup(o.groupId):pt.getContact(o.to);e("#mck-sidebox-content"),C.data("mck-id");if("APPLOZIC_01"===s||"MESSAGE_RECEIVED"===s){r=pt.getMessageFeed(o);n.onMessageReceived({message:r})}else if("APPLOZIC_02"===s){var r=pt.getMessageFeed(o);n.onMessageSent({message:r})}if(o.conversationId){var c=K[o.conversationId];!Be&&!Ue||"object"==typeof c&&"object"==typeof O[c.topicId]||ut.getTopicId({conversationId:o.conversationId,messageType:s,message:o,notifyUser:a.notifyUser,async:!1,populate:!1})}if(void 0===i){var l={message:o,messageType:s,notifyUser:a.notifyUser};if(o.groupId)dt.getGroupFeedFromMessage(l);else{var d=[];d.push(o.to),vt.getUsersDetail(d,l)}return}pt.populateMessage(s,o,a.notifyUser)}}},i.onMessage=function(a){if(null!=r&&r.id===a.headers.subscription){var s=e.parseJSON(a.body),o=s.type;if("APPLOZIC_04"===o||"MESSAGE_DELIVERED"===o)e("."+s.message.split(",")[0]+" .mck-message-status").removeClass("mck-icon-time").removeClass("mck-icon-sent").addClass("mck-icon-delivered"),pt.addTooltip(s.message.split(",")[0]),n.onMessageDelivered({messageKey:s.message.split(",")[0]});else if("APPLOZIC_08"===o||"MT_MESSAGE_DELIVERED_READ"===o)e("."+s.message.split(",")[0]+" .mck-message-status").removeClass("mck-icon-time").removeClass("mck-icon-sent").removeClass("mck-icon-delivered").addClass("mck-icon-read"),pt.addTooltip(s.message.split(",")[0]),n.onMessageRead({messageKey:s.message.split(",")[0]});else if("APPLOZIC_05"===o){var i=s.message.split(",")[0],c=s.message.split(",")[1],l="1"===s.message.split(",")[2];pt.removedDeletedMessage(i,c,l);var d={messageKey:s.message.split(",")[0]};l?d.groupId=c:d.userKey=c,console.log(d),n.onMessageDeleted(d)}else if("APPLOZIC_27"===o){var m=s.message.split(",")[0],p=s.message.split(",")[1];if(void 0!==m){pt.removeConversationThread(m,!1),pt.updateUnreadCount("user_"+m,0,!0);h={userId:m};p&&(h.topicId=p),n.onConversationDeleted(h)}}else if("APPLOZIC_11"===o){var m=s.message,u=pt.fetchContact(m),c=C.data("mck-id");if(!U[m]&&!_[m]){if(c!==u.contactId||C.data("isgroup")){var k=mckContactUtils.formatContactId(m);e("#li-user-"+k+" .mck-ol-status").removeClass("n-vis").addClass("vis")}else e("#mck-tab-status").html(MCK_LABELS.online),De&&pt.hideOfflineMessage();e(".mck-user-ol-status."+k).removeClass("n-vis").addClass("vis"),e(".mck-user-ol-status."+k).next().html("("+MCK_LABELS.online+")"),t.MCK_OL_MAP[m]=!0,lt.updateUserStatus({userId:s.message,status:1})}n.onUserConnect({userId:s.message})}else if("APPLOZIC_12"===o){var m=s.message.split(",")[0],b=s.message.split(",")[1],u=pt.fetchContact(m);t.MCK_OL_MAP[m]=!1,b&&(N[m]=b),U[m]||_[m]||((c=C.data("mck-id"))!==u.contactId||C.data("isgroup")||(e("#mck-tab-status").html(mckDateUtils.getLastSeenAtStatus(b)),De&&rt.manageOfflineMessageTime(c)),e(".mck-user-ol-status."+u.htmlId).removeClass("vis").addClass("n-vis"),e(".mck-user-ol-status."+u.htmlId).next().html("(Offline)"),e("#li-user-"+k+" .mck-ol-status").removeClass("vis").addClass("n-vis"),lt.updateUserStatus({userId:m,status:0,lastSeenAtTime:b})),n.onUserDisconnect({userId:m,lastSeenAtTime:b})}else if("APPLOZIC_29"===o){var m=s.message.split(",")[0],p=s.message.split(",")[1],u=pt.fetchContact(m);pt.updateUnreadCount("user_"+u.contactId,0,!0),void 0!==(c=C.data("mck-id"))&&""!==c||(e("#li-user-"+u.htmlId+" .mck-unread-count-text").html(pt.getUnreadCount("user_"+u.contactId)),e("#li-user-"+u.htmlId+" .mck-unread-count-box").removeClass("vis").addClass("n-vis"));h={userId:m};p&&(h.topicId=p),n.onConversationReadFromOtherSource(h)}else if("APPLOZIC_28"===o){var m=s.message.split(",")[0],p=s.message.split(",")[1];(c=C.data("mck-id"))===m&&(e(".mck-msg-right .mck-message-status").removeClass("mck-icon-time").removeClass("mck-icon-sent").removeClass("mck-icon-delivered").addClass("mck-icon-read"),e(".mck-msg-right .mck-icon-delivered").attr("title","delivered and read"),void 0===(u=pt.getContact(m))&&((L=[]).push(m),vt.getUsersDetail(L,{})));var h={userId:m};p&&(h.topicId=p),n.onConversationRead(h)}else if("APPLOZIC_16"===o){var y=s.message.split(":")[0],m=s.message.split(":")[1],u=pt.fetchContact(m);(c=C.data("mck-id"))===u.contactId?y===Ze[0]?(U[u.contactId]=!0,lt.toggleBlockUser(c,!0)):(_[u.contactId]=!0,v.removeClass("mck-tab-title-w-status"),f.removeClass("vis").addClass("n-vis"),g.removeClass("vis").addClass("n-vis")):e("#li-user-"+u.htmlId+" .mck-ol-status").removeClass("vis").addClass("n-vis"),n.onUserBlocked({status:y,userId:m})}else if("APPLOZIC_17"===o){var y=s.message.split(":")[0],m=s.message.split(":")[1],u=pt.fetchContact(m);(c=C.data("mck-id"))===u.contactId?y===Ze[2]?(U[u.contactId]=!1,lt.toggleBlockUser(c,!1)):(t.MCK_OL_MAP[c]||N[c])&&(_[u.contactId]=!1,U[c]||(t.MCK_OL_MAP[c]?f.html(MCK_LABELS.online):N[c]&&f.html(mckDateUtils.getLastSeenAtStatus(N[c])),v.addClass("mck-tab-title-w-status"),f.removeClass("n-vis").addClass("vis"))):t.MCK_OL_MAP[c]&&e("#li-user-"+u.htmlId+" .mck-ol-status").removeClass("n-vis").addClass("vis"),n.onUserUnblocked({status:y,userId:m})}else if("APPLOZIC_18"===o)W=!1,n.onUserActivated();else if("APPLOZIC_19"===o)W=!0,n.onUserDeactivated();else{var I=s.message;if("APPLOZIC_03"===o)Qe.updateLatestMessage(I),0!==I.type&&4!==I.type&&(e("."+I.key+" .mck-message-status").removeClass("mck-icon-time").addClass("mck-icon-sent"),pt.addTooltip(I.key)),n.onMessageSentUpdate({messageKey:I.key});else if("APPLOZIC_01"===o||"APPLOZIC_02"===o||"MESSAGE_RECEIVED"===o){Qe.updateLatestMessage(I);var u=I.groupId?mckGroupUtils.getGroup(I.groupId):pt.getContact(I.to),c=(e("#mck-sidebox-content"),C.data("mck-id"));if("APPLOZIC_01"===o||"MESSAGE_RECEIVED"===o){M=pt.getMessageFeed(I);n.onMessageReceived({message:M})}else if("APPLOZIC_02"===o){var M=pt.getMessageFeed(I);n.onMessageSent({message:M})}if(I.conversationId){var S=K[I.conversationId];!Be&&!Ue||"object"==typeof S&&"object"==typeof O[S.topicId]||ut.getTopicId({conversationId:I.conversationId,messageType:o,message:I,notifyUser:s.notifyUser,async:!1,populate:!1})}if(void 0===u){var T={message:I,messageType:o,notifyUser:s.notifyUser};if(I.groupId)dt.getGroupFeedFromMessage(T);else{var L=[];L.push(I.to),vt.getUsersDetail(L,T)}return}if(102==I.contentType&&ee)if(s.notifyUser=!1,4==I.type&&"CALL_DIALED"==I.metadata.MSG_TYPE){var u=pt.fetchContact(I.to),x=pt.getTabDisplayName(u.contactId,!1),G=pt.getContactImageLink(u,x);e("#mck-video-call-indicator").data("call-id",I.metadata.CALL_ID),e("#mck-video-call-indicator").data("isAudioCall",I.metadata.CALL_AUDIO_ONLY),e("#mck-video-call-indicator-txt").html(x+" calling..."),e("#mck-video-call-icon").html(G),e("#mck-video-call-indicator").removeClass("n-vis").addClass("vis"),bt.play(),setTimeout(function(){e("#mck-video-call-indicator").data("callReceived")||(console.log("call is not answered"),bt.stop(),e("#mck-video-call-indicator").addClass("n-vis").removeClass("vis"))},6e4)}else 4==I.type&&"CALL_REJECTED"==I.metadata.MSG_TYPE&&e("#mck-btn-video-call").data("isCallHost")&&(ut.sendVideoCallMessage(I.metadata.CALL_ID,"CALL_REJECTED",103,!1),kt.ringToneForHost.stop(),kt.outgoingCallServices.twilioService.leaveRoomIfJoined(),kt.hideVideoBox(),kt.outgoingCallServices&&(kt.outgoingCallServices.rejectedByReceiver=!0));103==I.contentType?4==I.type&&"CALL_MISSED"==I.metadata.MSG_TYPE&&(e("#mck-video-call-indicator").addClass("n-vis").removeClass("vis"),bt&&bt.stop()):pt.populateMessage(o,I,s.notifyUser)}}}}}function C(){var t=this;t.token=null,t.Identity=null,t.outgoingCallServices=null,t.incomingCallServices=null;var a=e(".mck-videocall-btn"),s=e(".applozic-vid-container"),o=e("#mck-sidebox"),i=e("#mck-video-call-indicator");t.hideVideoBox=function(){s.addClass("n-vis").removeClass("vis"),o.addClass("vis").removeClass("n-vis"),i.addClass("n-vis").removeClass("vis")},t.init=function(){t.token=null!==Qe.getAppHeaders()?Qe.getAppHeaders().videoToken:void 0,t.ringToneForHost=j.loadRingTone(MCK_BASE_URL+"/resources/sidebox/audio/applozic_video_call_ring_tone.mp3"),e("#mck-btn-video-call").on("click",function(a){if(t.token){var s=Ge+(new Date).getTime().toString()+Math.random().toString(36).slice(2),o=ut.sendVideoCallMessage(s,"CALL_DIALED",102,!1),i=pt.fetchContact(o.to),n=pt.getTabDisplayName(i.contactId,!1),r=pt.getContactImageLink(i,n),c=!1,l=!0,d=new Date,m=Ge;t.outgoingCallServices=new MckCallingService(m,kt.token,s,n,l,d,ut,r,c,t.ringToneForHost),t.outgoingCallServices.startVideoCall(),e("#mck-btn-video-call").data("isCallHost",!0),e("#mck-btn-video-call").data("callStartTime",d)}else alert("missing token... please refresh page..")}),e("#mck-vid-receive-btn").on("click",function(t){console.log("call received"),$("#mck-video-call-indicator").addClass("n-vis").removeClass("vis"),a.removeClass("vis").addClass("n-vis");var s=e("#mck-video-call-indicator").data("call-id"),o=e("#mck-video-call-indicator").data("isAudioCall");e("#mck-video-call-indicator").data("callReceived",!0),e("#mck-video-call-indicator").addClass("n-vis"),kt.callReceived(s,o)}),e("#mck-vid-reject-btn").on("click",function(t){console.log("call rejected");var a=e("#mck-video-call-indicator").data("call-id"),s=e("#mck-video-call-indicator").data("isAudioCall");kt.callRejected(a,s),e("#mck-video-call-indicator").addClass("n-vis").removeClass("vis")})},t.InitilizeVideoClient=function(a,s){t.Identity=a,e.ajax({url:MCK_BASE_URL+"/twilio/token",type:"post",contentType:"application/x-www-form-urlencoded",data:{identity:a,device:s},success:function(e){if(null!=e&&""!=e){t.token=e.token;var a=Qe.getAppHeaders();a.videoToken=e.token,Qe.setAppHeaders(a)}},error:function(e){console.log("error while getting token"+e)}})},t.callReceived=function(e,a){console.log("_this.callReceived"),bt&&bt.stop();ut.sendVideoCallMessage(e,"CALL_ANSWERED",102,a);var s=!1;t.incomingCallServices=new MckCallingService(t.Identity,t.token,e,null,s,null,ut,null,a),t.incomingCallServices.startVideoCall()},t.callRejected=function(e,t){bt&&bt.stop();ut.sendVideoCallMessage(e,"CALL_REJECTED",102,t)}}var b,h,y=this;MCK_GROUP_MAP=[];var I,M,S,T=[],L=!0,x=[],G=0;MCK_CLIENT_GROUP_MAP=[];var E,A=!1,U=[],_=[],w=90,D=[],O=[],N=[],K=[],P=!0,R=0,B=s.mode;MCK_LABELS=s.labels,MCK_BASE_URL=s.baseUrl;var j,F=s.appId,z=[],q=0,H=[0,1,2,3],V=[1,2,5,6],J=[],W=!1,Y=s.launcher,Z=s.visitor,Q=s.userName,X=s.locShare,ee=s.video,te=s.fileBaseUrl,ae=s.onInit,se=s.onTopicDetails,oe=[0,1,2],ie=s.onClose,ne=s.displayText,re=s.accessToken,ce=s.readConversation,le=s.maxGroupSize,de=s.onTabClicked,me=s.contactNumber,pe=s.maxAttachmentSize,ue=s.appModuleName,ve=s.getTopicDetail,ge=s.contactDisplayName,fe=s.validateMessage,ke=s.finalPriceResponse,Ce=s.contactDisplayImage,be=s.priceWidget,he=s.openGroupSettings,ye=s.offlineMessageDetail,Ie=s.initAutoSuggestions,Me=s.authenticationTypeId,Se=s.getConversationDetail,Te=s.notificationIconLink,Le=s.mapStaticAPIkey,xe=s.notificationSoundLink?s.notificationSoundLink:"",Ge=Z?"guest":e.trim(s.userId),Ee=X?s.googleApiKey:"NO_ACCESS",Ae=void 0===s.source?1:s.source,Ue="boolean"==typeof s.topicBox&&s.topicBox,_e="boolean"==typeof s.olStatus&&s.olStatus,we="boolean"==typeof s.messageBubbleAvator&&s.messageBubbleAvator,De="boolean"==typeof s.showOfflineMessage&&s.showOfflineMessage,Oe="boolean"==typeof s.hideGroupSubtitle&&s.hideGroupSubtitle,Ne=void 0===s.defaultMessageMetaData?{}:s.defaultMessageMetaData,Ke="boolean"==typeof s.groupUserCount&&s.groupUserCount,Pe="boolean"==typeof s.checkUserBusyWithStatus&&s.checkUserBusyWithStatus,Re="boolean"==typeof s.resetUserStatus&&s.resetUserStatus,Be="boolean"==typeof s.topicHeader&&s.topicHeader,je=s.supportId?'data-mck-id="'+s.supportId+'"':"",Fe="boolean"==typeof s.loadOwnContacts&&s.loadOwnContacts,ze="boolean"==typeof s.desktopNotification&&s.desktopNotification,$e="boolean"!=typeof s.notification||s.notification,qe="boolean"==typeof s.swNotification&&s.swNotification,He="boolean"!=typeof s.autoTypeSearchEnabled||s.autoTypeSearchEnabled,Ve="boolean"==typeof s.launchOnNewMessage&&s.launchOnNewMessage,Je="boolean"==typeof s.launchOnUnreadMessage&&s.launchOnUnreadMessage,We="number"==typeof s.userTypeId&&s.userTypeId,Ye=["DEFAULT","NEW","OPEN"],Ze=["BLOCKED_TO","BLOCKED_BY","UNBLOCKED_TO","UNBLOCKED_BY"],Qe=new p,Xe=new Object,et=new Array,tt=new Array,at=new Object,st=new Array,ot=new Array,it=new Array,nt=new Array,rt=new n,ct=new u,lt=new l,dt=(new v,new m),mt=new g,pt=new c,ut=new r,vt=new d,gt=new f,ft=e(".chat-launcher-icon"),kt=new C,Ct=null,bt=null;t.MCK_OL_MAP=new Array,y.events={onConnectFailed:function(){},onConnect:function(){},onMessageDelivered:function(){},onMessageRead:function(){},onMessageDeleted:function(){},onConversationDeleted:function(){},onUserConnect:function(){},onUserDisconnect:function(){},onConversationReadFromOtherSource:function(){},onConversationRead:function(){},onMessageReceived:function(){},onMessageSentUpdate:function(){},onMessageSent:function(){},onUserBlocked:function(){},onUserUnblocked:function(){},onUserActivated:function(){},onUserDeactivated:function(){}};var ht=new k(y);y.getOptions=function(){return s},y.init=function(){Ct=new Audio(xe),ut.init(),mt.init(),rt.initializeApp(s,!1),gt.init(),ct.init(),pt.initEmojis(),ee&&(j=new RingToneService,bt=j.loadRingTone(MCK_BASE_URL+"/resources/sidebox/audio/applozic_video_call_ring_tone.mp3"),kt.init())},y.reInit=function(a){"object"===e.type(a)&&(a=e.extend(!0,{},o,a),t.sessionStorage.clear(),b="",h="",T=[],MCK_GROUP_MAP=[],L=!0,x=[],I="",B=a.mode,M="",U=[],_=[],A=!1,w=90,F=a.appId,N=[],K=[],O=[],MCK_CLIENT_GROUP_MAP=[],P=!0,MCK_LABELS=a.labels,R=0,MCK_BASE_URL=a.baseUrl,Xe=new Object,et=new Array,Y=a.launcher,q=0,z=[],Q=a.userName,Z=a.visitor,J=[],tt=new Array,at=new Object,te=a.fileBaseUrl,X=a.locShare,ee=s.video,ae=a.onInit,se=a.onTopicDetails,st=new Array,ot=new Array,ie=a.onClose,re=a.accessToken,ne=a.displayText,ce=a.readConversation,le=a.maxGroupSize,nt=new Array,de=a.onTabClicked,me=a.contactNumber,ue=a.appModuleName,ve=a.getTopicDetail,pe=a.maxAttachmentSize,fe=a.validateMessage,ge=a.contactDisplayName,it=new Array,ke=a.finalPriceResponse,Ce=a.contactDisplayImage,be=a.priceWidget,he=s.openGroupSettings,ye=a.offlineMessageDetail,Ie=a.initAutoSuggestions,Se=a.getConversationDetail,Me=a.authenticationTypeId,Ge=Z?"guest":e.trim(a.userId),Ee=X?a.googleApiKey:"NO_ACCESS",_e="boolean"==typeof a.olStatus&&a.olStatus,Ue="boolean"==typeof a.topicBox&&a.topicBox,De="boolean"==typeof a.showOfflineMessage&&a.showOfflineMessage,Be="boolean"==typeof a.topicHeader&&a.topicHeader,$e="boolean"!=typeof a.notification||a.notification,qe="boolean"==typeof a.swNotification&&a.swNotification,je=a.supportId?'data-mck-id="'+a.supportId+'"':"",Oe="boolean"==typeof a.hideGroupSubtitle&&a.hideGroupSubtitle,Ne=void 0===a.defaultMessageMetaData?{}:a.defaultMessageMetaData,Ke="boolean"==typeof a.groupUserCount&&a.groupUserCount,ze="boolean"==typeof a.desktopNotification&&a.desktopNotification,Fe="boolean"==typeof a.loadOwnContacts&&a.loadOwnContacts,we="boolean"==typeof a.messageBubbleAvator&&a.messageBubbleAvator,Re="boolean"==typeof s.resetUserStatus&&s.resetUserStatus,Ve="boolean"==typeof a.launchOnNewMessage&&a.launchOnNewMessage,He="boolean"!=typeof a.autoTypeSearchEnabled||a.autoTypeSearchEnabled,Pe="boolean"==typeof a.checkUserBusyWithStatus&&a.checkUserBusyWithStatus,Je="boolean"==typeof a.launchOnUnreadMessage&&a.launchOnUnreadMessage,a.userId&&a.appId&&""!==e.trim(a.userId)&&""!==e.trim(a.appId)?(rt.initializeApp(a,!0),s=a):t.console("Oops! looks like incorrect application id or user Id."))},y.loadTabView=function(t){void 0===t.isGroup&&(t.isGroup=!1),pt.loadTab(t),e("#mck-search").val("")},y.loadTab=function(t){pt.loadTab({tabId:t,isGroup:!1}),e("#mck-search").val("")},y.loadChat=function(t){if(!(void 0!==t.userId&&""!==t.userId||void 0!==t.groupId&&""!==t.groupId||void 0!==t.clientGroupId&&""!==t.clientGroupId))return"UserId or groupId or clientGroupId required";var a={tabId:t.userId,isGroup:!1},a={};if(t.userId&&(a.tabId=userId,a.isGroup=!1),t.displayName&&(a.userName=t.displayName),t.convId&&(a.conversationId=t.convId),t.groupId||t.clientGroupId)if(a.isGroup=!0,t.clientGroupId){if(a.clientGroupId=t.clientGroupId,"object"!=typeof(s=mckGroupUtils.getGroupByClientGroupId(t.clientGroupId)))return mckGroupService.getGroupFeed({clientGroupId:a.clientGroupId,apzCallback:dt.onGroupFeed,callback:dt.loadGroupTab}),void e("#mck-search").val("");a.tabId=s.contactId}else{var s=mckGroupUtils.getGroup(t.groupId);if("object"!=typeof s)return mckGroupService.getGroupFeed({groupId:t.groupId,apzCallback:dt.onGroupFeed,callback:dt.loadGroupTab}),void e("#mck-search").val("");a.tabId=t.groupId}pt.loadTab(a),e("#mck-search").val("")},y.uploadFile=function(e){mt.uploadFile(e)},y.audioAttach=function(e){mt.audioRecoder(e)},y.loadGroupTab=function(t){if(void 0===t||""===t)return"GroupId required";"object"==typeof mckGroupUtils.getGroup(t)?(pt.loadTab({tabId:t,isGroup:!0}),e("#mck-search").val("")):mckGroupService.getGroupFeed({groupId:t,apzCallback:dt.onGroupFeed,callback:dt.loadGroupTab})},y.loadGroupTabByClientGroupId=function(t){if(void 0===t.clientGroupId||""===t.clientGroupId)return"Client Group Id Required";var a=mckGroupUtils.getGroupByClientGroupId(t.clientGroupId);"object"==typeof a?(pt.loadTab({tabId:a.contactId,isGroup:!0}),e("#mck-search").val("")):mckGroupService.getGroupFeed({clientGroupId:t.clientGroupId,apzCallback:dt.onGroupFeed,callback:dt.loadGroupTab})},y.loadConvTab=function(e){"object"==typeof e&&e.userId&&e.convId&&pt.loadTab({tabId:e.userId,conversationId:e.convId,isGroup:!1})},y.loadTabWithTopic=function(e){if("object"==typeof e&&e.userId&&e.topicId){var t={tabId:e.userId,topicId:e.topicId};if(e.userName&&(t.userName=e.userName),e.topicStatus?t.topicStatus=-1===Ye.indexOf(e.topicStatus)?Ye[0]:e.topicStatus.toString():t.topicStatus=Ye[0],"function"==typeof ve){var a=ve(e.topicId);"object"==typeof a&&"undefined"!==a.title&&(O[e.topicId]=a)}if(e.message){var s={type:5,contentType:0,message:message};t.messagePxy=s,t.isMessage=!0}else t.isMessage=!1;e.supportId?(t.isGroup=!0,t.supportId=supportId):t.isGroup=!1,ut.getConversationId(t)}else{if(!e.userId)return"UserId required";if(!e.topicId)return"TopicId required"}},y.loadContacts=function(e){pt.loadContacts(e)},y.setOffline=function(){void 0!==ht&&ht.sendStatus(0)},y.logout=function(){void 0!==ht&&ht.disconnect(),L=!1},y.setOnline=function(){void 0!==ht&&ht.sendStatus(1)},y.getUserStatus=function(e){"function"==typeof e.callback&&(void 0!==e.userIds?vt.getUsersDetail(e.userIds,e):vt.getUserStatus(e))},y.getGroupList=function(e){return"function"==typeof e.callback?(e.apzCallback=dt.loadGroups,mckGroupService.loadGroups(e),"success"):"Callback Function Required"},y.leaveGroup=function(e){return"object"!=typeof e?"Unsupported Format. Please check format":"function"==typeof e.callback?void 0!==e.groupId&&""!==e.groupId||void 0!==e.clientGroupId&&""!==e.clientGroupId?(e.apzCallback=dt.onGroupLeft,mckGroupService.leaveGroup(e),"success"):void e.callback({status:"error",errorMessage:"GroupId or Client GroupId Required"}):"Callback Function Required"},y.addGroupMember=function(e){return"object"!=typeof e?"Unsupported Format. Please check format":"function"==typeof e.callback?void 0!==e.groupId&&""!==e.groupId||void 0!==e.clientGroupId&&""!==e.clientGroupId?void 0===e.userId||""===e.userId?void e.callback({status:"error",errorMessage:"UserId required"}):void 0!==e.role&&-1===H.indexOf(e.role)?void e.callback({status:"error",errorMessage:"Incorrect member role"}):(vt.loadUserProfile(e.userId),e.apzCallback=dt.onAddedGroupMember,mckGroupService.addGroupMember(e),"success"):void e.callback({status:"error",errorMessage:"GroupId or clientGroupId required"}):"Callback function required"},y.removeGroupMember=function(e){return"object"!=typeof e?"Unsupported Format. Please check format":"function"==typeof e.callback?void 0!==e.groupId&&""!==e.groupId||void 0!==e.clientGroupId&&""!==e.clientGroupId?void 0===e.userId||""===e.userId?void e.callback({status:"error",errorMessage:"UserId required"}):(e.apzCallback=dt.onRemovedGroupMember,mckGroupService.removeGroupMember(e),"success"):void e.callback({status:"error",errorMessage:"GroupId or clientGroupId required"}):"Callback function required"},y.updateGroupInfo=function(t){if("object"!=typeof t)return"Unsupported format. Please check format";if("function"==typeof t.callback){if(!(void 0!==t.groupId&&""!==t.groupId||void 0!==t.clientGroupId&&""!==t.clientGroupId))return void t.callback({status:"error",errorMessage:"GroupId or clientGroupId required"});if(!(void 0!==t.name&&""!==t.name||void 0!==t.imageUrl&&""!==t.imageUrl||t.users&&0!==t.users.length))return void t.callback({status:"error",errorMessage:"Group properties required"});if(t.users&&t.users.length>0){a=[];if(e.each(t.users,function(e,t){t.userId&&void 0!==t.role&&-1!==H.indexOf(t.role)&&a.push(t)}),0===a.length)return void t.callback({status:"error",errorMessage:"Incorrect users detail"})}var a=[];return e(".mck-group-change-role-box.vis").each(function(t,s){var o=e(this),i=parseInt(o.find("select").val());if(i!==o.parents(".mck-li-group-member").data("role")){var n={userId:o.parents(".mck-li-group-member").data("mck-id"),role:i};a.push(n)}}),t.apzCallback=dt.onUpdateGroupInfo,mckGroupService.updateGroupInfo(t),"success"}return"Callback function required"},y.getMessages=function(e){"function"==typeof e.callback&&ut.getMessages(e)},y.getMessageList=function(e){return void 0!==e&&"function"==typeof e.callback?(ut.getMessageList(e),"success"):"Callback function required"},y.getMessageListByTopicId=function(e){if("object"!=typeof e)return"Unsupported format. Please check format";if("function"==typeof e.callback){if(!(void 0!==e.id&&""!==e.id||void 0!==e.clientGroupId&&""!==e.clientGroupId))return void e.callback({status:"error",errorMessage:"Id or clientGroupId required"});if(e.id&&"boolean"!=typeof e.isGroup)return void e.callback({status:"error",errorMessage:"IsGroup parameter required"});if(!e.topicId)return void e.callback("TopicId required");e.id&&(e.tabId=e.id),e.topicStatus=Ye[0];var t=J[e.topicId];return t&&"object"==typeof K[t]?(e.conversationId=t,ut.getMessageList(e)):(e.isExtMessageList=!0,e.pageSize=1,ut.fetchConversationByTopicId(e)),"success"}return"Callback function required."},y.sendMessage=function(t){if("object"==typeof t){var a=(t=e.extend(!0,{},i,t)).message;if(!t.to)return"To field required";if(void 0===a||""===a)return"Message field required";if(t.type>12)return"Invalid message type";a=e.trim(a);var s={to:e.trim(t.to),type:t.messageType,contentType:t.type,message:a};return ut.sendMessage(s),"success"}return"Unsupported format. Please check format"},y.sendGroupMessage=function(t){if("object"==typeof t){var a=(t=e.extend(!0,{},i,t)).message;if(!t.groupId&&!t.clientGroupId)return"groupId or clientGroupId required";if(void 0===a||""===a)return"message field required";if(t.type>12)return"invalid message type";a=e.trim(a);var s={type:t.messageType,contentType:t.type,message:a};if(t.groupId)s.groupId=e.trim(t.groupId);else if(t.clientGroupId){if(void 0===mckGroupUtils.getGroupByClientGroupId(t.clientGroupId))return"group not found";s.clientGroupId=e.trim(t.clientGroupId)}return ut.sendMessage(s),"success"}return"Unsupported format. Please check format"},y.addWelcomeMessage=function(e){return"object"!=typeof e?"Unsupported format. Please check format":void 0===e.sender||""===e.sender?"Sender Field Required":void 0===e.messageContent||""===e.messageContent?"Message Content Required":void ut.sendWelcomeMessage(e)},y.createGroup=function(e){if("object"==typeof e){if("function"==typeof e.callback){var t=e.users;return void 0===t||t.length<1?void e.callback({status:"error",errorMessage:"Users list required"}):t.length>le?void e.callback({status:"error",errorMessage:"Users limit exceeds "+le+". Max number of users allowed is "+le+"."}):e.groupName?void 0===e.type||""===e.type?void e.callback({status:"error",errorMessage:"Group type required"}):-1===V.indexOf(e.type)?void e.callback({status:"error",errorMessage:"Invalid group type"}):(ut.getGroup(e),"success"):void e.callback({status:"error",errorMessage:"Group name required"})}return"Callback function required"}return"Unsupported Format. Please check format"},y.initGroupTab=function(e){if("object"==typeof e){var t=e.users;return void 0===t||t.length<1?"Users List Required":t.length>le?"Users limit exceeds "+le+". Max number of users allowed is "+le+".":e.groupName?void 0===e.type?"Group type required":-1===V.indexOf(e.type)?"Invalid group type":(ut.getGroup(e),"success"):"Group name required"}return"Unsupported format. Please check format"},y.getTotalUnreadCount=function(){return R},y.subscribeToEvents=function(e){"object"==typeof e&&("function"==typeof e.onConnectFailed&&(y.events.onConnectFailed=e.onConnectFailed),"function"==typeof e.onConnect&&(y.events.onConnect=e.onConnect),"function"==typeof e.onMessageDelivered&&(y.events.onMessageDelivered=e.onMessageDelivered),"function"==typeof e.onMessageRead&&(y.events.onMessageRead=e.onMessageRead),"function"==typeof e.onMessageDeleted&&(y.events.onMessageDeleted=e.onMessageDeleted),"function"==typeof e.onConversationDeleted&&(y.events.onConversationDeleted=e.onConversationDeleted),"function"==typeof e.onUserConnect&&(y.events.onUserConnect=e.onUserConnect),"function"==typeof e.onUserDisconnect&&(y.events.onUserDisconnect=e.onUserDisconnect),"function"==typeof e.onConversationReadFromOtherSource&&(y.events.onConversationReadFromOtherSource=e.onConversationReadFromOtherSource),"function"==typeof e.onConversationRead&&(y.events.onConversationRead=e.onConversationRead),"function"==typeof e.onMessageReceived&&(y.events.onMessageReceived=e.onMessageReceived),"function"==typeof e.onMessageSentUpdate&&(y.events.onMessageSentUpdate=e.onMessageSentUpdate),"function"==typeof e.onMessageSent&&(y.events.onMessageSent=e.onMessageSent),"function"==typeof e.onUserBlocked&&(y.events.onUserBlocked=e.onUserBlocked),"function"==typeof e.onUserUnblocked&&(y.events.onUserUnblocked=e.onUserUnblocked),"function"==typeof e.onUserActivated&&(y.events.onUserActivated=e.onUserActivated),"function"==typeof e.onUserDeactivated&&(y.events.onUserDeactivated=e.onUserDeactivated))},y.getConversation=function(e){ut.getTopicId({conversationId:e.conversationId})}}var o={baseUrl:"https://apps.applozic.com",fileBaseUrl:"https://applozic.appspot.com",notificationIconLink:"",notificationSoundLink:"",mapStaticAPIkey:"AIzaSyCWRScTDtbt8tlXDr6hiceCsU83aS2UuZw",launcher:"applozic-launcher",userId:null,appId:null,userName:null,contactNumber:null,email:null,supportId:null,mode:"standard",visitor:!1,olStatus:!1,groupUserCount:!1,desktopNotification:!1,locShare:!1,maxAttachmentSize:25,notification:!0,launchOnUnreadMessage:!1,loadOwnContacts:!1,maxGroupSize:100,authenticationTypeId:0,labels:{"conversations.title":"Conversations","start.new":"Start New","search.contacts":"Contacts","search.groups":"Groups","empty.groups":"No groups yet!","empty.contacts":"No contacts yet!","empty.messages":"No messages yet!","no.more.messages":"No more messages!","empty.conversations":"No conversations yet!","no.more.conversations":"No more conversations!","search.placeholder":"Search...","location.placeholder":"Enter a location","create.group.title":"Create Group","members.title":"Members","add.members.title":"Add Member","remove.member":"Remove Member","change.role":"Change Role","group.info.update":"Update","group.info.updating":"Updating...","add.group.icon":"Add Group Icon","group.deleted":"Group has been deleted","change.group.icon":"Change Group Icon","group.title":"Group Title","group.type":"Group Type","group.create.submit":"Creating Group...",blocked:"You have blocked this user","group.chat.disabled":"You are no longer part of this group!","block.user.alert":"Are you sure you want to block this user?","unblock.user.alert":"Are you sure you want to unblock this user?","exit.group.alert":"Are you sure you want to exit this group?","remove.member.alert":"Are you sure you want to remove this member?","clear.messages.alert":"Are you sure you want to delete all the conversation?",typing:"typing...","is.typing":"is typing...",online:"Online","clear.messages":"Clear Messages",delete:"Delete",reply:"Reply",forward:"Forward",copy:"Copy","block.user":"Block User","unblock.user":"Unblock User","group.info.title":"Group Info","exit.group":"Exit Group","location.share.title":"Location Sharing","my.location":"My Location",send:"Send","send.message":"Send Message",smiley:"Smiley",close:"Close",edit:"Edit",save:"Save","file.attachment":"Files & Photos","file.attach.title":"Attach File","last.seen":"Last seen","last.seen.on":"Last seen on",ago:"ago","group.metadata":{CREATE_GROUP_MESSAGE:":adminName created group :groupName",REMOVE_MEMBER_MESSAGE:":adminName removed :userName",ADD_MEMBER_MESSAGE:":adminName added :userName",JOIN_MEMBER_MESSAGE:":userName joined",GROUP_NAME_CHANGE_MESSAGE:"Group name changed to :groupName",GROUP_ICON_CHANGE_MESSAGE:"Group icon changed",GROUP_LEFT_MESSAGE:":userName left",DELETED_GROUP_MESSAGE:":adminName deleted group",GROUP_USER_ROLE_UPDATED_MESSAGE:":userName is :role now",GROUP_META_DATA_UPDATED_MESSAGE:"",ALERT:"",HIDE:""}},openGroupSettings:{deleteChatAccess:0,allowInfoAccessGroupMembers:!0,disableChatForNonGroupMember:!1,defaultChatDisabledMessage:"Chat Disabled!"}},i={messageType:5,type:0};e.fn.applozic=function(t,a){var i=e("#mck-sidebox");"object"===e.type(t)&&(t=e.extend(!0,{},o,t));var n=void 0;if(void 0!==i.data("applozic_instance"))if(n=i.data("applozic_instance"),"string"===e.type(t))switch(t){case"reInitialize":return n.reInit(a);case"loadConvTab":n.loadConvTab(a);break;case"loadTab":n.loadTab(a);break;case"uploadFile":n.uploadFile(a);break;case"loadTabView":n.loadTabView(a);break;case"loadChat":n.loadChat(a);break;case"loadContextualTab":return n.loadTabWithTopic(a);case"audioAttach":n.audioAttach(a);break;case"addWelcomeMessage":n.addWelcomeMessage(a);break;case"loadContacts":n.loadContacts(a);break;case"sendMessage":return n.sendMessage(a);case"sendGroupMessage":return n.sendGroupMessage(a);case"createGroup":return n.createGroup(a);case"loadBroadcastTab":case"initBroadcastTab":return a.groupName=a.groupName?a.groupName:"Broadcast",a.type=5,n.initGroupTab(a);case"initGroupTab":return n.initGroupTab(a);case"loadGroupTab":return n.loadGroupTab(a);case"loadGroupTabByClientGroupId":return n.loadGroupTabByClientGroupId(a);case"setOffline":case"setOnline":return n.setOffline(),"success";case"logout":return n.logout(),"success";case"getUserDetail":return n.getUserStatus(a),"success";case"getGroupList":return n.getGroupList(a),"success";case"leaveGroup":return n.leaveGroup(a);case"addGroupMember":return n.addGroupMember(a);case"removeGroupMember":return n.removeGroupMember(a);case"updateGroupInfo":return n.updateGroupInfo(a);case"getMessages":n.getMessages(a);break;case"messageList":return n.getMessageList(a);case"getMessageListByTopicId":return n.getMessageListByTopicId(a);case"getTotalUnreadCount":return n.getTotalUnreadCount();case"subscribeToEvents":return n.subscribeToEvents(a);case"getConversation":return n.getConversation(a)}else"object"===e.type(t)&&n.reInit(t);else if("object"===e.type(t))if(t.userId&&t.appId&&""!==e.trim(t.userId)&&""!==e.trim(t.appId))if(void 0!==i.data("applozic_instance"))(n=i.data("applozic_instance")).reInit(t);else{if(void 0!==t.ojq?($=t.ojq,jQuery=t.ojq):($=e,jQuery=e),"function"==typeof t.obsm)$.fn.modal=t.obsm,jQuery.fn.modal=t.obsm;else if("function"==typeof e.fn.modal){r=e.fn.modal.noConflict();$.fn.modal=r,jQuery.fn.modal=r}else if("function"==typeof $.fn.modal){var r=$.fn.modal.noConflict();$.fn.modal=r,jQuery.fn.modal=r}"function"==typeof t.omckm?e.fn.mckModal=t.omckm:"function"==typeof e.fn.mckModal?e.fn.mckModal=e.fn.mckModal.noConflict():"function"==typeof $.fn.mckModal&&(e.fn.mckModal=$.fn.mckModal.noConflict()),"function"==typeof $.fn.linkify?(e.fn.linkify=$.fn.linkify,jQuery.fn.linkify=$.fn.linkify):"function"==typeof e.fn.linkify&&($.fn.linkify=e.fn.linkify,jQuery.fn.linkify=e.fn.linkify),"function"==typeof $.fn.emojiarea?e.fn.emojiarea=$.fn.emojiarea:"function"==typeof e.fn.emojiarea&&($.fn.emojiarea=e.fn.emojiarea,jQuery.fn.emojiarea=e.fn.emojiarea),"function"==typeof $.fn.locationpicker?e.fn.locationpicker=$.fn.locationpicker:"function"==typeof e.fn.locationpicker&&($.fn.locationpicker=e.fn.locationpicker,jQuery.fn.locationpicker=e.fn.locationpicker);var c=new s(t);i.data("applozic_instance",c),c.init()}else alert("Oops! looks like incorrect application id or user Id.")},e.fn.applozic.defaults=o}($applozic,window,document);
